<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SK-018 å›ç­”å•é¡Œç·´ç¿’ â€” GEPT å£èªª</title>
  <script>
    if (localStorage.getItem('loggedIn') !== 'yes') {
      window.location.href = '/login.html';
    }
  </script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¬</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #0d9488, #0f766e);
      color: white;
      text-align: center;
      padding: 30px;
    }
    .header h1 { font-size: 2rem; margin-bottom: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    .header p  { font-size: 1rem; opacity: 0.9; }

    .nav-bar {
      background: rgba(0,0,0,0.15);
      padding: 10px 30px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .nav-bar a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      transition: background 0.2s;
    }
    .nav-bar a:hover, .nav-bar a.active { background: rgba(255,255,255,0.25); color: white; }

    .main { padding: 30px; }

    .controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .controls-row label { font-weight: 600; color: #374151; }
    .controls-row select {
      padding: 8px 14px;
      border: 2px solid #d1fae5;
      border-radius: 10px;
      font-size: 0.95rem;
      color: #065f46;
      background: #f0fdf4;
      cursor: pointer;
    }

    /* Item dots */
    .item-dots { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .item-dot {
      width: 34px; height: 34px;
      border-radius: 50%;
      border: 2px solid #99f6e4;
      background: #f0fdfa;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 700;
      color: #0f766e;
      display: flex; align-items: center; justify-content: center;
    }
    .item-dot.active { background: #0d9488; color: white; border-color: #0d9488; }
    .item-dot.done   { background: #d1fae5; border-color: #6ee7b7; }
    .item-dot.roleplay { border-style: dashed; }

    /* Phase badge */
    .phase-badge {
      display: inline-block;
      padding: 6px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .phase-listening { background: #dbeafe; color: #1e3a8a; }
    .phase-recording { background: #fee2e2; color: #991b1b; }
    .phase-done      { background: #d1fae5; color: #065f46; }

    /* Audio card */
    .audio-card {
      background: #f0fdfa;
      border: 2px solid #99f6e4;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      margin-bottom: 20px;
      min-height: 130px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }
    .play-icon { font-size: 3.5rem; }
    .audio-label { font-size: 1rem; color: #0f766e; font-weight: 600; }

    /* Roleplay tag */
    .roleplay-tag {
      display: inline-block;
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      border-radius: 20px;
      padding: 4px 14px;
      font-size: 0.82rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    /* Question reveal */
    .question-reveal {
      background: #ecfdf5;
      border: 2px dashed #6ee7b7;
      border-radius: 12px;
      padding: 16px 24px;
      margin-top: 8px;
      display: none;
    }
    .question-reveal .ref-label { font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; }
    .question-reveal .ref-text  { font-size: 1.15rem; color: #134e4a; font-weight: 500; line-height: 1.6; }

    /* Countdown */
    .countdown-wrap { text-align: center; margin: 16px 0; }
    .countdown-num {
      font-size: 5rem;
      font-weight: 800;
      color: #0d9488;
      line-height: 1;
      transition: color 0.3s;
    }
    .countdown-label { font-size: 0.9rem; color: #6b7280; margin-top: 6px; }

    /* Waveform */
    .waveform-wrap { margin: 12px 0; }
    .waveform-wrap canvas {
      width: 100%;
      height: 56px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 26px;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-teal { background: #0d9488; color: white; }
    .btn-teal:hover:not(:disabled) { background: #0f766e; transform: translateY(-1px); }
    .btn-gray { background: #e5e7eb; color: #374151; }
    .btn-gray:hover:not(:disabled) { background: #d1d5db; }

    .btn-record {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: none;
      background: #ef4444;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
      animation: pulse-ring 1.2s ease-out infinite;
    }
    @keyframes pulse-ring {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      70%  { box-shadow: 0 0 0 18px rgba(239,68,68,0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }

    .action-row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; margin: 18px 0; }
    .center { justify-content: center; }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 22px; height: 22px;
      border: 3px solid #d1fae5;
      border-top-color: #0d9488;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-row { display: flex; align-items: center; gap: 10px; color: #0f766e; font-weight: 600; margin: 16px 0; }

    /* Results */
    .result-card {
      background: white;
      border: 2px solid #d1fae5;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }
    .result-card h3 { color: #065f46; font-size: 1.15rem; margin-bottom: 18px; }

    .score-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }
    .score-box {
      background: #f0fdfa;
      border: 1px solid #99f6e4;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    .score-box .val { font-size: 1.8rem; font-weight: 800; color: #0d9488; line-height: 1; }
    .score-box .lbl { font-size: 0.75rem; color: #6b7280; margin-top: 4px; }

    /* GPT feedback sections */
    .gpt-section { margin-top: 18px; }
    .gpt-section h4 { color: #0f766e; font-size: 0.95rem; font-weight: 700; margin-bottom: 8px; }
    .gpt-content {
      background: #f8fafc;
      border-radius: 10px;
      padding: 14px;
      font-size: 0.95rem;
      color: #334155;
      line-height: 1.6;
    }
    .gpt-content.highlight { background: #fffbeb; border: 1px solid #fcd34d; }

    /* Transcript */
    .transcript-box {
      background: #f1f5f9;
      border-radius: 10px;
      padding: 14px;
      font-size: 1rem;
      color: #334155;
      margin-top: 12px;
    }
    .transcript-box .label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }

    /* Model answer */
    .model-answer {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 10px;
      padding: 14px;
      margin-top: 12px;
      font-size: 0.95rem;
      color: #065f46;
      line-height: 1.6;
    }
    .model-answer .label { font-size: 0.75rem; font-weight: 700; color: #059669; text-transform: uppercase; margin-bottom: 5px; }

    .section-divider { border: none; border-top: 1px solid #e5e7eb; margin: 22px 0; }
    .hidden { display: none !important; }

    /* API key notice */
    .api-notice {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 0.85rem;
      color: #92400e;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>ğŸ’¬ å›ç­”å•é¡Œç·´ç¿’</h1>
    <p>ç¬¬ä¸‰éƒ¨åˆ† â€” å›ç­”å•é¡Œï½œGEPT åˆç´šå£èªªæ¸¬é©—</p>
    <div class="nav-bar">
      <a href="essay_grader.html">âœï¸ å¯«ä½œè©•åˆ†</a>
      <a href="speaking_part1.html">ğŸ” è¤‡èª¦ç·´ç¿’</a>
      <a href="speaking_part2.html">ğŸ“– æœ—è®€ç·´ç¿’</a>
      <a href="speaking_part3.html" class="active">ğŸ’¬ å›ç­”å•é¡Œ</a>
      <a href="speaking_mock.html">ğŸ¯ å®Œæ•´æ¨¡æ“¬</a>
    </div>
  </div>

  <div class="main">

    <!-- Set selector -->
    <div class="controls-row">
      <label>è©¦å·çµ„ï¼š</label>
      <select id="setSelect" onchange="loadSet()"></select>
      <button class="btn btn-gray" onclick="prevItem()">â† ä¸Šé¡Œ</button>
      <button class="btn btn-gray" onclick="nextItem()">ä¸‹é¡Œ â†’</button>
    </div>

    <!-- GPT API key notice -->
    <div class="api-notice" id="apiNotice">
      ğŸ’¡ æ­¤åŠŸèƒ½ä½¿ç”¨ GPT è©•ä¼°å›ç­”å…§å®¹ã€‚è«‹ç¢ºèªå¾Œç«¯å·²è¨­å®š <code>OPENAI_API_KEY</code>ã€‚
      <span style="cursor:pointer;float:right" onclick="this.parentElement.style.display='none'">âœ•</span>
    </div>

    <!-- Item dots -->
    <div class="item-dots" id="itemDots"></div>

    <!-- Phase badge -->
    <div id="phaseBadge" class="phase-badge phase-listening">ğŸ”Š æ’­æ”¾ä¸­</div>

    <!-- Roleplay tag (shown for Q7-type) -->
    <div id="roleplayTag" class="roleplay-tag hidden">ğŸ­ è§’è‰²æ‰®æ¼”é¡Œ â€” éœ€è¦å•å°æ–¹å•é¡Œ</div>

    <!-- Audio card -->
    <div class="audio-card" id="audioCard">
      <div class="play-icon" id="playIcon">ğŸ”Š</div>
      <div class="audio-label" id="audioLabel">æº–å‚™æ’­æ”¾é¡Œç›®â€¦</div>
    </div>

    <!-- Question reveal (after attempt) -->
    <div class="question-reveal" id="questionReveal">
      <div class="ref-label">é¡Œç›®åŸæ–‡</div>
      <div class="ref-text" id="refText">â€”</div>
    </div>

    <!-- Listening -->
    <div id="phaseListening">
      <div class="loading-row"><span class="spinner"></span> <span id="listenLabel">æ­£åœ¨ç”¢ç”Ÿé¡Œç›®éŸ³é »â€¦</span></div>
    </div>

    <!-- Ready (auto-starts recording, no extra click needed in real exam) -->
    <div id="phaseReady" class="hidden">
      <p style="color:#0f766e;font-weight:600;text-align:center;margin-bottom:12px">ğŸ™ï¸ æº–å‚™å¥½å³å¯é–‹å§‹å›ç­”</p>
      <div class="action-row center">
        <button class="btn btn-teal" onclick="startAnswer()">é–‹å§‹å›ç­”</button>
      </div>
    </div>

    <!-- Recording (15 s countdown) -->
    <div id="phaseRecording" class="hidden">
      <div class="countdown-wrap">
        <div class="countdown-num" id="recCountdown">15</div>
        <div class="countdown-label">ç§’å…§å®Œæˆå›ç­”</div>
      </div>
      <div class="waveform-wrap">
        <canvas id="waveformCanvas" width="840" height="56"></canvas>
      </div>
      <div class="action-row center">
        <button class="btn-record" id="btnStop" onclick="stopNow()">â¹</button>
      </div>
    </div>

    <!-- Processing -->
    <div id="phaseProcessing" class="hidden">
      <div class="loading-row"><span class="spinner"></span> è¾¨è­˜èªéŸ³ä¸­â€¦</div>
    </div>
    <div id="phaseGrading" class="hidden">
      <div class="loading-row"><span class="spinner"></span> GPT è©•ä¼°å›ç­”ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
    </div>

    <!-- Results -->
    <div id="phaseResults" class="hidden">
      <div class="result-card">
        <h3>ğŸ“Š å›ç­”åˆ†æå ±å‘Š</h3>

        <!-- Official GEPT score grid -->
        <div class="score-grid">
          <div class="score-box">
            <div class="val" id="scoreA">â€”</div>
            <div class="lbl">è©•åˆ†Aï¼šç™¼éŸ³æµåˆ©åº¦ (0â€“5)</div>
          </div>
          <div class="score-box">
            <div class="val" id="scoreB">â€”</div>
            <div class="lbl">è©•åˆ†Bï¼šæ–‡æ³•å­—å½™ (0â€“5)</div>
          </div>
          <div class="score-box" style="border-color:#0d9488">
            <div class="val" id="scoreTotal" style="color:#0f766e">â€”</div>
            <div class="lbl">ç¸½åˆ† (A+B)Ã—10</div>
          </div>
          <div class="score-box">
            <div class="val" id="scoreWords">â€”</div>
            <div class="lbl">å­—æ•¸ï¼ˆç›®æ¨™ 20â€“50ï¼‰</div>
          </div>
        </div>
        <p style="font-size:0.78rem;color:#9ca3af;margin-bottom:16px">
          â€» å®˜æ–¹è¨ˆåˆ†ï¼š(è©•åˆ†A + è©•åˆ†B) Ã— 10 = ç™¾åˆ†åˆ¶ç¸½åˆ†
        </p>

        <!-- Student transcript -->
        <div class="transcript-box">
          <div class="label">ä½ çš„å›ç­”ï¼ˆWhisper è¾¨è­˜ï¼‰</div>
          <div id="transcriptText">â€”</div>
        </div>

        <!-- Score A feedback -->
        <div class="gpt-section">
          <h4>ğŸ™ï¸ è©•åˆ†A â€” ç™¼éŸ³ã€èªèª¿ã€æµåˆ©åº¦</h4>
          <div class="gpt-content" id="feedbackA">â€”</div>
        </div>

        <!-- Score B feedback -->
        <div class="gpt-section">
          <h4>ğŸ“ è©•åˆ†B â€” æ–‡æ³•ã€å­—å½™æ­£ç¢ºæ€§</h4>
          <div class="gpt-content" id="feedbackB">â€”</div>
        </div>

        <!-- Coaching -->
        <div class="gpt-section">
          <h4>ğŸ’¡ æ”¹é€²å»ºè­°</h4>
          <div class="gpt-content highlight" id="coachingText">â€”</div>
        </div>

        <!-- Overall -->
        <div class="gpt-section">
          <h4>ğŸ† æ•´é«”è©•èª</h4>
          <div class="gpt-content" id="overallText">â€”</div>
        </div>

        <!-- Model answer -->
        <div class="model-answer" id="modelAnswerWrap">
          <div class="label">åƒè€ƒç­”æ¡ˆ</div>
          <div id="modelAnswerText">â€”</div>
        </div>
      </div>

      <hr class="section-divider">
      <div class="action-row">
        <button class="btn btn-teal" onclick="replayAndRetry()">ğŸ”Š é‡è½ + å†è©¦</button>
        <button class="btn btn-gray" onclick="nextItem()">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
    </div>

  </div>
</div>

<script src="speaking-utils.js"></script>
<script>
const BANK_URL = 'https://kniph.github.io/question-bank.json';
const BACKEND  = SpeakingUtils.BACKEND;
let bank = null;
let currentSet = null;
let currentItems = [];
let currentIdx = 0;
let recStopFn = null;
let recordingPromise = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const resp = await fetch(BANK_URL);
    bank = await resp.json();
    populateSetSelect();
    loadSet();
  } catch (e) {
    document.getElementById('audioLabel').textContent = 'âš ï¸ ç„¡æ³•è¼‰å…¥é¡Œåº«ï¼š' + e.message;
  }
}

function populateSetSelect() {
  const sel = document.getElementById('setSelect');
  sel.innerHTML = '';
  bank.sets.forEach(s => {
    const has = s.part3 && s.part3.length > 0;
    const opt = document.createElement('option');
    opt.value = s.set_id;
    opt.textContent = s.set_name + (has ? '' : ' (å°šæœªæ”¶éŒ„)');
    opt.disabled = !has;
    sel.appendChild(opt);
  });
  const first = bank.sets.find(s => s.part3 && s.part3.length > 0);
  if (first) sel.value = first.set_id;
}

function loadSet() {
  const setId = document.getElementById('setSelect').value;
  currentSet = bank.sets.find(s => s.set_id === setId);
  currentItems = currentSet ? currentSet.part3 : [];
  currentIdx = 0;
  renderDots();
  loadItem();
}

function renderDots() {
  const container = document.getElementById('itemDots');
  container.innerHTML = '';
  currentItems.forEach((item, i) => {
    const d = document.createElement('div');
    d.className = 'item-dot'
      + (item.is_roleplay ? ' roleplay' : '')
      + (i === currentIdx ? ' active' : '');
    d.textContent = i + 1;
    d.title = item.is_roleplay ? 'è§’è‰²æ‰®æ¼”é¡Œ' : item.type;
    d.onclick = () => { currentIdx = i; loadItem(); };
    container.appendChild(d);
  });
}

// â”€â”€ Load item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadItem() {
  resetUI();
  renderDots();

  const item = currentItems[currentIdx];
  if (!item) {
    document.getElementById('audioLabel').textContent = 'æ­¤çµ„æš«ç„¡é¡Œç›®';
    return;
  }

  // Roleplay tag
  if (item.is_roleplay) {
    show('roleplayTag');
  } else {
    hide('roleplayTag');
  }

  setBadge('listening');
  document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” æ’­æ”¾ä¸­ (ç¬¬ 1 é)`;
  document.getElementById('playIcon').textContent = 'ğŸ”Š';
  show('phaseListening');

  try {
    await SpeakingUtils.playTTS(item.question, 'nova', 1);
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” é–“éš”ä¸­â€¦`;
    await new Promise(r => setTimeout(r, 1500));
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” æ’­æ”¾ä¸­ (ç¬¬ 2 é)`;
    await SpeakingUtils.playTTS(item.question, 'nova', 1);

    hide('phaseListening');
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” è«‹ç«‹å³å›ç­”`;
    document.getElementById('playIcon').textContent = 'ğŸ’¬';
    show('phaseReady');
    setBadge('ready');

  } catch (err) {
    hide('phaseListening');
    document.getElementById('audioLabel').textContent = 'âš ï¸ TTS å¤±æ•—ï¼š' + err.message;
  }
}

// â”€â”€ Recording â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startAnswer() {
  hide('phaseReady');
  show('phaseRecording');
  setBadge('recording');

  const canvas = document.getElementById('waveformCanvas');
  recordingPromise = SpeakingUtils.startRecording(15, canvas);

  const countdown = document.getElementById('recCountdown');
  recStopFn = SpeakingUtils.startCountdown(countdown, 15, () => stopNow());
}

async function stopNow() {
  if (recStopFn) { recStopFn(); recStopFn = null; }
  SpeakingUtils.stopRecording();
  hide('phaseRecording');
  show('phaseProcessing');

  try {
    const { base64 } = await recordingPromise;
    const item = currentItems[currentIdx];

    // Step 1: Whisper
    const { text } = await SpeakingUtils.transcribe(base64, '');
    hide('phaseProcessing');
    show('phaseGrading');

    // Step 2: GPT evaluation
    const evaluation = await evaluateWithGPT(item, text);

    hide('phaseGrading');
    showResults(text, item, evaluation);

  } catch (err) {
    hide('phaseProcessing');
    hide('phaseGrading');
    alert('è™•ç†å¤±æ•—ï¼š' + err.message);
    resetUI();
    loadItem();
  }
}

// â”€â”€ GPT Evaluation (official rubric via /api/evaluate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function evaluateWithGPT(item, transcript) {
  try {
    const resp = await fetch(`${BACKEND}/api/evaluate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        part: 3,
        transcript: transcript || '',
        question: item.question,
        is_roleplay: item.is_roleplay || false
      })
    });
    if (!resp.ok) throw new Error(`è©•åˆ†å¤±æ•—: ${resp.status}`);
    return await resp.json();
  } catch (e) {
    console.warn('Evaluate error:', e);
    return {
      score_a: null, score_b: null, total: null,
      feedback_a: 'ï¼ˆè©•ä¼°æš«æ™‚ä¸å¯ç”¨ï¼‰',
      feedback_b: 'ï¼ˆè©•ä¼°æš«æ™‚ä¸å¯ç”¨ï¼‰',
      coaching: 'è«‹ç¢ºèª Railway backend å·²å•Ÿå‹•ä¸” OPENAI_API_KEY å·²è¨­å®šã€‚',
      overall: 'â€”'
    };
  }
}

// â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResults(transcript, item, evaluation) {
  show('phaseResults');
  setBadge('done');

  // Reveal question
  document.getElementById('questionReveal').style.display = 'block';
  document.getElementById('refText').textContent = item.question;

  // Word count
  const wordCount = (transcript || '').split(/\s+/).filter(w => w.length > 0).length;

  // Official scores
  const scoreA = evaluation.score_a;
  const scoreB = evaluation.score_b;
  const total  = evaluation.total;

  document.getElementById('scoreA').textContent = scoreA !== null ? scoreA : 'â€”';
  document.getElementById('scoreB').textContent = scoreB !== null ? scoreB : 'â€”';
  document.getElementById('scoreTotal').textContent = total !== null ? total : 'â€”';
  document.getElementById('scoreWords').textContent = wordCount;

  // Color total by band
  const totalEl = document.getElementById('scoreTotal');
  if (total >= 80)      totalEl.style.color = '#10b981';
  else if (total >= 60) totalEl.style.color = '#f59e0b';
  else                  totalEl.style.color = '#ef4444';

  // Word count color
  const wcEl = document.getElementById('scoreWords');
  if (wordCount < 10)       wcEl.style.color = '#ef4444';
  else if (wordCount < 20)  wcEl.style.color = '#f59e0b';
  else if (wordCount <= 50) wcEl.style.color = '#10b981';
  else                      wcEl.style.color = '#f59e0b';

  // Transcript
  document.getElementById('transcriptText').textContent = transcript || 'ï¼ˆæœªè¾¨è­˜åˆ°èªéŸ³ï¼‰';

  // Rubric feedback
  document.getElementById('feedbackA').textContent = evaluation.feedback_a || 'â€”';
  document.getElementById('feedbackB').textContent = evaluation.feedback_b || 'â€”';
  document.getElementById('coachingText').textContent = evaluation.coaching || 'â€”';
  document.getElementById('overallText').textContent = evaluation.overall || 'â€”';

  // Model answer
  document.getElementById('modelAnswerText').textContent = item.model_answer || 'ï¼ˆæš«ç„¡åƒè€ƒç­”æ¡ˆï¼‰';

  // Mark dot done
  const dots = document.querySelectorAll('.item-dot');
  if (dots[currentIdx]) dots[currentIdx].classList.add('done');
}

// â”€â”€ Navigation & helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function replayAndRetry() {
  document.getElementById('questionReveal').style.display = 'none';
  resetUI();
  await loadItem();
}

function prevItem() { if (currentIdx > 0) { currentIdx--; loadItem(); } }
function nextItem() { if (currentIdx < currentItems.length - 1) { currentIdx++; loadItem(); } }

function resetUI() {
  if (recStopFn) { recStopFn(); recStopFn = null; }
  SpeakingUtils.stopRecording();
  document.getElementById('questionReveal').style.display = 'none';
  hide('phaseListening');
  hide('phaseReady');
  hide('phaseRecording');
  hide('phaseProcessing');
  hide('phaseGrading');
  hide('phaseResults');
  hide('roleplayTag');
  document.getElementById('playIcon').textContent = 'ğŸ”Š';
  document.getElementById('audioLabel').textContent = 'æº–å‚™æ’­æ”¾â€¦';
}

function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }

function setBadge(phase) {
  const el = document.getElementById('phaseBadge');
  const map = {
    listening: ['phase-listening', 'ğŸ”Š æ’­æ”¾ä¸­'],
    ready:     ['phase-listening', 'ğŸ’¬ æº–å‚™å›ç­”'],
    recording: ['phase-recording', 'ğŸ”´ éŒ„éŸ³ä¸­ï¼ˆ15ç§’ï¼‰'],
    done:      ['phase-done',      'âœ… åˆ†æå®Œæˆ']
  };
  el.className = 'phase-badge ' + map[phase][0];
  el.textContent = map[phase][1];
}

init();
</script>
</body>
</html>
