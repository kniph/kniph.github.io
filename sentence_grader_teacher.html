<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEPT å¥å­è©•åˆ† - æ•™å¸«æ¨¡å¼</title>
    <script>
    if (localStorage.getItem('loggedIn') !== 'yes') {
        window.location.href = '/login.html';
    }
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœï¸</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            text-align: center;
            padding: 25px;
        }

        .header h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .header p { font-size: 0.95rem; opacity: 0.9; }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .header { position: relative; }

        .main-content { padding: 30px; }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        .mode-btn {
            padding: 12px 30px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border-color: #4f46e5;
        }

        .mode-btn:hover:not(.active) {
            border-color: #4f46e5;
            color: #4f46e5;
        }

        /* Selector Section */
        .selector-section {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .selector-section h3 {
            color: #92400e;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }

        .selector-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .selector-row label {
            font-weight: 600;
            color: #78350f;
        }

        .selector-row select {
            padding: 10px 20px;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            background: white;
            font-size: 1rem;
            min-width: 200px;
            cursor: pointer;
        }

        /* Questions Display */
        .questions-container {
            display: none;
        }

        .question-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .question-num {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
        }

        .question-type {
            background: #ddd6fe;
            color: #5b21b6;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .question-content {
            margin-bottom: 12px;
        }

        .question-original {
            color: #374151;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .question-prompt {
            color: #1e293b;
            font-weight: 500;
            background: #fef3c7;
            padding: 10px 14px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .given-words {
            color: #059669;
            font-style: italic;
            margin-top: 8px;
            font-size: 0.95rem;
        }

        .answer-input-wrapper {
            margin-top: 12px;
        }

        .answer-input-wrapper label {
            display: block;
            font-weight: 600;
            color: #065f46;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .answer-input-wrapper input {
            width: 100%;
            padding: 12px;
            border: 2px solid #10b981;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background: linear-gradient(135deg, #ecfdf5, #ffffff);
        }

        .answer-input-wrapper input,
        .batch-input-section textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        .answer-input-wrapper input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Batch Mode */
        .batch-input-section {
            display: none;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border: 2px solid #10b981;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .batch-input-section h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .batch-input-section textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #10b981;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .batch-hint {
            color: #065f46;
            font-size: 0.85rem;
            margin-top: 10px;
            line-height: 1.5;
        }

        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 35px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 15px;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results */
        .results {
            display: none;
            margin-top: 25px;
        }

        .results h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.4rem;
            text-align: center;
        }

        .result-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .question-title {
            font-weight: 600;
            color: #374151;
        }

        .score-badge {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .score-2 { background: #d1fae5; color: #059669; }
        .score-1 { background: #fef3c7; color: #d97706; }
        .score-0 { background: #fee2e2; color: #dc2626; }

        .result-answer {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-family: monospace;
        }

        .result-feedback {
            color: #374151;
            line-height: 1.6;
        }

        .feedback-label {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .grammar-errors {
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .minor-errors {
            background: #fefce8;
            border-left: 3px solid #eab308;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        /* Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid;
        }

        .stat-card.green { background: #ecfdf5; border-color: #10b981; }
        .stat-card.yellow { background: #fefce8; border-color: #eab308; }
        .stat-card.red { background: #fef2f2; border-color: #ef4444; }
        .stat-card.blue { background: #eff6ff; border-color: #3b82f6; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.95rem;
            margin-top: 5px;
        }

        .stat-card.green .stat-number { color: #059669; }
        .stat-card.yellow .stat-number { color: #ca8a04; }
        .stat-card.red .stat-number { color: #dc2626; }
        .stat-card.blue .stat-number { color: #2563eb; }

        @media (max-width: 600px) {
            .main-content { padding: 20px; }
            .header h1 { font-size: 1.4rem; }
            .mode-btn { padding: 10px 20px; font-size: 0.9rem; }
            .selector-row { flex-direction: column; }
            .selector-row select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="sentence_grader.html" class="back-btn">â† è¿”å›</a>
            <h1>âœï¸ GEPT å¥å­å¯«ä½œè©•åˆ†</h1>
            <p id="headerSubtitle">æ•™å¸«æ‰¹æ”¹æ¨¡å¼ | AI: Claude Sonnet 4.5</p>
        </div>

        <div class="main-content">
            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('single')" id="singleModeBtn">å–®äººæ¨¡å¼</button>
                <button class="mode-btn" onclick="setMode('batch')" id="batchModeBtn">æ‰¹æ¬¡æ¨¡å¼</button>
            </div>

            <!-- Test & Model Selector -->
            <div class="selector-section">
                <h3>ğŸ“‹ é¸æ“‡é¡Œçµ„èˆ‡AIæ¨¡å‹</h3>
                <div class="selector-row">
                    <label for="testSelect">é¡Œçµ„ï¼š</label>
                    <select id="testSelect" onchange="loadQuestions()">
                        <option value="">-- è«‹é¸æ“‡é¡Œçµ„ --</option>
                        <option value="A-1">A-1 AMC æ¨¡æ“¬è©¦é¡Œ 1</option>
                        <option value="A-2">A-2 AMC æ¨¡æ“¬è©¦é¡Œ 2</option>
                        <option value="A-3">A-3 AMC æ¨¡æ“¬è©¦é¡Œ 3</option>
                        <option value="A-4">A-4 AMC æ¨¡æ“¬è©¦é¡Œ 4</option>
                        <option value="A-5">A-5 AMC æ¨¡æ“¬è©¦é¡Œ 5</option>
                        <option value="A-6">A-6 AMC æ¨¡æ“¬è©¦é¡Œ 6</option>
                        <option value="A-7">A-7 AMC æ¨¡æ“¬è©¦é¡Œ 7</option>
                        <option value="A-8">A-8 AMC æ¨¡æ“¬è©¦é¡Œ 8</option>
                        <option value="G-1">G-1 GEPT å®˜æ–¹ç¯„ä¾‹</option>
                        <option value="AI">ğŸ¤– AI ç”Ÿæˆé¡Œç›®</option>
                    </select>

                    <label for="modelSelect">AI æ¨¡å‹ï¼š</label>
                    <select id="modelSelect" onchange="updateModelDisplay()">
                        <option value="claude-sonnet-4.5">Claude Sonnet 4.5</option>
                        <option value="gpt-5.2">GPT 5.2</option>
                    </select>
                </div>
            </div>

            <!-- Single Person Mode - 15 Questions -->
            <div class="questions-container" id="questionsContainer">
                <!-- Questions will be dynamically loaded here -->
            </div>

            <!-- Batch Mode Input -->
            <div class="batch-input-section" id="batchInputSection">
                <h3>âœï¸ æ‰¹æ¬¡è¼¸å…¥ (æ¯ä½å­¸ç”Ÿ15é¡Œç­”æ¡ˆ)</h3>
                <textarea id="batchInput" placeholder="æ ¼å¼ç¯„ä¾‹ï¼š
å­¸ç”Ÿå§“å
ç­”æ¡ˆ1
ç­”æ¡ˆ2
ç­”æ¡ˆ3
...
ç­”æ¡ˆ15

ä¸‹ä¸€ä½å­¸ç”Ÿå§“å
ç­”æ¡ˆ1
ç­”æ¡ˆ2
..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                <div class="batch-hint">
                    ğŸ’¡ æ‰¹æ¬¡æ¨¡å¼èªªæ˜ï¼š<br>
                    - æ¯ä½å­¸ç”Ÿå…ˆè¼¸å…¥å§“åï¼Œæ¥ä¸‹ä¾†15è¡Œç‚º15é¡Œç­”æ¡ˆï¼ˆä¾åºå°æ‡‰ç¬¬1-15é¡Œï¼‰<br>
                    - ç©ºä¸€è¡Œå¾Œå¯è¼¸å…¥ä¸‹ä¸€ä½å­¸ç”Ÿ<br>
                    - ç³»çµ±æœƒè‡ªå‹•æ‰¹æ”¹æ‰€æœ‰å­¸ç”Ÿçš„æ‰€æœ‰é¡Œç›®
                </div>
            </div>

            <!-- Grade Button (Center-aligned) -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="gradeAnswers()" id="gradeBtn">
                    ğŸ¯ é–‹å§‹è©•åˆ†
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3 style="color: #4f46e5; margin-bottom: 15px;"><strong>AI æ­£åœ¨è©•åˆ†ä¸­...</strong></h3>

                <!-- Progress Bar -->
                <div style="background: #e5e7eb; border-radius: 10px; height: 8px; margin: 20px auto; max-width: 400px; overflow: hidden;">
                    <div id="gradingProgressBar" style="background: linear-gradient(45deg, #4f46e5, #7c3aed); height: 100%; width: 0%; transition: width 0.5s;"></div>
                </div>

                <p id="loadingProgress" style="color: #6b7280; font-weight: 600; margin-bottom: 10px;">è«‹ç¨å€™</p>
                <p id="gradingTimeEstimate" style="color: #9ca3af; font-size: 0.9rem;"></p>

                <!-- Grading Tip -->
                <div id="gradingTipBox" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-top: 25px; max-width: 500px; margin-left: auto; margin-right: auto; display: none;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">ğŸ’¡ è©•åˆ†å°çŸ¥è­˜</div>
                    <div id="gradingTip" style="color: #78350f; line-height: 1.6; font-size: 0.95rem;"></div>
                </div>
            </div>

            <!-- Results -->
            <div class="results" id="results">
                <h2>ğŸ“Š è©•åˆ†çµæœ</h2>
                <div class="summary-stats" id="summaryStats"></div>
                <div id="resultsList"></div>
            </div>

            <!-- Bottom Action Buttons (After Results) -->
            <div class="action-buttons" id="bottomButtons" style="display:none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="exportResults()" id="exportBtn">
                    ğŸ“„ ç”¢ç”Ÿå ±å‘Š
                </button>
                <button class="btn" onclick="startFresh()" id="startFreshBtn" style="background:linear-gradient(45deg,#8b5cf6,#a78bfa);color:white;">
                    ğŸ”„ <span id="startFreshText">é‡æ–°é–‹å§‹</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://railway-backend-production-55cf.up.railway.app';

        let currentMode = 'single';
        let currentTest = null;
        let currentQuestions = [];
        let gradingResults = [];
        let selectedModel = 'claude-sonnet-4.5';
        let startTime = null;
        let elapsedSeconds = 0;

        // Question Bank
        const questionBank = {
            'A-1': [
                {
                    num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'How many question',
                    original: 'There are eight students in the classroom.',
                    prompt: 'How many ___?',
                    correct_answers: ['How many students are there in the classroom?']
                },
                {
                    num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'give + double object',
                    original: 'Grandma gave her neighbor some fruit.',
                    prompt: 'Grandma ___ her neighbor.',
                    correct_answers: ['Grandma gave some fruit to her neighbor.']
                },
                {
                    num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'past tense',
                    original: 'Mom goes to the market every morning.',
                    prompt: 'Mom ___ yesterday morning.',
                    correct_answers: ['Mom went to the market yesterday morning.']
                },
                {
                    num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'tag question',
                    original: 'You went to a university in the UK.',
                    prompt: 'You went to a university in the UK, ___?',
                    correct_answers: ['You went to a university in the UK, didn\'t you?']
                },
                {
                    num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'too...to vs enough...to',
                    original: 'James is too short to reach the top shelf.',
                    prompt: 'James ___ the top shelf.',
                    correct_answers: ['James is not tall enough to reach the top shelf.']
                },
                {
                    num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'not only...but also',
                    original: ['Janice speaks French.', 'She speaks Japanese, too.'],
                    prompt: 'Janice speaks ___.',
                    correct_answers: ['Janice speaks not only French but also Japanese.']
                },
                {
                    num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'relative clause with who',
                    original: ['The thief stole a ring from the jewelry store.', 'He was arrested by the police.'],
                    prompt: 'The thief ___ by the police.',
                    correct_answers: ['The thief who stole a ring from the jewelry store was arrested by the police.']
                },
                {
                    num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'embedded question',
                    original: ['Do you like the gift?', 'Let me know.'],
                    prompt: 'Let me know ___.',
                    correct_answers: ['Let me know whether (or not) you like the gift.', 'Let me know whether you like the gift (or not).', 'Let me know if you like the gift (or not).', 'Let me know whether you like the gift.', 'Let me know if you like the gift.']
                },
                {
                    num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'so...that',
                    original: ['Martha was very nervous about her exam.', 'She couldn\'t eat anything.'],
                    prompt: 'Martha ___ anything.',
                    correct_answers: ['Martha was so nervous about her exam that she couldn\'t eat anything.']
                },
                {
                    num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'prepositional phrase with in',
                    original: ['The man is our manager.', 'He\'s wearing a hat.'],
                    prompt: 'The man ___.',
                    correct_answers: ['The man in a hat is our manager.']
                },
                {
                    num: 11, type: 'é‡çµ„', target_grammar: 'because clause',
                    prompt: 'Morrison got fired ___.',
                    given_words: ['work', 'he', 'enough', 'because', 'hard', 'didn\'t'],
                    correct_answers: ['Morrison got fired because he didn\'t work hard enough.']
                },
                {
                    num: 12, type: 'é‡çµ„', target_grammar: 'relative clause',
                    prompt: 'Sally is eating ___.',
                    given_words: ['in the yard', 'the vegetables', 'grew', 'she'],
                    correct_answers: ['Sally is eating the vegetables she grew in the yard.']
                },
                {
                    num: 13, type: 'é‡çµ„', target_grammar: 'Would you like + to V',
                    prompt: 'Would you ___?',
                    given_words: ['you', 'the house', 'like', 'to show', 'me', 'around'],
                    correct_answers: ['Would you like me to show you around the house?']
                },
                {
                    num: 14, type: 'é‡çµ„', target_grammar: 'It is + noun phrase',
                    prompt: 'It is ___.',
                    given_words: ['to', 'responsibility', 'the plan', 'stick to', 'your'],
                    correct_answers: ['It is your responsibility to stick to the plan.']
                },
                {
                    num: 15, type: 'é‡çµ„', target_grammar: 'spend + time + V-ing',
                    prompt: 'The writer ___ for her book.',
                    given_words: ['creating', 'spent', 'new characters', 'day', 'the whole'],
                    correct_answers: ['The writer spent the whole day creating new characters for her book.']
                }
            ],
            'G-1': [
                {
                    num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'tense change (past â†’ future)',
                    original: 'David got up early yesterday.',
                    prompt: 'David ___ early tomorrow.',
                    correct_answers: ['David will get up early tomorrow.', 'David is going to get up early tomorrow.', 'David is getting up early tomorrow.']
                },
                {
                    num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'statement to question',
                    original: 'Mom is writing her name on the paper.',
                    prompt: 'What ___ on the paper?',
                    correct_answers: ['What is Mom writing on the paper?']
                },
                {
                    num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'comparative transformation',
                    original: 'Turtles do not swim as fast as dolphins.',
                    prompt: 'Dolphins ___ than turtles.',
                    correct_answers: ['Dolphins swim faster than turtles.', 'Dolphins swim more quickly than turtles.']
                },
                {
                    num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'keep + V-ing',
                    original: 'Jack complains about the weather all the time.',
                    prompt: 'Jack keeps ___ the weather.',
                    correct_answers: ['Jack keeps complaining about the weather.']
                },
                {
                    num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'passive to active',
                    original: 'The wall was painted blue by my sister.',
                    prompt: 'My sister ___ the wall blue.',
                    correct_answers: ['My sister painted the wall blue.']
                },
                {
                    num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'embedded question',
                    original: ['When should I finish the history report?', 'Please tell me.'],
                    prompt: 'Please tell me when ___ the history report.',
                    correct_answers: ['Please tell me when I should finish the history report.']
                },
                {
                    num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'time sequence with after',
                    original: ['Lisa walked into her office.', 'Then she sat down at her desk.'],
                    prompt: 'Lisa ___ after she ___.',
                    correct_answers: ['Lisa sat down at her desk after she walked into her office.']
                },
                {
                    num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'both...and',
                    original: ['Eric is practicing the magic trick.', 'Grace is practicing the magic trick.'],
                    prompt: 'Both ___ practicing the magic trick.',
                    correct_answers: ['Both Eric and Grace are practicing the magic trick.', 'Both of them are practicing the magic trick.']
                },
                {
                    num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'although concession',
                    original: ['It was raining.', 'The students had a picnic at the beach.'],
                    prompt: 'Although ___, ___.',
                    correct_answers: ['Although it was raining, the students had a picnic at the beach.']
                },
                {
                    num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'It takes + time + to V',
                    original: ['Tim fixed his bike.', 'It took him two hours.'],
                    prompt: 'It took Tim ___ his bike.',
                    correct_answers: ['It took Tim two hours to fix his bike.']
                },
                {
                    num: 11, type: 'é‡çµ„', target_grammar: 'present perfect + never',
                    prompt: 'I have ___ before.',
                    given_words: ['so much', 'had', 'homework', 'never'],
                    correct_answers: ['I have never had so much homework before.']
                },
                {
                    num: 12, type: 'é‡çµ„', target_grammar: 'exclamatory sentence',
                    prompt: 'What a ___!',
                    given_words: ['polite', 'Jim', 'is', 'boy'],
                    correct_answers: ['What a polite boy Jim is!']
                },
                {
                    num: 13, type: 'é‡çµ„', target_grammar: 'be famous for',
                    prompt: 'This park ___ beautiful roses.',
                    given_words: ['famous', 'is', 'its', 'for'],
                    correct_answers: ['This park is famous for its beautiful roses.']
                },
                {
                    num: 14, type: 'é‡çµ„', target_grammar: 'one of + plural',
                    prompt: 'Only ___ likes this novel.',
                    given_words: ['of', 'classmates', 'my', 'one'],
                    correct_answers: ['Only one of my classmates likes this novel.']
                },
                {
                    num: 15, type: 'é‡çµ„', target_grammar: 'had better',
                    prompt: 'They ___ for the big test.',
                    given_words: ['better', 'get', 'had', 'ready'],
                    correct_answers: ['They had better get ready for the big test.']
                }
            ]
        };

        // AMC-2 Questions
        questionBank['A-2'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'It is unhealthy to V', original: 'Eating too much fried food is unhealthy.', prompt: '___ too much fried food.', correct_answers: ['It is unhealthy to eat too much fried food'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'Wh- é–“æ¥å•å¥', original: 'Why are you interested in this job?', prompt: 'Tell me ___.', correct_answers: ['why you are interested in this job'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'not as... as...', original: "This writer's new book is better than his first one.", prompt: "This writer's first book ___ his new one.", correct_answers: ['is not as good as his new one'] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'so é€£æ¥è©', original: 'Everyone expected Mason to win because he was the best player.', prompt: '___, so ___.', correct_answers: ['Mason was the best player, so everyone expected him to win'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'have + O + V', original: 'Mrs. Jones asked her assistant to check the numbers.', prompt: 'Mrs. Jones had ___ the numbers.', correct_answers: ['her assistant check the numbers'] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'neither... nor...', original: ["Frankie couldn't attend the meeting.", "Paul couldn't attend the meeting, either."], prompt: 'Neither ___ the meeting.', correct_answers: ['Frankie nor Paul could attend the meeting'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'too... to...', original: ["It's very late.", "We shouldn't go out."], prompt: "It's ___.", correct_answers: ['too late for us to go out'] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'One of + è¤‡æ•¸åè©', original: ['There are some books in the bookcase.', 'One book has a green cover.'], prompt: 'One of ___ a green cover.', correct_answers: ['the books in the bookcase has a green cover'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'é—œä¿‚ä»£åè© (å—æ ¼)', original: ['Selena wrote a letter.', 'The letter was for her cousin.'], prompt: 'Selena ___ a letter.', correct_answers: ['wrote her cousin a letter', 'wrote a letter to her cousin'] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'æ„Ÿå®˜å‹•è© + O + V-ing', original: ['I saw a cat.', 'It was chasing after a toy mouse.'], prompt: 'I saw ___ a toy mouse.', correct_answers: ['a cat chasing after a toy mouse'] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'without + V-ing', prompt: 'Jason ___.', given_words: ['saying', 'left', 'goodbye', 'without'], correct_answers: ['left without saying goodbye'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'be surprised to V', prompt: 'Everyone was ___.', given_words: ['to see', 'surprised', 'up', 'Bill', 'show'], correct_answers: ['surprised to see Bill show up'] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'é—œä¿‚ä»£åè© that', prompt: 'I am reading the book ___.', given_words: ['from', 'that', 'borrowed', 'Henry', 'I'], correct_answers: ['that I borrowed from Henry'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'Wh- ç–‘å•å¥', prompt: 'Where ___?', given_words: ['this', 'you', 'did', 'hear', 'funny custom', 'about'], correct_answers: ['did you hear about this funny custom'] },
            { num: 15, type: 'é‡çµ„', target_grammar: "feel like + V-ing", prompt: 'Danny ___.', given_words: ['to anyone', 'like', "doesn't", 'talking', 'feel', 'right now'], correct_answers: ["doesn't feel like talking to anyone right now"] }
        ];

        // AMC-3 Questions
        questionBank['A-3'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'When + åŠ©å‹•è© + S + V', original: 'The mailman delivered the package to Kenneth this morning.', prompt: 'When ___ to Kenneth?', correct_answers: ['did the mailman deliver the package to Kenneth'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'æ™‚æ…‹è½‰æ› (æœªä¾†å¼æ”¹éå»å¼)', original: 'Barry will bring some books to his classmate tomorrow.', prompt: 'Barry ___ his classmate yesterday.', correct_answers: ['brought some books to his classmate yesterday'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'è¢«å‹•èªæ…‹', original: 'Our company has hired several experts.', prompt: '___ our company.', correct_answers: ['Several experts have been hired by our company'] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'cost', original: 'Tracy paid NT$3,000 for the basketball game tickets.', prompt: '___ NT$3,000.', correct_answers: ['The basketball game tickets cost Tracy NT$3,000'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'å¦å®šå¥ have anything', original: 'I have nothing to eat tonight.', prompt: "I don't ___ to eat tonight.", correct_answers: ["have anything to eat tonight"] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'by + äº¤é€šå·¥å…·', original: ['Peter goes to work every day.', 'He takes the train to get there.'], prompt: 'Peter goes ___.', correct_answers: ['to work by train every day'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'before', original: ['Andrew read a lot of travel guides.', 'Then, he planned his trip to New York.'], prompt: '___.', correct_answers: ['Andrew read a lot of travel guides before he planned his trip to New York'] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'æ¯”è¼ƒç´š + than', original: ['Grace is 160 cm tall.', 'Oliver is 175 cm tall.'], prompt: 'Oliver ___ Grace.', correct_answers: ['is (15 cm) taller than Grace', 'is taller than Grace'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'é—œä¿‚ä»£åè© which/that', original: ['The movie will be out next week.', 'Everyone is looking forward to it.'], prompt: 'The movie ___ will be out next week.', correct_answers: ['(that/which) everyone is looking forward to will be out next week', 'everyone is looking forward to will be out next week'] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'neither... and...', original: ["Your brother shouldn't lie to your parents.", "You shouldn't lie to your parents, either."], prompt: "Your brother shouldn't lie to your parents, and ___ you.", correct_answers: ['neither should you'] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'Wh- ç–‘å•å¥', prompt: "I'm not sure ___.", given_words: ['got', 'the show', 'why', 'canceled'], correct_answers: ['why the show got canceled'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'not only... but also...', prompt: 'Michelle plays ___ volleyball.', given_words: ['also', 'tennis', 'but', 'only', 'not'], correct_answers: ['not only tennis but also volleyball'] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'too... to...', prompt: 'This puzzle is ___.', given_words: ['by', 'too', 'one person', 'to', 'difficult', 'be finished'], correct_answers: ['too difficult to be finished by one person'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'It is + adj. + to V', prompt: 'It is ___.', given_words: ['stay', 'during', 'safer', 'home', 'a typhoon', 'to'], correct_answers: ['safer to stay home during a typhoon'] },
            { num: 15, type: 'é‡çµ„', target_grammar: 'give + äºº + ç‰©', prompt: 'Vivian ___.', given_words: ['long', 'dress', 'me', 'beautiful', 'gave', 'white', 'a'], correct_answers: ['gave me a beautiful long white dress'] }
        ];

        // AMC-4 Questions
        questionBank['A-4'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'æ‰€æœ‰æ ¼ä»£åè©', original: 'Those are our dogs.', prompt: 'Those dogs ___.', correct_answers: ['are ours'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'Wh- ç–‘å•å¥', original: 'Who did you see at the party?', prompt: 'Can you tell me ___?', correct_answers: ['who you saw at the party'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'too... to... / because', original: "Carl was too busy to notice his wife wasn't happy.", prompt: "Carl didn't ___ because ___.", correct_answers: ["notice his wife wasn't happy because he was too busy"] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'so', original: 'Molly likes dancing, and Sophia does, too.', prompt: 'Molly ___ Sophia.', correct_answers: ['likes dancing, and so does Sophia'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'ç¾åœ¨å®Œæˆå¼', original: 'Joe started working on this project two weeks ago.', prompt: 'Joe ___ for two weeks.', correct_answers: ['has been working on this project for two weeks'] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'although', original: ['It was raining heavily.', 'Many people still stayed to watch the baseball game.'], prompt: '___ although ___.', correct_answers: ['Many people still stayed to watch the baseball game although it was raining heavily'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'buy + äºº + ç‰©', original: ['Jessica wanted a bicycle.', 'Her mother bought her one.'], prompt: "Jessica's mother ___her.", correct_answers: ['bought a bicycle for her', 'bought her a bicycle'] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'but', original: ['Ken felt very tired.', 'He still helped his grandma clean the house.'], prompt: '___.', correct_answers: ['Ken felt very tired but he still helped his grandma clean the house'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'so... that...', original: ['Trent is afraid of the dark.', "He can't sleep without lights on."], prompt: 'Trent ___.', correct_answers: ["is so afraid of the dark that he can't sleep without lights on"] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'adj./adv. + enough + to V', original: ['Janet is 20 years old.', 'She can vote in the election.'], prompt: 'Janet ___ in the election.', correct_answers: ['is old enough to vote in the election'] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'æ™‚é–“å‰¯è©å­å¥', prompt: 'All ___ they turned 30.', given_words: ['got', 'my', 'before', 'best friends', 'married'], correct_answers: ['my best friends got married before they turned 30'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'é—œä¿‚ä»£åè©', prompt: 'The doughnuts ___.', given_words: ['good', 'tasted', 'Mrs. Jones', 'really', 'baked'], correct_answers: ['Mrs. Jones baked tasted really good', 'that Mrs. Jones baked tasted really good'] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'Wh- ç–‘å•å¥', prompt: 'Why ___?', given_words: ['you', 'again', 'are', 'this movie', 'watching'], correct_answers: ['are you watching this movie again'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'pay... for...', prompt: 'Mike ___.', given_words: ['for', 'paid', 'his', 'new smartphone', 'NT$20,000'], correct_answers: ['paid NT$20,000 for his new smartphone'] },
            { num: 15, type: 'é‡çµ„', target_grammar: 'not as... as...', prompt: 'This game ___ last time.', given_words: ['we played', 'not as', 'is', 'the one', 'interesting', 'as'], correct_answers: ['is not as interesting as the one we played last time'] }
        ];

        // AMC-5 Questions
        questionBank['A-5'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'How much + åŠ©å‹•è© + it cost', original: 'Catherine paid NT$1,000 to stay at that hotel.', prompt: 'How much ___ cost ___ at that hotel?', correct_answers: ['did it cost Catherine to stay at that hotel'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'because of', original: 'Seth was late for work because he had a car accident.', prompt: 'Because of ___.', correct_answers: ['a car accident (that) he had, Seth was late for work', 'the car accident he had, Seth was late for work'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'How + åŠ©å‹•è© + S + V', original: 'How should we get to the beach?', prompt: 'Do you know ___?', correct_answers: ['how we should / to get to the beach'] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'æ¯”è¼ƒç´š', original: 'These new chairs are more comfortable than the old ones.', prompt: 'The old chairs are ___ than the new ones.', correct_answers: ['less comfortable than the new ones'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'with', original: "The old lady who's carrying a huge backpack is my grandma.", prompt: '___ my grandma.', correct_answers: ['The old lady with a huge backpack is my grandma'] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'which', original: ['Harry wants to buy the bag.', 'The bag has a lot of pockets.'], prompt: 'Harry ___.', correct_answers: ['wants to buy the bag which has a lot of pockets'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'both', original: ['I have two sisters.', 'They wear glasses.'], prompt: 'Both ___.', correct_answers: ['(of) my sisters wear glasses'] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'with', original: ['Jordan drew a picture.', 'He used crayons to draw it.'], prompt: 'Jordan ___.', correct_answers: ['drew a picture with crayons'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'ç¾åœ¨å®Œæˆå¼', original: ['Melissa stopped eating meat five years ago.', "She still doesn't eat meat."], prompt: 'Melissa ___ for five years.', correct_answers: ["has not / hasn't eaten (any) meat for five years"] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'for + V-ing', original: ['I was rude to you this morning.', 'I am sorry.'], prompt: 'I am sorry for ___.', correct_answers: ['being rude to you this morning'] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'How often', prompt: 'How often ___?', given_words: ['travel', 'you', 'do', 'abroad'], correct_answers: ['do you travel abroad'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'æœ€é«˜ç´š', prompt: 'This is ___.', given_words: ['the best', 'read', "I've", 'ever', 'book'], correct_answers: ["the best book I've ever read"] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'what + S + think of', prompt: "I'd like to know ___.", given_words: ['what', 'my song', 'think of', 'you'], correct_answers: ['what you think of my song'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'be interested in', prompt: 'Benny ___.', given_words: ['in', 'languages', 'is', 'learning', 'interested'], correct_answers: ['is interested in learning languages'] },
            { num: 15, type: 'é‡çµ„', target_grammar: 'It is + adj. + of + äºº + to V', prompt: 'It ___ her boyfriend told.', given_words: ['of', 'the lies', 'silly', 'to believe', 'was', 'Jill'], correct_answers: ['was silly of Jill to believe the lies her boyfriend told'] }
        ];

        // AMC-6 Questions
        questionBank['A-6'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'What + be å‹•è© + S + V-ing', original: 'Ralph is watching cartoons on TV.', prompt: 'What ___ on TV?', correct_answers: ['is Ralph watching on TV'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'éå»å¼', original: 'Max fights with his little brother every day.', prompt: 'Max ___ yesterday.', correct_answers: ['fought with his little brother yesterday'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'æœªä¾†å¼è¢«å‹•', original: 'A new leader will be elected by the group members.', prompt: 'The group members ___.', correct_answers: ['will elect a new leader'] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'send + äºº + ç‰©', original: 'Shelly sent a picture to me.', prompt: 'Shelly ___ a picture.', correct_answers: ['sent me a picture'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'How about + V-ing', original: "Let's throw a party for Dad!", prompt: 'How about ___?', correct_answers: ['throwing a party for Dad'] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'ç–‘å•å¥', original: ['What should I get from the supermarket?', 'Please tell me.'], prompt: 'Please tell me ___.', correct_answers: ['what I should get from the supermarket'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'because', original: ['Amy has caught a cold.', "She doesn't feel well."], prompt: '___ because ___.', correct_answers: ["Amy doesn't feel well because she has caught a cold"] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'too... to...', original: ['The room was very dark.', "I couldn't see anything in there."], prompt: 'The room ___.', correct_answers: ['was too dark for me to see anything in there'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'so', original: ['Mitchell was late for school today.', 'Kevin was late for school today, too.'], prompt: 'Mitchell ___, and ___ Kevin.', correct_answers: ['was late for school today, and so was Kevin'] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'It cost + äºº + é‡‘éŒ¢ + to V', original: ['Jack bought a new wallet.', 'It cost him NT$2,000.'], prompt: 'It cost Jack ___.', correct_answers: ['NT$2,000 to buy a new wallet'] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'æ„Ÿå˜†å¥', prompt: 'What a ___!', given_words: ['he', 'singer', 'is', 'great'], correct_answers: ['great singer he is'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'åèº«ä»£åè©', prompt: 'Ivy always ___.', given_words: ['dinner', 'has', 'herself', 'by'], correct_answers: ['has dinner by herself'] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'ä»‹ç³»è©ç‰‡èª', prompt: 'I saw ___ the bus.', given_words: ['in', 'pink', 'a woman', 'on'], correct_answers: ['a woman in pink on the bus'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'There is something wrong with', prompt: 'There is ___.', given_words: ['with', 'wrong', 'my phone', 'something'], correct_answers: ['something wrong with my phone'] },
            { num: 15, type: 'é‡çµ„', target_grammar: "feel like + V-ing", prompt: "Tom doesn't ___.", given_words: ['tonight', 'feel', 'out', 'like', 'going'], correct_answers: ["feel like going out tonight"] }
        ];

        // AMC-7 Questions
        questionBank['A-7'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'æœªä¾†å¼ will', original: 'The man began the project last month.', prompt: 'The man ___ next month.', correct_answers: ['will begin the project next month'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'neither... nor...', original: "Ronald didn't pass the test, and neither did Josh.", prompt: 'Neither ___ the test.', correct_answers: ['Ronald nor Josh passed the test'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'Where + åŠ©å‹•è© + S + V', original: 'Dave met his wife at a local theater.', prompt: 'Where ___ his wife?', correct_answers: ['did Dave meet his wife'] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'It is + adj. + to V', original: 'Getting around with a motorcycle is convenient.', prompt: 'It is ___ with a motorcycle.', correct_answers: ['convenient to get around with a motorcycle'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'æ¯”è¼ƒç´š', original: 'Kate does not run as fast as Sarah.', prompt: 'Sarah ___ than Kate.', correct_answers: ['runs faster than Kate'] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'whether/if', original: ['Are there enough chairs in the room?', "I don't know."], prompt: "I don't know ___ in the room.", correct_answers: ['whether (or not) there are enough chairs in the room', 'if there are enough chairs in the room'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'after', original: ['Andy boiled some water.', 'Then he made himself a cup of tea.'], prompt: 'Andy ___ after he ___.', correct_answers: ['made himself a cup of tea after he boiled some water'] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'help + O + (to) V', original: ['My mom mopped the floor.', 'I helped her.'], prompt: 'I helped my mom ___.', correct_answers: ['(to) mop the floor'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'é—œä¿‚ä»£åè© who', original: ['The woman has just lost her husband.', 'She is crying.'], prompt: 'The woman who ___ her husband.', correct_answers: ['is crying has just lost her husband', 'has just lost her husband is crying'] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'so that', original: ['Mr. Chen put up a fence.', "He did it to keep his dog from running away."], prompt: 'Mr. Chen put up a fence ___.', correct_answers: ["so that his dog wouldn't run away"] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'ç¾åœ¨å®Œæˆå¼', prompt: 'Have ___ a long time?', given_words: ['worked', 'for', 'you', 'here'], correct_answers: ['you worked here for a long time'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'è¢«å‹•èªæ…‹', prompt: 'This bridge ___ in 2010.', given_words: ['our company', 'built', 'was', 'by'], correct_answers: ['was built by our company in 2010'] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'with', prompt: 'Jay has ___.', given_words: ['big balcony', 'a house', 'with', 'a'], correct_answers: ['a house with a big balcony'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'æ„Ÿå®˜å‹•è© + O + V-ing', prompt: 'Paul heard ___ night.', given_words: ['playing', 'his sister', 'the guitar', 'last'], correct_answers: ['his sister playing the guitar last night'] },
            { num: 15, type: 'é‡çµ„', target_grammar: 'too... to...', prompt: 'The box is ___.', given_words: ['heavy', 'for', 'too', 'her', 'to lift'], correct_answers: ['too heavy for her to lift'] }
        ];

        // AMC-8 Questions
        questionBank['A-8'] = [
            { num: 1, type: 'å¥å­æ”¹å¯«', target_grammar: 'é™„åŠ å•å¥', original: "Your sister doesn't like singing.", prompt: "Your sister doesn't like singing, ___?", correct_answers: ['does she'] },
            { num: 2, type: 'å¥å­æ”¹å¯«', target_grammar: 'keep + V-ing', original: 'Mandy talks about herself all the time.', prompt: 'Mandy keeps ___ herself.', correct_answers: ['talking about herself'] },
            { num: 3, type: 'å¥å­æ”¹å¯«', target_grammar: 'make + O + V', original: 'Mom got Peter to tidy his bedroom.', prompt: 'Mom made ___.', correct_answers: ['Peter tidy his bedroom'] },
            { num: 4, type: 'å¥å­æ”¹å¯«', target_grammar: 'éå»å¼', original: 'My aunt will buy a birthday gift for me this year.', prompt: 'My aunt ___ last year.', correct_answers: ['bought a birthday gift for me last year'] },
            { num: 5, type: 'å¥å­æ”¹å¯«', target_grammar: 'too... to...', original: 'This sofa is not small enough to fit in our living room.', prompt: 'This sofa is ___ in our living room.', correct_answers: ['too big to fit in our living room'] },
            { num: 6, type: 'å¥å­åˆä½µ', target_grammar: 'Wh- ç–‘å•å¥', original: ['Why is the little boy crying?', "I'm not sure."], prompt: "I'm not sure ___.", correct_answers: ['why the little boy is crying'] },
            { num: 7, type: 'å¥å­åˆä½µ', target_grammar: 'on foot', original: ['Adrian went to the supermarket.', 'He walked there.'], prompt: 'Adrian went to the supermarket ___.', correct_answers: ['on foot'] },
            { num: 8, type: 'å¥å­åˆä½µ', target_grammar: 'spend + æ™‚é–“ + V-ing', original: ['Tyler built a swing set for his daughter.', 'It took five hours.'], prompt: 'Tyler spent ___ a swing set for his daughter.', correct_answers: ['five hours building a swing set for his daughter'] },
            { num: 9, type: 'å¥å­åˆä½µ', target_grammar: 'é—œä¿‚ä»£åè© whose', original: ['The man felt very proud.', 'His son had just won the race.'], prompt: 'The man ___ felt very proud.', correct_answers: ['whose son had just won the race felt very proud'] },
            { num: 10, type: 'å¥å­åˆä½µ', target_grammar: 'teach + O + to + V', original: ['Eleanor teaches math.', 'Her students are young children.'], prompt: 'Eleanor ___ young children.', correct_answers: ['teaches math to young children'] },
            { num: 11, type: 'é‡çµ„', target_grammar: 'Wh- ç–‘å•å¥', prompt: 'Where ___?', given_words: ['you', 'this summer', 'go', 'will'], correct_answers: ['will you go this summer'] },
            { num: 12, type: 'é‡çµ„', target_grammar: 'had better', prompt: 'We ___ the airport.', given_words: ['a taxi', 'to', 'had better', 'take'], correct_answers: ['had better take a taxi to the airport'] },
            { num: 13, type: 'é‡çµ„', target_grammar: 'be famous for', prompt: 'Australia is ___.', given_words: ['for', 'famous', 'beautiful beaches', 'its'], correct_answers: ['famous for its beautiful beaches'] },
            { num: 14, type: 'é‡çµ„', target_grammar: 'give + äºº + ç‰©', prompt: 'The rich man ___.', given_words: ['a house', 'his children', 'gave', 'each of'], correct_answers: ['gave each of his children a house'] },
            { num: 15, type: 'é‡çµ„', target_grammar: 'æ¯”è¼ƒç´š', prompt: 'Mrs. Wood ___ does.', given_words: ['than', 'earns', 'her husband', 'money', 'more'], correct_answers: ['earns more money than her husband does'] }
        ];

        function updateModelDisplay() {
            selectedModel = document.getElementById('modelSelect').value;
            const modelName = selectedModel === 'claude-sonnet-4.5' ? 'Claude Sonnet 4.5' : 'GPT 5.2';
            document.getElementById('headerSubtitle').textContent = `æ•™å¸«æ‰¹æ”¹æ¨¡å¼ | AI: ${modelName}`;
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
            document.getElementById('batchModeBtn').classList.toggle('active', mode === 'batch');

            // Show/hide appropriate sections
            if (mode === 'single') {
                document.getElementById('questionsContainer').style.display = currentQuestions.length > 0 ? 'block' : 'none';
                document.getElementById('batchInputSection').style.display = 'none';
            } else {
                document.getElementById('questionsContainer').style.display = 'none';
                document.getElementById('batchInputSection').style.display = 'block';
            }

            // Hide results and bottom buttons when switching modes
            document.getElementById('results').style.display = 'none';
            document.getElementById('bottomButtons').style.display = 'none';
            gradingResults = [];
        }

        async function loadQuestions() {
            const testId = document.getElementById('testSelect').value;
            const container = document.getElementById('questionsContainer');

            // Hide results and bottom buttons when loading new questions
            document.getElementById('results').style.display = 'none';
            document.getElementById('bottomButtons').style.display = 'none';
            gradingResults = [];

            if (!testId) {
                container.style.display = 'none';
                return;
            }

            if (testId === 'AI') {
                // Show enhanced loading state with progress, tips, and countdown
                container.innerHTML = `
                    <div class="question-item" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <h3 style="color: #4f46e5; margin-bottom: 15px;">ğŸ¤– AI æ­£åœ¨ç”Ÿæˆé¡Œç›®...</h3>

                        <!-- Progress Bar -->
                        <div style="background: #e5e7eb; border-radius: 10px; height: 8px; margin: 20px auto; max-width: 400px; overflow: hidden;">
                            <div id="aiProgressBar" style="background: linear-gradient(45deg, #4f46e5, #7c3aed); height: 100%; width: 0%; transition: width 0.5s;"></div>
                        </div>

                        <p id="aiProgressText" style="color: #6b7280; font-weight: 600; margin-bottom: 10px;">åˆå§‹åŒ–...</p>
                        <p id="aiTimeEstimate" style="color: #9ca3af; font-size: 0.9rem;">é è¨ˆ 20 ç§’</p>

                        <!-- Teaching Tip -->
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-top: 25px; max-width: 500px; margin-left: auto; margin-right: auto;">
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">ğŸ’¡ æ•™å­¸å°æç¤º</div>
                            <div id="teachingTip" style="color: #78350f; line-height: 1.6; font-size: 0.95rem;"></div>
                        </div>
                    </div>
                `;
                container.style.display = 'block';

                // Teaching tips array
                const teachingTips = [
                    'å¥å­æ”¹å¯«é¡Œå‹ï¼šè‘—é‡æ™‚æ…‹è½‰æ›ã€èªæ…‹è®ŠåŒ–ã€å¥å‹è½‰æ›ç­‰æ–‡æ³•æ¦‚å¿µçš„éˆæ´»é‹ç”¨',
                    'å¥å­åˆä½µé¡Œå‹ï¼šè€ƒé©—å­¸ç”Ÿä½¿ç”¨é€£æ¥è©ã€é—œä¿‚å­å¥ã€ä»‹ä¿‚è©ç‰‡èªç­‰é€£çµå¥æ„çš„èƒ½åŠ›',
                    'é‡çµ„é¡Œå‹ï¼šè¨“ç·´å­¸ç”Ÿå°è‹±æ–‡å¥æ§‹çš„ç†è§£ï¼ŒåŒ…å«ä¸»è©ã€å‹•è©ã€å—è©çš„æ­£ç¢ºæ’åˆ—é †åº',
                    'è©•åˆ†æ¨™æº–ï¼š2åˆ†è¡¨ç¤ºå®Œå…¨æ­£ç¢ºï¼Œ1åˆ†è¡¨ç¤ºæœ‰å°éŒ¯èª¤ï¼ˆå¦‚æ‹¼å¯«ã€æ¨™é»ï¼‰ï¼Œ0åˆ†è¡¨ç¤ºæœ‰æ–‡æ³•éŒ¯èª¤',
                    'CEFR A2 ç¨‹åº¦ï¼šç›¸ç•¶æ–¼åœ‹ä¸­ç•¢æ¥­ç¨‹åº¦ï¼Œè‘—é‡æ—¥å¸¸ç”Ÿæ´»åŸºæœ¬æºé€šèƒ½åŠ›',
                    'å»ºè­°ç·´ç¿’é »ç‡ï¼šæ¯é€±è‡³å°‘ç·´ç¿’ä¸€çµ„å®Œæ•´é¡Œç›®ï¼ŒæŒçºŒè¿½è¹¤å­¸ç”Ÿé€²æ­¥ç‹€æ³',
                    'å¸¸è¦‹éŒ¯èª¤ï¼šæ™‚æ…‹ä¸ä¸€è‡´ã€ä¸»è©å‹•è©ä¸ä¸€è‡´ã€ä»‹ä¿‚è©ä½¿ç”¨éŒ¯èª¤ã€å† è©éºæ¼',
                    'AI ç”Ÿæˆå„ªå‹¢ï¼šé¡Œç›®å¤šå…ƒåŒ–ã€å³æ™‚ç”¢å‡ºã€ç¬¦åˆ GEPT å®˜æ–¹æ¨™æº–æ ¼å¼',
                    'è¤‡ç¿’å»ºè­°ï¼šé‡å°å¾—åˆ† 0-1 åˆ†çš„é¡Œç›®ï¼Œè®“å­¸ç”Ÿé‡æ–°ä½œç­”ä¸¦èªªæ˜æ­£ç¢ºæ–‡æ³•æ¦‚å¿µ',
                    'é€²éšæ‡‰ç”¨ï¼šå¯å°‡ AI ç”Ÿæˆé¡Œç›®ä¾æ–‡æ³•é»åˆ†é¡ï¼Œå»ºç«‹å€‹äººåŒ–éŒ¯é¡Œåº«'
                ];

                // Randomly select a tip
                const randomTip = teachingTips[Math.floor(Math.random() * teachingTips.length)];
                document.getElementById('teachingTip').textContent = randomTip;

                // Progress simulation
                let progress = 0;
                let timeLeft = 20;
                const progressStages = [
                    { percent: 20, text: 'åˆ†æ GEPT é¡Œå‹è¦ç¯„...', duration: 3 },
                    { percent: 40, text: 'ç”Ÿæˆç¬¬ 1-5 é¡Œï¼ˆå¥å­æ”¹å¯«ï¼‰...', duration: 5 },
                    { percent: 60, text: 'ç”Ÿæˆç¬¬ 6-10 é¡Œï¼ˆå¥å­åˆä½µï¼‰...', duration: 5 },
                    { percent: 80, text: 'ç”Ÿæˆç¬¬ 11-15 é¡Œï¼ˆé‡çµ„ï¼‰...', duration: 5 },
                    { percent: 95, text: 'é©—è­‰é¡Œç›®å“è³ª...', duration: 2 }
                ];

                let stageIndex = 0;
                const updateProgress = () => {
                    if (stageIndex < progressStages.length) {
                        const stage = progressStages[stageIndex];
                        document.getElementById('aiProgressBar').style.width = stage.percent + '%';
                        document.getElementById('aiProgressText').textContent = stage.text;
                        stageIndex++;
                    }
                };

                const progressInterval = setInterval(updateProgress, 4000);
                updateProgress(); // Start immediately

                const countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        document.getElementById('aiTimeEstimate').textContent = `é è¨ˆå‰©é¤˜ ${timeLeft} ç§’`;
                    } else {
                        document.getElementById('aiTimeEstimate').textContent = 'å³å°‡å®Œæˆ...';
                    }
                }, 1000);

                try {
                    // Call AI generation endpoint
                    const response = await fetch(`${API_BASE_URL}/api/generate-questions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: selectedModel })
                    });

                    clearInterval(progressInterval);
                    clearInterval(countdownInterval);

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'ç”Ÿæˆå¤±æ•—');
                    }

                    // Completion animation
                    document.getElementById('aiProgressBar').style.width = '100%';
                    document.getElementById('aiProgressText').textContent = 'âœ… ç”Ÿæˆå®Œæˆï¼';
                    document.getElementById('aiTimeEstimate').textContent = '';

                    // Store AI-generated questions
                    currentTest = 'AI';
                    currentQuestions = data.questions;

                    // Small delay to show completion
                    await new Promise(r => setTimeout(r, 800));

                    // Display generated questions
                    displayQuestions();

                } catch (error) {
                    clearInterval(progressInterval);
                    clearInterval(countdownInterval);
                    console.error('AI generation error:', error);
                    container.innerHTML = `
                        <div class="question-item" style="text-align: center; padding: 40px;">
                            <h3 style="color: #dc2626; margin-bottom: 10px;">âŒ ç”Ÿæˆå¤±æ•—</h3>
                            <p style="color: #6b7280;">${error.message}</p>
                            <button onclick="loadQuestions()" style="margin-top: 20px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer;">é‡è©¦</button>
                        </div>
                    `;
                }
                return;
            }

            currentTest = testId;
            currentQuestions = questionBank[testId];
            displayQuestions();
        }

        function displayQuestions() {
            const container = document.getElementById('questionsContainer');
            let html = '';

            currentQuestions.forEach((q, index) => {
                // For é‡çµ„ questions, show full sentence input instead of blank filling
                const isUnscramble = q.type === 'é‡çµ„';

                html += `
                <div class="question-item">
                    <div class="question-header">
                        <span class="question-num">Q${q.num}</span>
                        <span class="question-type">${q.type}</span>
                    </div>
                    <div class="question-content">
                        ${q.original ? `
                            <div class="question-original">
                                ${Array.isArray(q.original) ? q.original.join('<br>') : q.original}
                            </div>
                        ` : ''}
                        ${isUnscramble ? `
                            ${q.prompt ? `
                                <div class="question-prompt">${q.prompt}</div>
                            ` : ''}
                            <div style="background: #e0f2fe; border-left: 4px solid #0284c7; padding: 10px 14px; border-radius: 8px; margin: 10px 0;">
                                <div style="color: #0369a1; font-weight: 600; margin-bottom: 6px;">ğŸ“ è«‹é‡çµ„ä»¥ä¸‹å­—è©${q.prompt ? 'å®Œæˆå¥å­' : 'æˆå®Œæ•´å¥å­'}ï¼š</div>
                                <span style="color: #0369a1; font-weight: 600; font-size: 1.05rem;">${q.given_words.join(' / ')}</span>
                            </div>
                        ` : `
                            <div class="question-prompt">${q.prompt}</div>
                            ${q.given_words ? `
                                <div class="given-words">æç¤ºå­—è©: ${q.given_words.join(' / ')}</div>
                            ` : ''}
                        `}
                    </div>
                    <div class="answer-input-wrapper">
                        <label for="answer${index}">âœï¸ ${isUnscramble ? 'å®Œæ•´å¥å­' : 'å­¸ç”Ÿç­”æ¡ˆ'}ï¼š</label>
                        <input type="text" id="answer${index}" placeholder="${isUnscramble ? 'è«‹è¼¸å…¥å®Œæ•´é‡çµ„å¾Œçš„å¥å­...' : 'è«‹è¼¸å…¥ç­”æ¡ˆ...'}"
                               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
            container.style.display = 'block';

            // Start stopwatch when questions are loaded
            startTime = Date.now();
        }

        async function startFresh() {
            // Clear results and hide bottom buttons
            document.getElementById('results').style.display = 'none';
            document.getElementById('bottomButtons').style.display = 'none';
            gradingResults = [];

            if (currentTest === 'AI') {
                // For AI tests: regenerate new questions
                const testSelect = document.getElementById('testSelect');
                testSelect.value = 'AI';
                await loadQuestions();
            } else {
                // For regular tests: clear all input fields and scroll to top
                currentQuestions.forEach((q, index) => {
                    const input = document.getElementById(`answer${index}`);
                    if (input) {
                        input.value = '';
                    }
                });

                // Scroll to questions container
                document.getElementById('questionsContainer').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // Focus on first input
                const firstInput = document.getElementById('answer0');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 500);
                }
            }
        }

        async function gradeAnswers() {
            if (currentMode === 'single' && !currentTest) {
                alert('è«‹å…ˆé¸æ“‡é¡Œçµ„ï¼');
                return;
            }

            if (currentMode === 'single') {
                await gradeSingleMode();
            } else {
                await gradeBatchMode();
            }
        }

        async function gradeSingleMode() {
            // Collect all 15 answers
            const answers = [];
            for (let i = 0; i < currentQuestions.length; i++) {
                const input = document.getElementById(`answer${i}`);
                const answer = input ? input.value.trim() : '';
                if (!answer) {
                    alert(`è«‹å¡«å¯«ç¬¬ ${i + 1} é¡Œç­”æ¡ˆï¼`);
                    return;
                }
                answers.push(answer);
            }

            // Show enhanced loading with progress and tips
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('bottomButtons').style.display = 'none';
            document.getElementById('gradeBtn').disabled = true;

            // Show grading tip box
            document.getElementById('gradingTipBox').style.display = 'block';

            // Grading tips array
            const gradingTips = [
                'è©•åˆ†æ¨™æº–ï¼š2åˆ† = å®Œå…¨æ­£ç¢ºï¼Œ1åˆ† = æ–‡æ³•æ­£ç¢ºä½†æœ‰å°éŒ¯èª¤ï¼ˆæ‹¼å¯«ã€æ¨™é»ï¼‰ï¼Œ0åˆ† = ä»»ä½•æ–‡æ³•éŒ¯èª¤',
                'å¸¸è¦‹æ‰£åˆ†åŸå› ï¼šæ™‚æ…‹éŒ¯èª¤ã€ä¸»è©å‹•è©ä¸ä¸€è‡´ã€ä»‹ä¿‚è©ä½¿ç”¨éŒ¯èª¤ã€å† è©éºæ¼',
                'é‡çµ„é¡Œå‹ï¼šå­¸ç”Ÿéœ€ä½¿ç”¨æ‰€æœ‰æä¾›çš„å­—è©ï¼Œä¸¦ä¿ç•™é¡Œç›®ä¸­å·²æä¾›çš„éƒ¨åˆ†',
                'AI è©•åˆ†ä½¿ç”¨åš´æ ¼çš„ GEPT æ¨™æº–ï¼Œç¢ºä¿å…¬å¹³ä¸€è‡´çš„è©•åˆ†çµæœ',
                'å¥å­æ”¹å¯«é¡Œï¼šé‡é»åœ¨æ–¼æ–‡æ³•è½‰æ›çš„æ­£ç¢ºæ€§ï¼Œå¦‚æ™‚æ…‹ã€èªæ…‹ã€å¥å‹è®ŠåŒ–',
                'å¥å­åˆä½µé¡Œï¼šè€ƒé©—é€£æ¥è©ã€é—œä¿‚å­å¥ã€åµŒå…¥å•å¥çš„ä½¿ç”¨èƒ½åŠ›',
                'æ‰¹æ¬¡è©•åˆ†å¤§å¹…æå‡æ•ˆç‡ï¼š15 é¡ŒåŒæ™‚è©•åˆ†ï¼Œåªéœ€ 5-10 ç§’',
                'è©•åˆ†å¾Œå¯ç”¢ç”Ÿè©³ç´°å ±å‘Šï¼ŒåŒ…å«æ¯é¡Œçš„éŒ¯èª¤åˆ†æå’ŒAIèªªæ˜',
                'å»ºè­°å­¸ç”Ÿé‡å° 0-1 åˆ†çš„é¡Œç›®é€²è¡Œå¾©ç¿’ï¼Œç†è§£æ­£ç¢ºæ–‡æ³•æ¦‚å¿µ'
            ];

            // Randomly select a tip
            const randomTip = gradingTips[Math.floor(Math.random() * gradingTips.length)];
            document.getElementById('gradingTip').textContent = randomTip;

            // Progress simulation
            let gradingProgress = 0;
            let timeLeft = 10;
            const gradingStages = [
                { percent: 33, text: 'è©•åˆ†ç¬¬ 1-5 é¡Œ...', duration: 2000 },
                { percent: 66, text: 'è©•åˆ†ç¬¬ 6-10 é¡Œ...', duration: 2000 },
                { percent: 90, text: 'è©•åˆ†ç¬¬ 11-15 é¡Œ...', duration: 2000 }
            ];

            let stageIndex = 0;
            const updateGradingProgress = () => {
                if (stageIndex < gradingStages.length) {
                    const stage = gradingStages[stageIndex];
                    document.getElementById('gradingProgressBar').style.width = stage.percent + '%';
                    document.getElementById('loadingProgress').textContent = stage.text;
                    stageIndex++;
                }
            };

            const progressInterval = setInterval(updateGradingProgress, 3000);
            updateGradingProgress(); // Start immediately

            const countdownInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    document.getElementById('gradingTimeEstimate').textContent = `é è¨ˆå‰©é¤˜ ${timeLeft} ç§’`;
                } else {
                    document.getElementById('gradingTimeEstimate').textContent = 'å³å°‡å®Œæˆ...';
                }
            }, 1000);

            document.getElementById('gradingTimeEstimate').textContent = `é è¨ˆ ${timeLeft} ç§’`;

            gradingResults = [];

            try {
                // Prepare batch request
                const questionsToGrade = currentQuestions.map((q, i) => ({
                    questionNum: q.num,
                    question_type: q.type,
                    original: q.original,
                    prompt: q.prompt,
                    given_words: q.given_words,
                    correct_answers: q.correct_answers,
                    student_answer: answers[i]
                }));

                // Single batch API call
                const response = await fetch(`${API_BASE_URL}/api/grade-sentence-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questions: questionsToGrade,
                        model: selectedModel
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'è©•åˆ†å¤±æ•—');
                }

                // Clear progress intervals
                clearInterval(progressInterval);
                clearInterval(countdownInterval);

                // Complete progress animation
                document.getElementById('gradingProgressBar').style.width = '100%';
                document.getElementById('loadingProgress').textContent = 'âœ… è©•åˆ†å®Œæˆï¼';
                document.getElementById('gradingTimeEstimate').textContent = '';

                // Calculate elapsed time
                if (startTime) {
                    elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                }

                // Store results
                gradingResults = data.results.map(r => ({
                    studentName: 'å­¸ç”Ÿ',
                    questionNum: r.questionNum,
                    questionType: r.questionType,
                    answer: r.answer,
                    score: r.score,
                    grammar_errors: r.grammar_errors,
                    minor_errors: r.minor_errors,
                    explanation_zh: r.explanation_zh,
                    explanation_en: r.explanation_en
                }));

                // Small delay to show completion
                await new Promise(r => setTimeout(r, 800));

                displayResults('single');

            } catch (error) {
                clearInterval(progressInterval);
                clearInterval(countdownInterval);
                console.error('Grading error:', error);
                alert('è©•åˆ†éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gradeBtn').disabled = false;
            }
        }

        async function gradeBatchMode() {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) {
                alert('è«‹è¼¸å…¥å­¸ç”Ÿç­”æ¡ˆï¼');
                return;
            }

            // Parse batch input
            const lines = input.split('\n').map(l => l.trim()).filter(l => l);
            const students = [];
            let currentStudent = null;

            for (const line of lines) {
                // If we have 15 answers already, this should be a new student name
                if (!currentStudent || currentStudent.answers.length === 15) {
                    currentStudent = { name: line, answers: [] };
                    students.push(currentStudent);
                } else {
                    currentStudent.answers.push(line);
                }
            }

            // Validate
            const invalidStudents = students.filter(s => s.answers.length !== 15);
            if (invalidStudents.length > 0) {
                alert(`ä»¥ä¸‹å­¸ç”Ÿç­”æ¡ˆæ•¸é‡ä¸æ­£ç¢ºï¼ˆéœ€è¦15é¡Œï¼‰ï¼š\n${invalidStudents.map(s => `${s.name}: ${s.answers.length}é¡Œ`).join('\n')}`);
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('bottomButtons').style.display = 'none';
            document.getElementById('gradeBtn').disabled = true;

            gradingResults = [];

            try {
                // Process each student with batch grading
                for (let studentIndex = 0; studentIndex < students.length; studentIndex++) {
                    const student = students[studentIndex];
                    document.getElementById('loadingProgress').textContent =
                        `æ­£åœ¨æ‰¹æ¬¡è©•åˆ† ${student.name} (${studentIndex + 1} / ${students.length})...`;

                    // Prepare batch request for this student
                    const questionsToGrade = currentQuestions.map((q, i) => ({
                        questionNum: q.num,
                        question_type: q.type,
                        original: q.original,
                        prompt: q.prompt,
                        given_words: q.given_words,
                        correct_answers: q.correct_answers,
                        student_answer: student.answers[i]
                    }));

                    // Single batch API call per student
                    const response = await fetch(`${API_BASE_URL}/api/grade-sentence-batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            questions: questionsToGrade,
                            model: selectedModel
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'è©•åˆ†å¤±æ•—');
                    }

                    // Store results for this student
                    data.results.forEach(r => {
                        gradingResults.push({
                            studentName: student.name,
                            questionNum: r.questionNum,
                            questionType: r.questionType,
                            answer: r.answer,
                            score: r.score,
                            grammar_errors: r.grammar_errors,
                            minor_errors: r.minor_errors,
                            explanation_zh: r.explanation_zh,
                            explanation_en: r.explanation_en
                        });
                    });

                    // Small delay between students to avoid rate limiting
                    if (studentIndex < students.length - 1) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }

                displayResults('batch');

            } catch (error) {
                console.error('Grading error:', error);
                alert('è©•åˆ†éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gradeBtn').disabled = false;
            }
        }

        async function gradeOneAnswer(question, answer, questionNum, studentName = 'å­¸ç”Ÿ') {
            const response = await fetch(`${API_BASE_URL}/api/grade-sentence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question_type: question.type,
                    original: question.original,
                    prompt: question.prompt,
                    given_words: question.given_words,
                    correct_answers: question.correct_answers,
                    student_answer: answer,
                    model: selectedModel
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();

            return {
                studentName: studentName,
                questionNum: questionNum,
                questionType: question.type,
                answer: answer,
                ...data.result
            };
        }

        function displayResults(mode) {
            // Calculate statistics
            const scores = gradingResults.map(r => r.score);
            const count2 = scores.filter(s => s === 2).length;
            const count1 = scores.filter(s => s === 1).length;
            const count0 = scores.filter(s => s === 0).length;
            const totalScore = scores.reduce((a, b) => a + b, 0);
            const maxScore = scores.length * 2;
            const percentage = ((totalScore / maxScore) * 100).toFixed(1);

            // Format elapsed time
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeDisplay = minutes > 0
                ? `${minutes} åˆ† ${seconds} ç§’`
                : `${seconds} ç§’`;

            document.getElementById('summaryStats').innerHTML = `
                <div class="stat-card green">
                    <div class="stat-number">${count2}</div>
                    <div class="stat-label">æ»¿åˆ† (2åˆ†)</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-number">${count1}</div>
                    <div class="stat-label">éƒ¨åˆ† (1åˆ†)</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number">${count0}</div>
                    <div class="stat-label">é›¶åˆ† (0åˆ†)</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number">${totalScore}/${maxScore}</div>
                    <div class="stat-label">ç¸½åˆ† (${percentage}%)</div>
                </div>
                ${elapsedSeconds > 0 ? `
                <div class="stat-card" style="background: #faf5ff; border-color: #a855f7;">
                    <div class="stat-number" style="color: #9333ea; font-size: 2rem;">â±ï¸</div>
                    <div class="stat-label" style="color: #9333ea;">${timeDisplay}</div>
                </div>
                ` : ''}
            `;

            // Display individual results
            let html = '';
            if (mode === 'batch') {
                // Group by student
                const studentMap = {};
                gradingResults.forEach(r => {
                    if (!studentMap[r.studentName]) {
                        studentMap[r.studentName] = [];
                    }
                    studentMap[r.studentName].push(r);
                });

                Object.keys(studentMap).forEach(studentName => {
                    const results = studentMap[studentName];
                    const studentTotal = results.reduce((sum, r) => sum + r.score, 0);
                    const studentMax = results.length * 2;
                    const studentPercent = ((studentTotal / studentMax) * 100).toFixed(1);

                    html += `
                    <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin-bottom: 15px;">${studentName} - ${studentTotal}/${studentMax} (${studentPercent}%)</h3>
                    `;

                    results.forEach(r => {
                        html += generateResultCard(r);
                    });

                    html += '</div>';
                });
            } else {
                // Single mode - show all questions
                gradingResults.forEach(r => {
                    html += generateResultCard(r);
                });
            }

            document.getElementById('resultsList').innerHTML = html;
            document.getElementById('results').style.display = 'block';

            // Show bottom buttons section
            document.getElementById('bottomButtons').style.display = 'flex';

            // Update start fresh button text based on test type
            const buttonText = currentTest === 'AI' ? 'ç”Ÿæˆæ–°é¡Œç›®' : 'é‡æ–°é–‹å§‹';
            document.getElementById('startFreshText').textContent = buttonText;
        }

        function generateResultCard(r) {
            return `
            <div class="result-card">
                <div class="result-header">
                    <span class="question-title">ç¬¬ ${r.questionNum} é¡Œ - ${r.questionType}</span>
                    <span class="score-badge score-${r.score}">${r.score} åˆ†</span>
                </div>
                <div class="result-answer">${r.answer}</div>
                <div class="result-feedback">
                    ${r.grammar_errors && r.grammar_errors.length > 0 ? `
                        <div class="grammar-errors">
                            <div class="feedback-label">âŒ æ–‡æ³•éŒ¯èª¤ï¼š</div>
                            ${r.grammar_errors.join('<br>')}
                        </div>
                    ` : ''}
                    ${r.minor_errors && r.minor_errors.length > 0 ? `
                        <div class="minor-errors">
                            <div class="feedback-label">âš ï¸ å°éŒ¯èª¤ï¼š</div>
                            ${r.minor_errors.join('<br>')}
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px;">
                        <div class="feedback-label">ğŸ’¬ èªªæ˜ï¼š</div>
                        <div>${r.explanation_zh || r.explanation_en || 'ç„¡'}</div>
                    </div>
                </div>
            </div>
            `;
        }

        async function exportResults() {
            if (gradingResults.length === 0) {
                alert('æ²’æœ‰çµæœå¯ä»¥åŒ¯å‡º');
                return;
            }

            // Get student name (use first result's student name or ask)
            let studentName = gradingResults[0].studentName;
            if (currentMode === 'single' && studentName === 'å­¸ç”Ÿ') {
                studentName = prompt('è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼ˆé¸å¡«ï¼‰ï¼š') || '';
            }

            // Open window IMMEDIATELY before async operations (iOS Safari fix)
            const printWindow = window.open('about:blank', '_blank');

            if (!printWindow) {
                alert('è«‹å…è¨±å½ˆå‡ºå¼è¦–çª—ä»¥ä¸‹è¼‰PDFå ±å‘Š');
                return;
            }

            // Show loading message in the new window
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>è¼‰å…¥ä¸­...</title>
                    <style>
                        body {
                            font-family: 'Microsoft JhengHei', Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            margin: 0;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        }
                        .loading {
                            text-align: center;
                            color: white;
                        }
                        .spinner {
                            border: 4px solid rgba(255, 255, 255, 0.3);
                            border-top: 4px solid white;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 20px;
                        }
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </head>
                <body>
                    <div class="loading">
                        <div class="spinner"></div>
                        <h2>æ­£åœ¨æº–å‚™PDFå ±å‘Š...</h2>
                        <p>è«‹ç¨å€™</p>
                    </div>
                </body>
                </html>
            `);

            try {
                // Enrich grading results with question data for PDF report
                const enrichedResults = gradingResults.map((result, index) => {
                    const question = currentQuestions.find(q => q.num === result.questionNum);
                    return {
                        ...result,
                        original: question ? question.original : null,
                        prompt: question ? question.prompt : null,
                        given_words: question ? question.given_words : null
                    };
                });

                // Save session to backend
                const response = await fetch(`${API_BASE_URL}/api/save-sentence-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gradingResults: enrichedResults,
                        testId: currentTest,
                        studentName: studentName || null,
                        elapsedSeconds: elapsedSeconds
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'å„²å­˜å¤±æ•—');
                }

                console.log('âœ… Session saved:', data.sessionId);

                // Navigate the already-opened window to the print page
                const printUrl = `printable_sentence_report.html?session=${data.sessionId}`;
                printWindow.location.href = printUrl;

            } catch (error) {
                console.error('Error saving session:', error);

                // Show error in the opened window
                printWindow.document.body.innerHTML = `
                    <div style="text-align:center;padding:40px;font-family:Arial,sans-serif;">
                        <h2 style="color:#dc2626;">âŒ å„²å­˜å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤</h2>
                        <p style="color:#6b7280;">${error.message}</p>
                        <button onclick="window.close()" style="margin-top:20px;padding:10px 20px;background:#4f46e5;color:white;border:none;border-radius:8px;cursor:pointer;">é—œé–‰è¦–çª—</button>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
