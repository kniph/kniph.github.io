<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SK-016 è¤‡èª¦ç·´ç¿’ â€” GEPT å£èªª</title>
  <script>
    if (localStorage.getItem('loggedIn') !== 'yes') {
      window.location.href = '/login.html';
    }
  </script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #0d9488, #0f766e);
      color: white;
      text-align: center;
      padding: 30px;
    }
    .header h1 { font-size: 2rem; margin-bottom: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    .header p  { font-size: 1rem; opacity: 0.9; }

    .nav-bar {
      background: rgba(0,0,0,0.15);
      padding: 10px 30px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .nav-bar a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      transition: background 0.2s;
    }
    .nav-bar a:hover, .nav-bar a.active { background: rgba(255,255,255,0.25); color: white; }

    .main { padding: 30px; }

    .controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .controls-row label { font-weight: 600; color: #374151; }
    .controls-row select {
      padding: 8px 14px;
      border: 2px solid #d1fae5;
      border-radius: 10px;
      font-size: 0.95rem;
      color: #065f46;
      background: #f0fdf4;
      cursor: pointer;
    }
    .controls-row select:focus { outline: none; border-color: #0d9488; }

    /* Item progress dots */
    .item-dots { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .item-dot {
      width: 34px; height: 34px;
      border-radius: 50%;
      border: 2px solid #99f6e4;
      background: #f0fdfa;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 700;
      color: #0f766e;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .item-dot.active { background: #0d9488; color: white; border-color: #0d9488; }
    .item-dot.done   { background: #d1fae5; border-color: #6ee7b7; }

    /* Phase badge */
    .phase-badge {
      display: inline-block;
      padding: 6px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .phase-listening { background: #dbeafe; color: #1e3a8a; }
    .phase-recording { background: #fee2e2; color: #991b1b; }
    .phase-done      { background: #d1fae5; color: #065f46; }

    /* Audio card â€” hides the question text until revealed */
    .audio-card {
      background: #f0fdfa;
      border: 2px solid #99f6e4;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      margin-bottom: 24px;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .play-icon {
      font-size: 3.5rem;
      animation: bounce 1s ease infinite alternate;
    }
    @keyframes bounce {
      from { transform: translateY(0); }
      to   { transform: translateY(-6px); }
    }

    .audio-label {
      font-size: 1rem;
      color: #0f766e;
      font-weight: 600;
    }

    /* Hidden question reveal (after attempt) */
    .question-reveal {
      background: #ecfdf5;
      border: 2px dashed #6ee7b7;
      border-radius: 12px;
      padding: 16px 24px;
      margin-top: 16px;
      display: none;
    }
    .question-reveal .ref-label { font-size: 0.78rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; }
    .question-reveal .ref-text  { font-size: 1.3rem; color: #134e4a; font-weight: 500; }
    .question-reveal .intonation-tip {
      margin-top: 8px;
      font-size: 0.88rem;
      color: #0f766e;
      background: #d1fae5;
      border-radius: 8px;
      padding: 6px 12px;
      display: inline-block;
    }

    /* Countdown + waveform */
    .countdown-wrap { text-align: center; margin: 16px 0; }
    .countdown-num {
      font-size: 4rem;
      font-weight: 800;
      color: #0d9488;
      line-height: 1;
      transition: color 0.3s;
    }
    .countdown-label { font-size: 0.9rem; color: #6b7280; margin-top: 6px; }

    .waveform-wrap { margin: 12px 0; }
    .waveform-wrap canvas {
      width: 100%;
      height: 56px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 26px;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-teal  { background: #0d9488; color: white; }
    .btn-teal:hover:not(:disabled) { background: #0f766e; transform: translateY(-1px); }
    .btn-gray  { background: #e5e7eb; color: #374151; }
    .btn-gray:hover:not(:disabled) { background: #d1d5db; }

    .btn-record {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: none;
      background: #ef4444;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .btn-record.pulsing { animation: pulse-ring 1.2s ease-out infinite; }
    .btn-record:disabled { opacity: 0.35; cursor: not-allowed; animation: none; }

    @keyframes pulse-ring {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      70%  { box-shadow: 0 0 0 18px rgba(239,68,68,0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }

    .action-row {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
      margin: 18px 0;
    }
    .center { justify-content: center; }

    .spinner {
      display: inline-block;
      width: 22px; height: 22px;
      border: 3px solid #d1fae5;
      border-top-color: #0d9488;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-row { display: flex; align-items: center; gap: 10px; color: #0f766e; font-weight: 600; margin: 16px 0; }

    /* Results */
    .result-card {
      background: white;
      border: 2px solid #d1fae5;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }
    .result-card h3 { color: #065f46; font-size: 1.15rem; margin-bottom: 18px; }

    .score-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }
    .score-box {
      background: #f0fdfa;
      border: 1px solid #99f6e4;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    .score-box .val { font-size: 2rem; font-weight: 800; color: #0d9488; line-height: 1; }
    .score-box .lbl { font-size: 0.78rem; color: #6b7280; margin-top: 4px; }

    /* Diff display */
    .diff-words {
      font-size: 1.15rem;
      line-height: 2.2;
      background: #f8fafc;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .diff-words span { display: inline-block; margin: 2px 4px; padding: 2px 8px; border-radius: 6px; }
    .word-correct     { background: #d1fae5; color: #065f46; }
    .word-substituted { background: #fee2e2; color: #991b1b; text-decoration: line-through; }
    .word-deleted     { background: #fef3c7; color: #92400e; font-style: italic; }
    .word-inserted    { background: #ede9fe; color: #4c1d95; }

    .transcript-box {
      background: #f1f5f9;
      border-radius: 10px;
      padding: 14px;
      font-size: 1rem;
      color: #334155;
      margin-top: 12px;
    }
    .transcript-box .label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }

    .feedback-list { list-style: none; margin-top: 14px; }
    .feedback-list li {
      padding: 7px 0;
      border-bottom: 1px solid #f0fdf4;
      color: #374151;
      font-size: 0.93rem;
      display: flex;
      gap: 8px;
    }
    .feedback-list li:last-child { border-bottom: none; }

    .section-divider { border: none; border-top: 1px solid #e5e7eb; margin: 24px 0; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>ğŸ” è¤‡èª¦ç·´ç¿’</h1>
    <p>ç¬¬ä¸€éƒ¨åˆ† â€” è¤‡èª¦ï½œGEPT åˆç´šå£èªªæ¸¬é©—</p>
    <div class="nav-bar">
      <a href="essay_grader.html">âœï¸ å¯«ä½œè©•åˆ†</a>
      <a href="speaking_part1.html" class="active">ğŸ” è¤‡èª¦ç·´ç¿’</a>
      <a href="speaking_part2.html">ğŸ“– æœ—è®€ç·´ç¿’</a>
      <a href="speaking_part3.html">ğŸ’¬ å›ç­”å•é¡Œ</a>
      <a href="speaking_mock.html">ğŸ¯ å®Œæ•´æ¨¡æ“¬</a>
    </div>
  </div>

  <div class="main">

    <!-- Set selector -->
    <div class="controls-row">
      <label>è©¦å·çµ„ï¼š</label>
      <select id="setSelect" onchange="loadSet()"></select>
      <button class="btn btn-gray" onclick="prevItem()" id="btnPrev">â† ä¸Šé¡Œ</button>
      <button class="btn btn-gray" onclick="nextItem()" id="btnNext">ä¸‹é¡Œ â†’</button>
    </div>

    <!-- Item dots -->
    <div class="item-dots" id="itemDots"></div>

    <!-- Phase badge -->
    <div id="phaseBadge" class="phase-badge phase-listening">ğŸ”Š æ’­æ”¾ä¸­</div>

    <!-- Audio card (all phases show this, question hidden until done) -->
    <div class="audio-card" id="audioCard">
      <div class="play-icon" id="playIcon">ğŸ”Š</div>
      <div class="audio-label" id="audioLabel">æº–å‚™æ’­æ”¾é¡Œç›®â€¦</div>
    </div>

    <!-- Question reveal (shown after recording) -->
    <div class="question-reveal" id="questionReveal">
      <div class="ref-label">åƒè€ƒç­”æ¡ˆï¼ˆé¡Œç›®åŸæ–‡ï¼‰</div>
      <div class="ref-text" id="refText">â€”</div>
      <div class="intonation-tip" id="intonationTip">â€”</div>
    </div>

    <!-- Listening phase -->
    <div id="phaseListening">
      <div class="loading-row"><span class="spinner"></span> <span id="listenLabel">æ­£åœ¨ç”¢ç”ŸéŸ³é »â€¦</span></div>
    </div>

    <!-- Ready to repeat -->
    <div id="phaseReady" class="hidden">
      <div class="action-row center">
        <button class="btn btn-teal" onclick="startRepeat()" id="btnRepeat">ğŸ™ï¸ é–‹å§‹è¤‡èª¦</button>
      </div>
      <p style="text-align:center;color:#6b7280;font-size:0.88rem">è½å®Œå…©éå¾Œï¼Œé»ä¸Šæ–¹æŒ‰éˆ•ç«‹å³è¤‡èª¦</p>
    </div>

    <!-- Recording phase (countdown + waveform) -->
    <div id="phaseRecording" class="hidden">
      <div class="countdown-wrap">
        <div class="countdown-num" id="recCountdown">5</div>
        <div class="countdown-label">ç§’å…§è¤‡èª¦å¥å­</div>
      </div>
      <div class="waveform-wrap">
        <canvas id="waveformCanvas" width="740" height="56"></canvas>
      </div>
      <div class="action-row center">
        <button class="btn-record pulsing" id="btnStop" onclick="stopNow()">â¹</button>
      </div>
    </div>

    <!-- Processing -->
    <div id="phaseProcessing" class="hidden">
      <div class="loading-row"><span class="spinner"></span> è¾¨è­˜èªéŸ³ä¸­â€¦</div>
    </div>

    <!-- Results -->
    <div id="phaseResults" class="hidden">
      <div class="result-card">
        <h3>ğŸ“Š è¤‡èª¦åˆ†æå ±å‘Š</h3>

        <div class="score-grid">
          <div class="score-box">
            <div class="val" id="scoreAccuracy">â€”</div>
            <div class="lbl">å­—è©æº–ç¢ºç‡</div>
          </div>
          <div class="score-box">
            <div class="val" id="scoreErrors">â€”</div>
            <div class="lbl">éŒ¯èª¤å­—æ•¸</div>
          </div>
          <div class="score-box">
            <div class="val" id="scoreIntonation">â€”</div>
            <div class="lbl">èªèª¿æ–¹å‘</div>
          </div>
          <div class="score-box" style="border-color:#0d9488">
            <div class="val" id="scoreA" style="color:#0f766e">â€”</div>
            <div class="lbl">è©•åˆ†Aï¼šç™¼éŸ³æµåˆ©åº¦ (0â€“5)</div>
          </div>
        </div>

        <h4 style="color:#374151;margin-bottom:10px">å­—è©å°ç…§</h4>
        <div class="diff-words" id="diffWords"></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;font-size:0.82rem">
          <span><span style="background:#d1fae5;padding:2px 6px;border-radius:4px">ç¶ è‰²</span> æ­£ç¢º</span>
          <span><span style="background:#fee2e2;padding:2px 6px;border-radius:4px">ç´…è‰²</span> èªªéŒ¯</span>
          <span><span style="background:#fef3c7;padding:2px 6px;border-radius:4px">é»ƒè‰²</span> æ¼èªª</span>
          <span><span style="background:#ede9fe;padding:2px 6px;border-radius:4px">ç´«è‰²</span> å¤šèªª</span>
        </div>

        <div class="transcript-box">
          <div class="label">ä½ èªªçš„å…§å®¹ï¼ˆWhisper è¾¨è­˜ï¼‰</div>
          <div id="transcriptText">â€”</div>
        </div>

        <!-- GPT Score A feedback -->
        <div style="margin-top:16px">
          <h4 style="color:#0f766e;font-size:0.92rem;margin-bottom:8px">ğŸ™ï¸ è©•åˆ†A â€” ç™¼éŸ³ã€èªèª¿ã€æµåˆ©åº¦ï¼ˆGPT è©•ä¼°ï¼‰</h4>
          <div id="feedbackA" style="background:#f0fdfa;border-radius:10px;padding:14px;font-size:0.93rem;color:#134e4a;line-height:1.6">è©•ä¼°ä¸­â€¦</div>
        </div>

        <ul class="feedback-list" id="feedbackList"></ul>
      </div>

      <hr class="section-divider">
      <div class="action-row">
        <button class="btn btn-teal" onclick="replayAndRetry()">ğŸ”Š é‡è½ + å†è©¦</button>
        <button class="btn btn-gray" onclick="nextItem()">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
    </div>

  </div>
</div>

<script src="speaking-utils.js"></script>
<script>
const BANK_URL = 'https://kniph.github.io/question-bank.json';
let bank = null;
let currentSet = null;
let currentItems = [];
let currentIdx = 0;
let recStopFn = null;
let recordingPromise = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const resp = await fetch(BANK_URL);
    bank = await resp.json();
    populateSetSelect();
    loadSet();
  } catch (e) {
    document.getElementById('audioLabel').textContent = 'âš ï¸ ç„¡æ³•è¼‰å…¥é¡Œåº«ï¼š' + e.message;
  }
}

function populateSetSelect() {
  const sel = document.getElementById('setSelect');
  sel.innerHTML = '';
  bank.sets.forEach(s => {
    const has = s.part1 && s.part1.length > 0;
    const opt = document.createElement('option');
    opt.value = s.set_id;
    opt.textContent = s.set_name + (has ? '' : ' (å°šæœªæ”¶éŒ„)');
    opt.disabled = !has;
    sel.appendChild(opt);
  });
  const first = bank.sets.find(s => s.part1 && s.part1.length > 0);
  if (first) sel.value = first.set_id;
}

function loadSet() {
  const setId = document.getElementById('setSelect').value;
  currentSet = bank.sets.find(s => s.set_id === setId);
  currentItems = currentSet ? currentSet.part1 : [];
  currentIdx = 0;
  renderDots();
  loadItem();
}

function renderDots() {
  const container = document.getElementById('itemDots');
  container.innerHTML = '';
  currentItems.forEach((_, i) => {
    const d = document.createElement('div');
    d.className = 'item-dot' + (i === currentIdx ? ' active' : '');
    d.textContent = i + 1;
    d.onclick = () => { currentIdx = i; loadItem(); };
    container.appendChild(d);
  });
}

// â”€â”€ Load & play item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadItem() {
  resetUI();
  renderDots();

  const item = currentItems[currentIdx];
  if (!item) {
    document.getElementById('audioLabel').textContent = 'æ­¤çµ„æš«ç„¡é¡Œç›®';
    return;
  }

  setBadge('listening');
  document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ / å…± ${currentItems.length} é¡Œ â€” æ’­æ”¾ä¸­ (ç¬¬ 1 é)`;
  document.getElementById('listenLabel').textContent = 'æ­£åœ¨ç”¢ç”ŸéŸ³é »â€¦';
  show('phaseListening');

  try {
    document.getElementById('playIcon').textContent = 'ğŸ”Š';
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” æ’­æ”¾ä¸­ (ç¬¬ 1 é)`;

    // Play twice via SpeakingUtils (1.5 s gap handled internally)
    // We want to show "ç¬¬2é" between plays â€” so call once for each
    await SpeakingUtils.playTTS(item.text, 'nova', 1);
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” é–“éš”ä¸­â€¦`;
    await new Promise(r => setTimeout(r, 1500));
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” æ’­æ”¾ä¸­ (ç¬¬ 2 é)`;
    await SpeakingUtils.playTTS(item.text, 'nova', 1);

    // Done listening
    hide('phaseListening');
    document.getElementById('audioLabel').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ â€” è½å®Œäº†ï¼Œè«‹ç«‹å³è¤‡èª¦`;
    document.getElementById('playIcon').textContent = 'ğŸ™ï¸';
    show('phaseReady');
    setBadge('ready');

  } catch (err) {
    hide('phaseListening');
    document.getElementById('audioLabel').textContent = 'âš ï¸ TTS å¤±æ•—ï¼š' + err.message;
  }
}

// â”€â”€ Recording â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startRepeat() {
  hide('phaseReady');
  show('phaseRecording');
  setBadge('recording');

  const canvas = document.getElementById('waveformCanvas');
  recordingPromise = SpeakingUtils.startRecording(5, canvas);

  const countdown = document.getElementById('recCountdown');
  recStopFn = SpeakingUtils.startCountdown(countdown, 5, () => stopNow());
}

async function stopNow() {
  if (recStopFn) { recStopFn(); recStopFn = null; }
  SpeakingUtils.stopRecording();
  hide('phaseRecording');
  show('phaseProcessing');

  try {
    const { base64 } = await recordingPromise;
    const item = currentItems[currentIdx];
    const { text, words } = await SpeakingUtils.transcribe(base64, item.text);
    showResults(text, item);
  } catch (err) {
    hide('phaseProcessing');
    alert('è¾¨è­˜å¤±æ•—ï¼š' + err.message);
    resetUI();
    loadItem();
  }
}

// â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResults(transcript, item) {
  hide('phaseProcessing');
  show('phaseResults');
  setBadge('done');

  // Reveal reference text
  const reveal = document.getElementById('questionReveal');
  reveal.style.display = 'block';
  document.getElementById('refText').textContent = item.text;

  const intType = item.intonation || SpeakingUtils.detectIntonationType(item.text);
  const intLabel = intType === 'rising' ? 'â†‘ èªèª¿ä¸Šæšï¼ˆYes/No å•å¥ï¼‰' : 'â†“ èªèª¿ä¸‹é™ï¼ˆé™³è¿°å¥ / Wh- å•å¥ï¼‰';
  document.getElementById('intonationTip').textContent = 'èªèª¿æç¤ºï¼š' + intLabel;

  // Diff
  const diff = SpeakingUtils.wordDiff(item.text, transcript);
  const accuracy = SpeakingUtils.calcAccuracy(diff);
  const errorCount = diff.filter(d => d.status !== 'correct' && d.status !== 'inserted').length;

  document.getElementById('scoreAccuracy').textContent = accuracy + '%';
  document.getElementById('scoreErrors').textContent = errorCount;
  document.getElementById('scoreIntonation').textContent = intType === 'rising' ? 'â†‘' : 'â†“';
  document.getElementById('scoreA').textContent = 'â€¦';

  const diffEl = document.getElementById('diffWords');
  diffEl.innerHTML = diff.map(d => {
    const cls = {
      correct: 'word-correct',
      substituted: 'word-substituted',
      deleted: 'word-deleted',
      inserted: 'word-inserted'
    }[d.status];
    return `<span class="${cls}">${d.word}</span>`;
  }).join('');

  document.getElementById('transcriptText').textContent = transcript || 'ï¼ˆæœªè¾¨è­˜åˆ°èªéŸ³ï¼‰';

  // Mechanical feedback tips
  const tips = [];
  if (accuracy >= 95) tips.push('âœ… å®Œæ•´è¤‡èª¦ï¼Œæº–ç¢ºç‡å„ªç§€ï¼');
  else if (accuracy >= 80) tips.push('ğŸ‘ æº–ç¢ºç‡è‰¯å¥½ï¼Œæ³¨æ„ç´…è‰²å­—è©çš„ç™¼éŸ³ã€‚');
  else tips.push('âš ï¸ æº–ç¢ºç‡è¼ƒä½ï¼Œå»ºè­°å¤šæ¬¡é‡è½å¾Œå†è¤‡èª¦ã€‚');

  const omissions = diff.filter(d => d.status === 'deleted').length;
  const additions = diff.filter(d => d.status === 'inserted').length;
  if (omissions > 0) tips.push(`ğŸ“Œ æ¼èªªäº† ${omissions} å€‹å­—è©ï¼ŒçœŸå¯¦è€ƒè©¦ä¸­æ¼å­—æœƒæ‰£åˆ†ã€‚`);
  if (additions > 0) tips.push(`ğŸ“Œ å¤šèªªäº† ${additions} å€‹å­—è©ï¼Œè¤‡èª¦åªéœ€é‡è¤‡åŸå¥å³å¯ã€‚`);
  tips.push(`ğŸµ æœ¬å¥èªèª¿ï¼š${intLabel}`);

  const feedbackEl = document.getElementById('feedbackList');
  feedbackEl.innerHTML = tips.map(t => `<li>${t}</li>`).join('');

  // Mark dot done
  const dots = document.querySelectorAll('.item-dot');
  if (dots[currentIdx]) dots[currentIdx].classList.add('done');

  // Async: call /api/evaluate for official Score A
  const BACKEND = SpeakingUtils.BACKEND;
  fetch(`${BACKEND}/api/evaluate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ part: 1, transcript: transcript || '', reference: item.text })
  }).then(r => r.json()).then(ev => {
    document.getElementById('scoreA').textContent = ev.score_a !== null ? ev.score_a : 'â€”';
    document.getElementById('feedbackA').textContent = ev.feedback_a || ev.overall || 'â€”';
    if (ev.coaching) {
      feedbackEl.innerHTML += `<li>ğŸ’¡ ${ev.coaching}</li>`;
    }
  }).catch(() => {
    document.getElementById('scoreA').textContent = 'â€”';
    document.getElementById('feedbackA').textContent = 'ï¼ˆGPT è©•ä¼°ä¸å¯ç”¨ï¼‰';
  });
}

// â”€â”€ Navigation & helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function replayAndRetry() {
  document.getElementById('questionReveal').style.display = 'none';
  resetUI();
  await loadItem();
}

function prevItem() { if (currentIdx > 0) { currentIdx--; loadItem(); } }
function nextItem() { if (currentIdx < currentItems.length - 1) { currentIdx++; loadItem(); } }

function resetUI() {
  if (recStopFn) { recStopFn(); recStopFn = null; }
  SpeakingUtils.stopRecording();
  document.getElementById('questionReveal').style.display = 'none';
  hide('phaseListening');
  hide('phaseReady');
  hide('phaseRecording');
  hide('phaseProcessing');
  hide('phaseResults');
  document.getElementById('playIcon').textContent = 'ğŸ”Š';
  document.getElementById('audioLabel').textContent = 'æº–å‚™æ’­æ”¾â€¦';
}

function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }

function setBadge(phase) {
  const el = document.getElementById('phaseBadge');
  const map = {
    listening: ['phase-listening', 'ğŸ”Š æ’­æ”¾ä¸­'],
    ready:     ['phase-listening', 'ğŸ™ï¸ æº–å‚™è¤‡èª¦'],
    recording: ['phase-recording', 'ğŸ”´ éŒ„éŸ³ä¸­'],
    done:      ['phase-done',      'âœ… åˆ†æå®Œæˆ']
  };
  el.className = 'phase-badge ' + map[phase][0];
  el.textContent = map[phase][1];
}

init();
</script>
</body>
</html>
