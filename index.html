<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文寫作自動批改系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section, .output-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results {
            display: none;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .score-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .feedback-category {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4facfe;
        }

        .category-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .feedback-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #28a745;
        }

        .feedback-item.warning {
            border-left-color: #ffc107;
        }

        .feedback-item.error {
            border-left-color: #dc3545;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sentence-error {
            background: #fff2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #dc3545;
        }

        .sentence-original {
            background: #fef2f2;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .sentence-corrected {
            background: #f0f9ff;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #0066cc;
            font-family: 'Courier New', monospace;
        }

        .corrected-essay {
            background: #f8fff8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* 新增拍照功能樣式 */
        .input-options {
            width: 100%;
        }

        .input-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
        }

        .tab-btn:hover {
            color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .input-mode {
            display: none;
        }

        .input-mode.active {
            display: block;
        }

        .camera-container {
            border: 2px dashed #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            position: relative;
        }

        .camera-interface {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .camera-placeholder {
            margin-bottom: 20px;
            color: #666;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        #cameraPreview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .photo-preview {
            text-align: center;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }

        .photo-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .ocr-result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .ocr-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            min-height: 100px;
            border: 1px solid #e1e5e9;
            white-space: pre-wrap;
        }

        .ocr-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .loading-ocr {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .spinner-small {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @media (max-width: 768px) {
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .tab-btn {
                font-size: 12px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 英文寫作自動批改系統</h1>
            <p>智能分析學生寫作，提供專業建議與評分</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">📋 輸入寫作內容</h2>
                
                <div class="form-group">
                    <label for="studentName">學生姓名：</label>
                    <input type="text" id="studentName" placeholder="請輸入學生姓名">
                </div>

                <div class="form-group">
                    <label for="assignmentType">作業類型：</label>
                    <select id="assignmentType">
                        <option value="essay">議論文 (Essay)</option>
                        <option value="narrative">記敘文 (Narrative)</option>
                        <option value="descriptive">描述文 (Descriptive)</option>
                        <option value="letter">書信 (Letter)</option>
                        <option value="report">報告 (Report)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="gradeLevel">GEPT 程度：</label>
                    <select id="gradeLevel">
                        <option value="elementary">GEPT 初級 (Elementary)</option>
                        <option value="intermediate">GEPT 中級 (Intermediate)</option>
                        <option value="high-intermediate">GEPT 中高級 (High-Intermediate)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="essayContent">寫作內容：</label>
                    <div class="input-options">
                        <div class="input-tabs">
                            <button type="button" class="tab-btn active" onclick="switchInputMode('text')">📝 文字輸入</button>
                            <button type="button" class="tab-btn" onclick="switchInputMode('camera')">📷 拍照上傳</button>
                        </div>
                        
                        <div id="textInput" class="input-mode active">
                            <textarea id="essayContent" placeholder="請貼上學生的英文寫作內容...">Yin Yin has a lots of work to do. In weekday, She was work in a moving company, but she has a favorite work in weekend. It is a music action. She was good at this work.</textarea>
                        </div>
                        
                        <div id="cameraInput" class="input-mode">
                            <div class="camera-container">
                                <video id="cameraPreview" autoplay playsinline style="display: none;"></video>
                                <canvas id="photoCanvas" style="display: none;"></canvas>
                                <button type="button" class="btn" onclick="capturePhoto()" id="captureBtn" style="display: none;">📸 拍照</button>
                                <div id="photoPreview" class="photo-preview" style="display: none;">
                                    <img id="capturedImage" alt="拍攝的照片">
                                    <div class="photo-actions">
                                        <button type="button" class="btn btn-secondary" onclick="retakePhoto()">🔄 重新拍攝</button>
                                        <button type="button" class="btn btn-primary" onclick="processImage()">🔍 識別文字</button>
                                    </div>
                                </div>
                                <div id="cameraInterface" class="camera-interface">
                                    <div class="camera-placeholder">
                                        <p>📷 點擊下方按鈕開啟相機</p>
                                    </div>
                                    <div class="camera-controls">
                                        <button type="button" class="btn" onclick="startCamera()">📷 開啟相機</button>
                                        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">📁 選擇照片</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="ocrResult" class="ocr-result" style="display: none;">
                                <h4>📝 識別結果：</h4>
                                <div class="ocr-text" id="recognizedText"></div>
                                <div class="ocr-actions">
                                    <button type="button" class="btn" onclick="useOcrText()">✅ 使用此文字</button>
                                    <button type="button" class="btn btn-secondary" onclick="editOcrText()">✏️ 手動編輯</button>
                                    <button type="button" class="btn btn-secondary" onclick="skipOcrManualInput()">📝 跳過識別，手動輸入</button>
                                </div>
                            </div>
                            
                            <div id="loadingOcr" class="loading-ocr" style="display: none;">
                                <div class="spinner-small"></div>
                                <p>正在識別文字內容，請稍候...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="analyzeEssay()">🔍 開始批改</button>
            </div>

            <div class="output-section">
                <h2 class="section-title">📊 批改結果</h2>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>正在分析寫作內容，請稍候...</p>
                </div>

                <div class="results" id="results">
                    <div class="score-display">
                        <div class="score-number" id="overallScore">3</div>
                        <div class="score-label">GEPT 級分 (滿分5分)</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="wordCount">0</div>
                            <div class="stat-label">字數</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="sentenceCount">0</div>
                            <div class="stat-label">句數</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="paragraphCount">0</div>
                            <div class="stat-label">段落數</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="avgWordsPerSentence">0</div>
                            <div class="stat-label">平均句長</div>
                        </div>
                    </div>

                    <div id="feedbackContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入OCR庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <script>
        // 完整的語法規則檢查（調整為更符合官方標準）
        const grammarRules = {
            // 主詞動詞一致性
            subjectVerbAgreement: [
                {pattern: /\b(he|she|it)\s+(are|have|do)\b/gi, message: "主詞動詞不一致：he/she/it 應該搭配 is/has/does", correction: (match) => match.replace(/(he|she|it)\s+(are|have|do)/gi, (m, subj, verb) => subj + ' ' + (verb === 'are' ? 'is' : verb === 'have' ? 'has' : 'does'))},
                {pattern: /\b(they|we|you)\s+(is|has|does)\b/gi, message: "主詞動詞不一致：they/we/you 應該搭配 are/have/do", correction: (match) => match.replace(/(they|we|you)\s+(is|has|does)/gi, (m, subj, verb) => subj + ' ' + (verb === 'is' ? 'are' : verb === 'has' ? 'have' : 'do'))},
                {pattern: /\bthey\s+eats\b/gi, message: "主詞動詞不一致：they 應該搭配 eat", correction: (match) => match.replace(/they\s+eats/gi, 'they eat')},
                {pattern: /\b(I)\s+(are|is)\b/gi, message: "主詞動詞不一致：I 應該搭配 am", correction: (match) => match.replace(/I\s+(are|is)/gi, 'I am')}
            ],
            
            // 冠詞和量詞錯誤
            articles: [
                {pattern: /\ba\s+lots\s+of\b/gi, message: "冠詞錯誤：應該使用 'a lot of' 或 'lots of'", correction: (match) => match.replace(/a\s+lots\s+of/gi, 'a lot of')},
                {pattern: /\ba\s+([aeiou])/gi, message: "冠詞錯誤：母音前應使用 'an'", correction: (match) => match.replace(/\ba\s+([aeiou])/gi, 'an $1')},
                {pattern: /\ban\s+([bcdfghjklmnpqrstvwxyz])/gi, message: "冠詞錯誤：子音前應使用 'a'", correction: (match) => match.replace(/\ban\s+([bcdfghjklmnpqrstvwxyz])/gi, 'a $1')}
            ],
            
            // 動詞形式錯誤
            verbForms: [
                {pattern: /\bwas\s+work\b/gi, message: "動詞形式錯誤：應該使用 'worked' 或 'was working'", correction: (match) => match.replace(/was\s+work/gi, 'worked')},
                {pattern: /\bcalls\s+her\s+getting\s+up\b/gi, message: "動詞用法錯誤：應該使用 'calls her to get up'", correction: (match) => match.replace(/calls\s+her\s+getting\s+up/gi, 'calls her to get up')},
                {pattern: /\blook\s+a\s+lot\s+of\b/gi, message: "動詞用法錯誤：應該使用 'see a lot of' 或 'look at a lot of'", correction: (match) => match.replace(/look\s+a\s+lot\s+of/gi, 'see a lot of')}
            ],
            
            // 介系詞錯誤
            prepositions: [
                {pattern: /\b(In|On)\s+weekday\b/gi, message: "介系詞錯誤：應該使用 'On weekdays' (複數)", correction: (match) => match.replace(/(In|On)\s+weekday/gi, 'On weekdays')},
                {pattern: /\bin\s+weekend\b/gi, message: "介系詞錯誤：應該使用 'on weekends' 或 'at the weekend'", correction: (match) => match.replace(/in\s+weekend/gi, 'on weekends')},
                {pattern: /\bgood\s+at\s+this\s+work\b/gi, message: "介系詞用法：建議使用 'good at this job'", correction: (match) => match.replace(/good\s+at\s+this\s+work/gi, 'good at this job')}
            ],
            
            // 詞彙使用錯誤
            vocabulary: [
                {pattern: /\bmusic\s+action\b/gi, message: "詞彙錯誤：應該使用 'musical activity' 或 'music performance'", correction: (match) => match.replace(/music\s+action/gi, 'musical activity')},
                {pattern: /\brestaurent\b/gi, message: "拼字錯誤：正確拼法是 'restaurant'", correction: (match) => match.replace(/restaurent/gi, 'restaurant')},
                {pattern: /\bdelicous\b/gi, message: "拼字錯誤：正確拼法是 'delicious'", correction: (match) => match.replace(/delicous/gi, 'delicious')}
            ],
            
            // 句子結構問題
            sentenceStructure: [
                {pattern: /\bcalls\s+her\s+getting\s+up\s+really\b/gi, message: "句子結構錯誤：應該使用 'calls her to get up'", correction: (match) => match.replace(/calls\s+her\s+getting\s+up\s+really/gi, 'calls her to get up')},
                {pattern: /^\s*Because\s+[^.!?]*[.!?]\s*$/gim, message: "句子不完整：Because 引導的從屬子句需要主要子句", correction: (match) => match}
            ]
        };

        // 轉折詞清單
        const transitionWords = ['however', 'moreover', 'furthermore', 'therefore', 'consequently', 'nevertheless', 'additionally', 'in contrast', 'on the other hand', 'as a result', 'first', 'second', 'third', 'finally', 'in conclusion', 'for example', 'for instance', 'in addition', 'besides', 'meanwhile', 'although', 'despite', 'whereas', 'similarly', 'likewise'];

        // 相機和OCR相關變量
        let currentStream = null;
        let capturedImageData = null;

        // 輸入模式切換
        function switchInputMode(mode) {
            // 切換標籤激活狀態
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 切換輸入區域
            document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
            document.getElementById(mode === 'text' ? 'textInput' : 'cameraInput').classList.add('active');
            
            // 停止相機（如果正在使用）
            if (mode === 'text' && currentStream) {
                stopCamera();
            }
        }

        // 開啟相機
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // 使用後置鏡頭
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraPreview');
                video.srcObject = currentStream;
                video.style.display = 'block';
                
                // 等待視頻載入後再顯示拍照按鈕
                video.onloadedmetadata = function() {
                    document.getElementById('cameraInterface').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'inline-block';
                };
                
            } catch (error) {
                console.error('無法訪問相機:', error);
                alert('無法開啟相機，請檢查設備權限或選擇上傳照片。錯誤：' + error.message);
            }
        }

        // 停止相機
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            const video = document.getElementById('cameraPreview');
            video.style.display = 'none';
            document.getElementById('cameraInterface').style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
        }

        // 拍照
        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            // 設置canvas尺寸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // 將視頻幀繪製到canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 獲取圖像數據
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // 顯示預覽
            showPhotoPreview(capturedImageData);
            
            // 停止相機
            stopCamera();
        }

        // 處理文件選擇
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedImageData = e.target.result;
                    showPhotoPreview(capturedImageData);
                };
                reader.readAsDataURL(file);
            }
        }

        // 顯示照片預覽
        function showPhotoPreview(imageData) {
            const img = document.getElementById('capturedImage');
            img.src = imageData;
            
            document.getElementById('cameraInterface').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'block';
        }

        // 重新拍攝
        function retakePhoto() {
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('cameraInterface').style.display = 'block';
            document.getElementById('ocrResult').style.display = 'none';
            capturedImageData = null;
        }

        // 處理圖像OCR
        async function processImage() {
            if (!capturedImageData) {
                alert('請先拍攝或選擇照片');
                return;
            }
            
            document.getElementById('loadingOcr').style.display = 'block';
            
            try {
                // 使用Tesseract.js進行OCR識別
                const text = await performOCR(capturedImageData);
                document.getElementById('recognizedText').textContent = text;
                document.getElementById('ocrResult').style.display = 'block';
                document.getElementById('loadingOcr').style.display = 'none';
            } catch (error) {
                console.error('OCR識別失敗:', error);
                document.getElementById('loadingOcr').style.display = 'none';
                alert('文字識別失敗，請重新拍攝或手動輸入文字。');
            }
        }

        // Google Vision API設定 - 請替換為您的API金鑰
        const GOOGLE_VISION_API_KEY = 'AIzaSyC_aGiEVd9oYiDZcQMXavb9kXYmnNHljdk'; // 請替換為您的實際API金鑰
        
        // OCR識別函數（使用Google Vision API）
        async function performOCR(imageData) {
            // 檢查API金鑰是否設定
            if (GOOGLE_VISION_API_KEY === 'YOUR_API_KEY_HERE') {
                alert('請先設定Google Vision API金鑰！\n\n請將程式碼中的 YOUR_API_KEY_HERE 替換為您的實際API金鑰。');
                return showManualInputFallback();
            }
            
            try {
                // 使用Google Vision API進行OCR識別
                const visionResult = await callGoogleVisionAPI(imageData);
                if (visionResult && visionResult.trim()) {
                    return visionResult;
                }
                
                // 如果Google Vision失敗，回退到Tesseract.js
                console.log('Google Vision API無結果，嘗試使用Tesseract.js...');
                return await fallbackToTesseract(imageData);
                
            } catch (error) {
                console.error('Google Vision API錯誤:', error);
                
                // 錯誤處理：嘗試Tesseract.js作為備用
                try {
                    console.log('回退到Tesseract.js...');
                    return await fallbackToTesseract(imageData);
                } catch (tesseractError) {
                    console.error('Tesseract.js也失敗:', tesseractError);
                    return showManualInputFallback();
                }
            }
        }

        // Google Vision API調用
        async function callGoogleVisionAPI(imageData) {
            // 將base64圖片轉換為Google Vision API需要的格式
            const base64Image = imageData.split(',')[1]; // 移除data:image/jpeg;base64,前綴
            
            const requestBody = {
                requests: [{
                    image: {
                        content: base64Image
                    },
                    features: [{
                        type: 'TEXT_DETECTION',
                        maxResults: 1
                    }]
                }]
            };

            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Google Vision API錯誤: ${response.status} - ${errorData.error?.message || '未知錯誤'}`);
            }

            const data = await response.json();
            
            // 檢查是否有識別結果
            if (data.responses && data.responses[0] && data.responses[0].textAnnotations) {
                const detectedText = data.responses[0].textAnnotations[0].description;
                
                // 清理識別結果
                const cleanedText = detectedText
                    .replace(/\n+/g, ' ') // 將換行轉為空格
                    .replace(/\s+/g, ' ') // 處理多餘空格
                    .trim();
                
                return cleanedText;
            }
            
            return null; // 沒有識別到文字
        }

        // Tesseract.js備用方案
        async function fallbackToTesseract(imageData) {
            const { data: { text } } = await Tesseract.recognize(
                imageData,
                'eng',
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            console.log(`備用OCR進度: ${Math.round(m.progress * 100)}%`);
                        }
                    },
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,!?;:\'" \n'
                }
            );
            
            return text.replace(/\s+/g, ' ').trim() || '未能識別到文字內容。';
        }

        // 備用方案：當OCR失敗時提供手動輸入
        function showManualInputFallback() {
            const manualText = prompt(
                'OCR識別失敗。請手動輸入您看到的英文內容：\n\n(提示: 可以只輸入前幾句，之後再手動補完)', 
                ''
            );
            return manualText || '請手動輸入文字內容。';
        }

        // 使用OCR文字
        function useOcrText() {
            const recognizedText = document.getElementById('recognizedText').textContent;
            document.getElementById('essayContent').value = recognizedText;
            
            // 切換回文字輸入模式
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[onclick*="text"]').classList.add('active');
            
            document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
            document.getElementById('textInput').classList.add('active');
            
            alert('文字已成功導入！您可以進一步編輯後開始批改。');
        }

        // 跳過OCR，直接手動輸入
        function skipOcrManualInput() {
            document.getElementById('essayContent').value = '';
            
            // 切換到文字輸入模式
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[onclick*="text"]').classList.add('active');
            
            document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
            document.getElementById('textInput').classList.add('active');
            
            alert('已切換到文字輸入模式，請直接在文字框中輸入內容。');
        }

        // 改進的手動編輯功能
        function editOcrText() {
            const recognizedText = document.getElementById('recognizedText').textContent;
            const editedText = prompt('請編輯或重新輸入文字內容：\n\n(提示: 如果識別錯誤太多，可以重新輸入)', recognizedText);
            
            if (editedText !== null) {
                document.getElementById('essayContent').value = editedText;
                
                // 切換到文字輸入模式
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[onclick*="text"]').classList.add('active');
                
                document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
                document.getElementById('textInput').classList.add('active');
                
                alert('文字已更新！您可以繼續編輯或開始批改。');
            }
        }

        function analyzeEssay() {
            try {
                let content = '';
                
                // 檢查當前輸入模式
                const activeMode = document.querySelector('.input-mode.active');
                if (activeMode.id === 'textInput') {
                    content = document.getElementById('essayContent').value.trim();
                } else {
                    // 如果在相機模式，檢查是否有OCR結果
                    const ocrText = document.getElementById('recognizedText').textContent;
                    if (ocrText) {
                        content = ocrText.trim();
                    } else {
                        alert('請先拍照並識別文字，或切換到文字輸入模式！');
                        return;
                    }
                }
                
                if (!content) {
                    alert('請輸入寫作內容！');
                    return;
                }

                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';

                setTimeout(() => {
                    const analysis = performAnalysis(content);
                    displayResults(analysis);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                }, 1500);
            } catch (error) {
                console.error('分析過程出錯:', error);
                alert('批改過程中發生錯誤，請重試。');
            }
        }

        function performAnalysis(content) {
            // 基本統計
            const words = content.toLowerCase().match(/\b\w+\b/g) || [];
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            
            const wordCount = words.length;
            const sentenceCount = sentences.length;
            const paragraphCount = paragraphs.length;
            const avgWordsPerSentence = Math.round(wordCount / sentenceCount) || 0;

            // 語法檢查
            const grammarErrors = checkGrammar(content, sentences);
            
            // 詞彙分析
            const vocabularyAnalysis = analyzeVocabulary(words);
            
            // 結構分析
            const structureAnalysis = analyzeStructure(content);
            
            // 逐句錯誤分析
            const sentenceErrors = analyzeSentenceErrors(sentences, content);
            
            // 生成修正版文章
            const correctedEssay = generateCorrectedEssay(content, sentenceErrors);
            
            // 計算總分
            const gradeLevel = document.getElementById('gradeLevel').value;
            const overallScore = calculateOverallScore(grammarErrors, vocabularyAnalysis, structureAnalysis, wordCount, gradeLevel);

            return {
                stats: { wordCount, sentenceCount, paragraphCount, avgWordsPerSentence },
                overallScore,
                grammarErrors,
                vocabularyAnalysis,
                structureAnalysis,
                sentenceErrors,
                correctedEssay
            };
        }

        function checkGrammar(content, sentences) {
            const errors = [];
            
            // 檢查各種語法規則
            Object.entries(grammarRules).forEach(([category, rules]) => {
                rules.forEach(rule => {
                    const matches = content.match(rule.pattern);
                    if (matches) {
                        matches.forEach(match => {
                            errors.push({
                                type: 'error',
                                category: category,
                                message: rule.message,
                                example: match,
                                correction: rule.correction ? rule.correction(match) : match
                            });
                        });
                    }
                });
            });

            // 檢查大小寫
            sentences.forEach((sentence, index) => {
                const trimmed = sentence.trim();
                if (trimmed && !/^[A-Z]/.test(trimmed)) {
                    errors.push({
                        type: 'warning',
                        category: 'capitalization',
                        message: '句子開頭應該大寫',
                        example: trimmed.substring(0, 20) + '...',
                        correction: trimmed.charAt(0).toUpperCase() + trimmed.slice(1)
                    });
                }
            });

            return errors;
        }

        function analyzeSentenceErrors(sentences, originalContent) {
            const sentenceErrors = [];
            
            sentences.forEach((sentence, index) => {
                const errors = [];
                const corrections = [];
                let correctedSentence = sentence.trim();

                // 檢查每個語法規則
                Object.entries(grammarRules).forEach(([category, rules]) => {
                    rules.forEach(rule => {
                        if (rule.pattern.test(sentence)) {
                            errors.push({
                                type: 'error',
                                message: rule.message,
                                category: category
                            });
                            
                            // 應用修正
                            if (rule.correction) {
                                correctedSentence = rule.correction(correctedSentence);
                            }
                        }
                    });
                });

                // 檢查大小寫
                if (sentence.trim() && !/^[A-Z]/.test(sentence.trim())) {
                    errors.push({
                        type: 'warning',
                        message: '句子開頭應該大寫',
                        category: 'capitalization'
                    });
                    correctedSentence = correctedSentence.charAt(0).toUpperCase() + correctedSentence.slice(1);
                }

                if (errors.length > 0 || correctedSentence !== sentence.trim()) {
                    sentenceErrors.push({
                        index: index + 1,
                        original: sentence.trim(),
                        errors: errors,
                        corrected: correctedSentence
                    });
                }
            });

            return sentenceErrors;
        }

        function generateCorrectedEssay(originalContent, sentenceErrors) {
            let correctedContent = originalContent;
            
            // 從後往前替換，避免索引位移
            for (let i = sentenceErrors.length - 1; i >= 0; i--) {
                const error = sentenceErrors[i];
                if (error.original !== error.corrected) {
                    correctedContent = correctedContent.replace(error.original, error.corrected);
                }
            }
            
            return correctedContent;
        }

        function analyzeVocabulary(words) {
            const uniqueWords = [...new Set(words)];
            const repetitiveWords = findRepetitiveWords(words);
            const transitionWordCount = words.filter(word => 
                transitionWords.includes(word.toLowerCase())
            ).length;

            return {
                uniqueWordRatio: ((uniqueWords.length / words.length) * 100).toFixed(1),
                repetitiveWords,
                transitionWordCount,
                vocabularyLevel: { basic: 0, intermediate: 0, advanced: 0 }
            };
        }

        function findRepetitiveWords(words) {
            const wordCount = {};
            words.forEach(word => {
                if (word.length > 3) {
                    wordCount[word] = (wordCount[word] || 0) + 1;
                }
            });

            return Object.entries(wordCount)
                .filter(([word, count]) => count > 2)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
        }

        function analyzeStructure(content) {
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            
            return {
                paragraphCount: paragraphs.length,
                hasIntroduction: paragraphs.length > 0,
                hasBodyParagraphs: paragraphs.length > 1,
                hasConclusion: paragraphs.length > 2,
                structureScore: Math.min(100, paragraphs.length * 30)
            };
        }

        function calculateOverallScore(grammarErrors, vocabularyAnalysis, structureAnalysis, wordCount, gradeLevel) {
            const grammarErrorCount = grammarErrors.filter(e => e.type === 'error').length;
            const grammarWarningCount = grammarErrors.filter(e => e.type === 'warning').length;
            const expectedWordCount = getExpectedWordCount(gradeLevel);
            
            // 根據官方GEPT標準調整評分（更貼近實際標準）
            
            // 0級分：字數過少或完全無法理解
            if (wordCount < 20 || wordCount < expectedWordCount * 0.3) {
                return 0;
            }
            
            // 5級分：幾乎無誤（允許1-2個小錯誤）
            if (grammarErrorCount === 0 && grammarWarningCount <= 2) {
                return 5;
            }
            
            // 4級分：有誤但不影響理解（允許2-3個錯誤）
            if (grammarErrorCount <= 3 && 
                wordCount >= expectedWordCount * 0.6 && 
                !hasSeriousGrammarIssues(grammarErrors)) {
                return 4;
            }
            
            // 3級分：有誤，稍影響理解（允許4-6個錯誤）
            if (grammarErrorCount <= 6 && 
                wordCount >= expectedWordCount * 0.5) {
                return 3;
            }
            
            // 2級分：有很多誤，須耐心解讀（7-10個錯誤）
            if (grammarErrorCount <= 10 && 
                wordCount >= expectedWordCount * 0.4) {
                return 2;
            }
            
            // 1級分：錯誤過多，嚴重影響理解
            if (wordCount >= expectedWordCount * 0.3) {
                return 1;
            }
            
            return 0;
        }
        
        function hasSeriousGrammarIssues(grammarErrors) {
            // 檢查是否有嚴重的語法問題（影響基本理解）
            const seriousErrors = grammarErrors.filter(error => 
                error.category === 'subjectVerbAgreement' || 
                error.category === 'tenseErrors' ||
                error.message.includes('無法理解')
            );
            return seriousErrors.length > 2;
        }

        function displayResults(analysis) {
            // 更新統計數據
            document.getElementById('overallScore').textContent = analysis.overallScore;
            document.getElementById('wordCount').textContent = analysis.stats.wordCount;
            document.getElementById('sentenceCount').textContent = analysis.stats.sentenceCount;
            document.getElementById('paragraphCount').textContent = analysis.stats.paragraphCount;
            document.getElementById('avgWordsPerSentence').textContent = analysis.stats.avgWordsPerSentence;

            // 清空並重新生成反饋
            const feedbackContainer = document.getElementById('feedbackContainer');
            feedbackContainer.innerHTML = '';

            // 逐句錯誤分析
            if (analysis.sentenceErrors && analysis.sentenceErrors.length > 0) {
                const sentenceSection = createSentenceErrorSection(analysis.sentenceErrors);
                feedbackContainer.appendChild(sentenceSection);
            } else {
                const noErrorSection = createNoErrorSection();
                feedbackContainer.appendChild(noErrorSection);
            }

            // 詞彙建議
            const vocabFeedback = generateVocabularyFeedback(analysis.vocabularyAnalysis);
            if (vocabFeedback.length > 0) {
                const vocabSection = createFeedbackSection('詞彙建議', vocabFeedback);
                feedbackContainer.appendChild(vocabSection);
            }

            // 結構建議
            const structureFeedback = generateStructureFeedback(analysis.structureAnalysis, analysis.stats.wordCount);
            if (structureFeedback.length > 0) {
                const structureSection = createFeedbackSection('結構建議', structureFeedback);
                feedbackContainer.appendChild(structureSection);
            }

            // 總體評價
            const overallFeedback = generateOverallFeedback(analysis.overallScore);
            const overallSection = createFeedbackSection('總體評價', overallFeedback);
            feedbackContainer.appendChild(overallSection);

            // 修正版文章
            if (analysis.correctedEssay && analysis.correctedEssay !== document.getElementById('essayContent').value.trim()) {
                const correctedSection = createCorrectedEssaySection(analysis.correctedEssay);
                feedbackContainer.appendChild(correctedSection);
            }
        }

        function createSentenceErrorSection(sentenceErrors) {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const title = document.createElement('div');
            title.className = 'category-title';
            title.textContent = '📝 逐句錯誤分析與修正建議';
            section.appendChild(title);

            sentenceErrors.forEach(error => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'sentence-error';

                const originalDiv = document.createElement('div');
                originalDiv.className = 'sentence-original';
                originalDiv.innerHTML = `<strong>第${error.index}句 (原文):</strong><br>"${error.original}"`;
                errorDiv.appendChild(originalDiv);

                if (error.errors.length > 0) {
                    const errorList = document.createElement('ul');
                    errorList.style.margin = '10px 0';
                    errorList.style.paddingLeft = '20px';
                    
                    error.errors.forEach(err => {
                        const li = document.createElement('li');
                        li.style.color = '#dc3545';
                        li.style.marginBottom = '5px';
                        li.textContent = `❌ ${err.message}`;
                        errorList.appendChild(li);
                    });
                    errorDiv.appendChild(errorList);
                }

                const correctedDiv = document.createElement('div');
                correctedDiv.className = 'sentence-corrected';
                correctedDiv.innerHTML = `<strong>✅ 修正建議:</strong><br>"${error.corrected}"`;
                errorDiv.appendChild(correctedDiv);

                section.appendChild(errorDiv);
            });

            return section;
        }

        function createNoErrorSection() {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const title = document.createElement('div');
            title.className = 'category-title';
            title.textContent = '📝 逐句錯誤分析與修正建議';
            section.appendChild(title);

            const noErrorDiv = document.createElement('div');
            noErrorDiv.style.cssText = `
                background: #d4edda;
                padding: 15px;
                border-radius: 8px;
                color: #155724;
                text-align: center;
            `;
            noErrorDiv.textContent = '🎉 太棒了！沒有發現明顯的語法錯誤。';
            section.appendChild(noErrorDiv);

            return section;
        }

        function createCorrectedEssaySection(correctedEssay) {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const title = document.createElement('div');
            title.className = 'category-title';
            title.textContent = '📄 修正後完整文章';
            section.appendChild(title);

            const essayDiv = document.createElement('div');
            essayDiv.className = 'corrected-essay';
            essayDiv.textContent = correctedEssay;
            section.appendChild(essayDiv);

            const copyButton = document.createElement('button');
            copyButton.textContent = '📋 複製修正版文章';
            copyButton.className = 'btn';
            copyButton.style.cssText = `
                margin-top: 10px;
                background: #28a745;
                font-size: 14px;
                padding: 10px 20px;
            `;
            copyButton.onclick = function() {
                try {
                    navigator.clipboard.writeText(correctedEssay).then(() => {
                        copyButton.textContent = '✅ 已複製！';
                        setTimeout(() => {
                            copyButton.textContent = '📋 複製修正版文章';
                        }, 2000);
                    }).catch(() => {
                        // 備用複製方法
                        const textArea = document.createElement('textarea');
                        textArea.value = correctedEssay;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        copyButton.textContent = '✅ 已複製！';
                        setTimeout(() => {
                            copyButton.textContent = '📋 複製修正版文章';
                        }, 2000);
                    });
                } catch (error) {
                    console.error('複製錯誤:', error);
                }
            };
            section.appendChild(copyButton);

            return section;
        }

        function createFeedbackSection(title, feedbackItems) {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const titleElement = document.createElement('div');
            titleElement.className = 'category-title';
            titleElement.textContent = title;
            section.appendChild(titleElement);

            if (feedbackItems && Array.isArray(feedbackItems)) {
                feedbackItems.forEach(item => {
                    const feedbackItem = document.createElement('div');
                    feedbackItem.className = `feedback-item ${item.type || 'info'}`;
                    feedbackItem.textContent = item.text || '';
                    section.appendChild(feedbackItem);
                });
            }

            return section;
        }

        function generateVocabularyFeedback(vocabularyAnalysis) {
            const feedback = [];
            
            if (parseFloat(vocabularyAnalysis.uniqueWordRatio) < 60) {
                feedback.push({
                    type: 'warning',
                    text: `詞彙重複率較高 (${vocabularyAnalysis.uniqueWordRatio}%)，建議使用更多樣的詞彙`
                });
            }

            if (vocabularyAnalysis.repetitiveWords.length > 0) {
                feedback.push({
                    type: 'warning',
                    text: `重複使用的詞彙: ${vocabularyAnalysis.repetitiveWords.map(([word, count]) => `${word}(${count}次)`).join(', ')}`
                });
            }

            if (vocabularyAnalysis.transitionWordCount === 0) {
                feedback.push({
                    type: 'error',
                    text: '缺乏轉折詞！建議使用連接詞來提高文章連貫性，如: however, moreover, therefore, for example 等'
                });
            }

            return feedback;
        }

        function generateStructureFeedback(structureAnalysis, wordCount) {
            const feedback = [];
            const gradeLevel = document.getElementById('gradeLevel').value;
            const expectedWords = getExpectedWordCount(gradeLevel);

            if (wordCount < expectedWords * 0.8) {
                feedback.push({
                    type: 'error',
                    text: `字數不足！${gradeLevel === 'elementary' ? '初級' : gradeLevel === 'intermediate' ? '中級' : '中高級'}建議字數為${expectedWords}字，目前只有${wordCount}字`
                });
            }

            if (structureAnalysis.paragraphCount === 1) {
                feedback.push({
                    type: 'warning',
                    text: '建議將文章分成多個段落，增加文章結構清晰度'
                });
            }

            if (!structureAnalysis.hasConclusion && gradeLevel !== 'elementary') {
                feedback.push({
                    type: 'warning',
                    text: '建議添加結論段落來總結全文'
                });
            }

            return feedback;
        }

        function generateOverallFeedback(score) {
            const feedback = [];
            const gradeLevel = document.getElementById('gradeLevel').value;
            
            if (gradeLevel === 'elementary') {
                if (score === 5) {
                    feedback.push({
                        type: 'success',
                        text: '5級分：正確表達題目之要求；文法、用字等幾乎無誤。'
                    });
                } else if (score === 4) {
                    feedback.push({
                        type: 'success',
                        text: '4級分：大致正確表達題目之要求；文法、用字等有誤，但不影響讀者之理解。'
                    });
                } else if (score === 3) {
                    feedback.push({
                        type: 'warning',
                        text: '3級分：大致回答題目之要求，但未能完全達意；文法、用字等有誤，稍影響讀者之理解。'
                    });
                } else if (score === 2) {
                    feedback.push({
                        type: 'warning',
                        text: '2級分：部分回答題目之要求，表達上有令人不解/誤解之處；文法、用字等皆有誤，讀者須耐心解讀。'
                    });
                } else if (score === 1) {
                    feedback.push({
                        type: 'error',
                        text: '1級分：僅回答1個問題或重點；文法、用字等錯誤過多，嚴重影響讀者之理解。'
                    });
                } else {
                    feedback.push({
                        type: 'error',
                        text: '0級分：未答、等同未答。'
                    });
                }
            } else if (gradeLevel === 'intermediate') {
                if (score === 5) {
                    feedback.push({
                        type: 'success',
                        text: '5級分 (60分)：寫作能力佳 - 內容適切表達題目要求，清楚有條理；組織甚佳；能靈活運用字彙及句型；文法、拼字或標點符號偶有錯誤。'
                    });
                } else if (score === 4) {
                    feedback.push({
                        type: 'success',
                        text: '4級分 (48分)：寫作能力可 - 內容符合題目要求，大致清楚；組織大致完整；能正確運用字彙及句型；文法、拼字或標點符號雖有錯誤，但不影響理解。'
                    });
                } else if (score === 3) {
                    feedback.push({
                        type: 'warning',
                        text: '3級分 (36分)：寫作能力有限 - 內容大致符合題目要求，但未完全達意；組織尚可；字彙及句型掌握不佳；文法、拼字、標點符號錯誤偏多，影響理解。'
                    });
                } else if (score === 2) {
                    feedback.push({
                        type: 'warning',
                        text: '2級分 (24分)：稍具寫作能力 - 內容局部符合題目要求，大多難以理解；組織不良；能運用的字彙及句型有限；文法、拼字、標點符號有許多錯誤。'
                    });
                } else if (score === 1) {
                    feedback.push({
                        type: 'error',
                        text: '1級分 (12分)：無寫作能力 - 內容未能符合題目要求，無法理解；缺乏組織；能運用的字彙及句型非常有限；文法、拼字、標點符號有過多錯誤。'
                    });
                } else {
                    feedback.push({
                        type: 'error',
                        text: '0級分 (0分)：未答/等同未答。'
                    });
                }
            } else {
                // 中高級評分
                if (score === 5) {
                    feedback.push({
                        type: 'success',
                        text: '5級分 (60分)：內容妥切表達題目要求，組織完整，全文連貫通順；能靈活且妥切的運用字彙及各類句型結構，鮮有錯誤。'
                    });
                } else if (score === 4) {
                    feedback.push({
                        type: 'success',
                        text: '4級分 (48分)：內容符合題目要求，組織完整，全文大致連貫；能正確的運用字彙及句型結構，但仍偶有錯誤。'
                    });
                } else if (score === 3) {
                    feedback.push({
                        type: 'warning',
                        text: '3級分 (36分)：內容大致符合題目要求，組織尚可，連貫性待加強；能夠運用常用字彙及基本句型結構，但使用較難的字彙或複雜句時常有錯誤。'
                    });
                } else if (score === 2) {
                    feedback.push({
                        type: 'warning',
                        text: '2級分 (24分)：內容僅能局部符合題目之要求，組織不完整且缺乏連貫性；字彙有限，運用基本句型結構常有錯誤，影響理解。'
                    });
                } else if (score === 1) {
                    feedback.push({
                        type: 'error',
                        text: '1級分 (12分)：內容未能符合題目要求，組織不良；字彙有限，運用基本句型結構有許多錯誤，大多難以理解。'
                    });
                } else {
                    feedback.push({
                        type: 'error',
                        text: '0級分 (0分)：未答/等同未答。文章過短 (少於40字)、無法評分、內容完全無法理解、完全離題。'
                    });
                }
            }

            return feedback;
        }

        function getExpectedWordCount(gradeLevel) {
            const expectations = {
                elementary: 50,        // GEPT初級建議字數
                intermediate: 120,     // GEPT中級建議字數
                'high-intermediate': 165 // GEPT中高級建議字數
            };
            return expectations[gradeLevel] || 50;
        }

        // 初始化範例
        window.onload = function() {
            try {
                const gradeSelect = document.getElementById('gradeLevel');
                const essayTextarea = document.getElementById('essayContent');
                
                function updateExample() {
                    try {
                        const level = gradeSelect.value;
                        if (level === 'elementary') {
                            essayTextarea.value = `Today is Sunday. Shiau-fang's mother goes to her room, and calls her getting up really. Because they will go to the zoo.

They look a lot of animals in the zoo. There are elephants, tigers and birds over there. So they have a very good time.

And then they eats dinner in a restaurent. They eat and talk there.`;
                        } else if (level === 'intermediate') {
                            essayTextarea.value = `When I get good grades or good at behavior, my parents usually say "This is your responsible, you should do well." or "That's not bad and make progress next time." They never give me money or gifts. I think that the way of encourage is great and reasonable. I sometimes feel that they are vitally strict to me.

If I am be mother, I'll use the same way to encourage my child. And give him(her) right thinking. This is because that I saw many parents give money or presents too much. I think they are over-love their child. And this way was very bad. They study in order to earn things which they like from their parents, not study in truth.`;
                        } else {
                            essayTextarea.value = `Although humans are presently the dominant and superior species on earth, when it comes down to the basics, we are no different from the other animals. Like animals, we live in groups, and thus we need to interact with other people. However, that is not always as easy as it seems.

There are some important personal traits which I consider helpful in getting along well with other people. In my opinion, most people like a person with an optimistic, considerate and generous personality.

In the first place, being optimistic plays an important role in interpersonal communication. An optimist always looks on the bright side of things. So, he can easily cheer up a person who feels depressed. For example, when I felt frustrated because I made some mistakes in my job, my co-worker Jane comforted me by saying positive things. Her optimism made me feel much better.

In addition, being considerate is also essential in daily interaction. Most people think of themselves before others. If we can put the need of others in top priority, they will be touched. For example, parents who consider their children's difficulties will have better relationships with them.

Finally, a generous person usually has more friends. Very few people like to make friends with a stingy person. My co-worker Nancy is a good example. She likes to share her books and cookies with us, and that's why most co-workers enjoy spending time with her.

In conclusion, an optimistic, considerate, and generous person can easily get along with other people. They will be surrounded by friends wherever they go.`;
                        }
                    } catch (error) {
                        console.error('updateExample 錯誤:', error);
                    }
                }
                
                if (gradeSelect) {
                    gradeSelect.addEventListener('change', updateExample);
                    updateExample(); // 初始化顯示
                }
            } catch (error) {
                console.error('window.onload 錯誤:', error);
            }
        };
    </script>
</body>
</html>
