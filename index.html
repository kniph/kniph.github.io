<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å¯«ä½œè‡ªå‹•æ‰¹æ”¹ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section, .output-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results {
            display: none;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .score-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .feedback-category {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4facfe;
        }

        .category-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .feedback-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #28a745;
        }

        .feedback-item.warning {
            border-left-color: #ffc107;
        }

        .feedback-item.error {
            border-left-color: #dc3545;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sentence-error {
            background: #fff2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #dc3545;
        }

        .sentence-original {
            background: #fef2f2;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .sentence-corrected {
            background: #f0f9ff;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #0066cc;
            font-family: 'Courier New', monospace;
        }

        .corrected-essay {
            background: #f8fff8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* æ–°å¢æ‹ç…§åŠŸèƒ½æ¨£å¼ */
        .input-options {
            width: 100%;
        }

        .input-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
        }

        .tab-btn:hover {
            color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .input-mode {
            display: none;
        }

        .input-mode.active {
            display: block;
        }

        .camera-container {
            border: 2px dashed #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            position: relative;
        }

        .camera-interface {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .camera-placeholder {
            margin-bottom: 20px;
            color: #666;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        #cameraPreview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .photo-preview {
            text-align: center;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }

        .photo-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .ocr-result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .ocr-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            min-height: 100px;
            border: 1px solid #e1e5e9;
            white-space: pre-wrap;
        }

        .ocr-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .loading-ocr {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .spinner-small {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @media (max-width: 768px) {
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .tab-btn {
                font-size: 12px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ è‹±æ–‡å¯«ä½œè‡ªå‹•æ‰¹æ”¹ç³»çµ±</h1>
            <p>æ™ºèƒ½åˆ†æå­¸ç”Ÿå¯«ä½œï¼Œæä¾›å°ˆæ¥­å»ºè­°èˆ‡è©•åˆ†</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">ğŸ“‹ è¼¸å…¥å¯«ä½œå…§å®¹</h2>
                
                <div class="form-group">
                    <label for="studentName">å­¸ç”Ÿå§“åï¼š</label>
                    <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å">
                </div>

                <div class="form-group">
                    <label for="assignmentType">ä½œæ¥­é¡å‹ï¼š</label>
                    <select id="assignmentType">
                        <option value="essay">è­°è«–æ–‡ (Essay)</option>
                        <option value="narrative">è¨˜æ•˜æ–‡ (Narrative)</option>
                        <option value="descriptive">æè¿°æ–‡ (Descriptive)</option>
                        <option value="letter">æ›¸ä¿¡ (Letter)</option>
                        <option value="report">å ±å‘Š (Report)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="gradeLevel">GEPT ç¨‹åº¦ï¼š</label>
                    <select id="gradeLevel">
                        <option value="elementary">GEPT åˆç´š (Elementary)</option>
                        <option value="intermediate">GEPT ä¸­ç´š (Intermediate)</option>
                        <option value="high-intermediate">GEPT ä¸­é«˜ç´š (High-Intermediate)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="essayContent">å¯«ä½œå…§å®¹ï¼š</label>
                    <div class="input-options">
                        <div class="input-tabs">
                            <button type="button" class="tab-btn active" onclick="switchInputMode('text')">ğŸ“ æ–‡å­—è¼¸å…¥</button>
                            <button type="button" class="tab-btn" onclick="switchInputMode('camera')">ğŸ“· æ‹ç…§ä¸Šå‚³</button>
                        </div>
                        
                        <div id="textInput" class="input-mode active">
                            <textarea id="essayContent" placeholder="è«‹è²¼ä¸Šå­¸ç”Ÿçš„è‹±æ–‡å¯«ä½œå…§å®¹...">Yin Yin has a lots of work to do. In weekday, She was work in a moving company, but she has a favorite work in weekend. It is a music action. She was good at this work.</textarea>
                        </div>
                        
                        <div id="cameraInput" class="input-mode">
                            <div class="camera-container">
                                <video id="cameraPreview" autoplay playsinline style="display: none;"></video>
                                <canvas id="photoCanvas" style="display: none;"></canvas>
                                <button type="button" class="btn" onclick="capturePhoto()" id="captureBtn" style="display: none;">ğŸ“¸ æ‹ç…§</button>
                                <div id="photoPreview" class="photo-preview" style="display: none;">
                                    <img id="capturedImage" alt="æ‹æ”çš„ç…§ç‰‡">
                                    <div class="photo-actions">
                                        <button type="button" class="btn btn-secondary" onclick="retakePhoto()">ğŸ”„ é‡æ–°æ‹æ”</button>
                                        <button type="button" class="btn btn-primary" onclick="processImage()">ğŸ” è­˜åˆ¥æ–‡å­—</button>
                                    </div>
                                </div>
                                <div id="cameraInterface" class="camera-interface">
                                    <div class="camera-placeholder">
                                        <p>ğŸ“· é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•Ÿç›¸æ©Ÿ</p>
                                    </div>
                                    <div class="camera-controls">
                                        <button type="button" class="btn" onclick="startCamera()">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
                                        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">ğŸ“ é¸æ“‡ç…§ç‰‡</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="ocrResult" class="ocr-result" style="display: none;">
                                <h4>ğŸ“ è­˜åˆ¥çµæœï¼š</h4>
                                <div class="ocr-text" id="recognizedText"></div>
                                <div class="ocr-actions">
                                    <button type="button" class="btn" onclick="useOcrText()">âœ… ä½¿ç”¨æ­¤æ–‡å­—</button>
                                    <button type="button" class="btn btn-secondary" onclick="editOcrText()">âœï¸ æ‰‹å‹•ç·¨è¼¯</button>
                                    <button type="button" class="btn btn-secondary" onclick="skipOcrManualInput()">ğŸ“ è·³éè­˜åˆ¥ï¼Œæ‰‹å‹•è¼¸å…¥</button>
                                </div>
                            </div>
                            
                            <div id="loadingOcr" class="loading-ocr" style="display: none;">
                                <div class="spinner-small"></div>
                                <p>æ­£åœ¨è­˜åˆ¥æ–‡å­—å…§å®¹ï¼Œè«‹ç¨å€™...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="analyzeEssay()">ğŸ” é–‹å§‹æ‰¹æ”¹</button>
            </div>

            <div class="output-section">
                <h2 class="section-title">ğŸ“Š æ‰¹æ”¹çµæœ</h2>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æå¯«ä½œå…§å®¹ï¼Œè«‹ç¨å€™...</p>
                </div>

                <div class="results" id="results">
                    <div class="score-display">
                        <div class="score-number" id="overallScore">3</div>
                        <div class="score-label">GEPT ç´šåˆ† (æ»¿åˆ†5åˆ†)</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="wordCount">0</div>
                            <div class="stat-label">å­—æ•¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="sentenceCount">0</div>
                            <div class="stat-label">å¥æ•¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="paragraphCount">0</div>
                            <div class="stat-label">æ®µè½æ•¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="avgWordsPerSentence">0</div>
                            <div class="stat-label">å¹³å‡å¥é•·</div>
                        </div>
                    </div>

                    <div id="feedbackContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥OCRåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <script>
        // å®Œæ•´çš„èªæ³•è¦å‰‡æª¢æŸ¥ï¼ˆèª¿æ•´ç‚ºæ›´ç¬¦åˆå®˜æ–¹æ¨™æº–ï¼‰
        const grammarRules = {
            // ä¸»è©å‹•è©ä¸€è‡´æ€§
            subjectVerbAgreement: [
                {pattern: /\b(he|she|it)\s+(are|have|do)\b/gi, message: "ä¸»è©å‹•è©ä¸ä¸€è‡´ï¼šhe/she/it æ‡‰è©²æ­é… is/has/does", correction: (match) => match.replace(/(he|she|it)\s+(are|have|do)/gi, (m, subj, verb) => subj + ' ' + (verb === 'are' ? 'is' : verb === 'have' ? 'has' : 'does'))},
                {pattern: /\b(they|we|you)\s+(is|has|does)\b/gi, message: "ä¸»è©å‹•è©ä¸ä¸€è‡´ï¼šthey/we/you æ‡‰è©²æ­é… are/have/do", correction: (match) => match.replace(/(they|we|you)\s+(is|has|does)/gi, (m, subj, verb) => subj + ' ' + (verb === 'is' ? 'are' : verb === 'has' ? 'have' : 'do'))},
                {pattern: /\bthey\s+eats\b/gi, message: "ä¸»è©å‹•è©ä¸ä¸€è‡´ï¼šthey æ‡‰è©²æ­é… eat", correction: (match) => match.replace(/they\s+eats/gi, 'they eat')},
                {pattern: /\b(I)\s+(are|is)\b/gi, message: "ä¸»è©å‹•è©ä¸ä¸€è‡´ï¼šI æ‡‰è©²æ­é… am", correction: (match) => match.replace(/I\s+(are|is)/gi, 'I am')}
            ],
            
            // å† è©å’Œé‡è©éŒ¯èª¤
            articles: [
                {pattern: /\ba\s+lots\s+of\b/gi, message: "å† è©éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'a lot of' æˆ– 'lots of'", correction: (match) => match.replace(/a\s+lots\s+of/gi, 'a lot of')},
                {pattern: /\ba\s+([aeiou])/gi, message: "å† è©éŒ¯èª¤ï¼šæ¯éŸ³å‰æ‡‰ä½¿ç”¨ 'an'", correction: (match) => match.replace(/\ba\s+([aeiou])/gi, 'an $1')},
                {pattern: /\ban\s+([bcdfghjklmnpqrstvwxyz])/gi, message: "å† è©éŒ¯èª¤ï¼šå­éŸ³å‰æ‡‰ä½¿ç”¨ 'a'", correction: (match) => match.replace(/\ban\s+([bcdfghjklmnpqrstvwxyz])/gi, 'a $1')}
            ],
            
            // å‹•è©å½¢å¼éŒ¯èª¤
            verbForms: [
                {pattern: /\bwas\s+work\b/gi, message: "å‹•è©å½¢å¼éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'worked' æˆ– 'was working'", correction: (match) => match.replace(/was\s+work/gi, 'worked')},
                {pattern: /\bcalls\s+her\s+getting\s+up\b/gi, message: "å‹•è©ç”¨æ³•éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'calls her to get up'", correction: (match) => match.replace(/calls\s+her\s+getting\s+up/gi, 'calls her to get up')},
                {pattern: /\blook\s+a\s+lot\s+of\b/gi, message: "å‹•è©ç”¨æ³•éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'see a lot of' æˆ– 'look at a lot of'", correction: (match) => match.replace(/look\s+a\s+lot\s+of/gi, 'see a lot of')}
            ],
            
            // ä»‹ç³»è©éŒ¯èª¤
            prepositions: [
                {pattern: /\b(In|On)\s+weekday\b/gi, message: "ä»‹ç³»è©éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'On weekdays' (è¤‡æ•¸)", correction: (match) => match.replace(/(In|On)\s+weekday/gi, 'On weekdays')},
                {pattern: /\bin\s+weekend\b/gi, message: "ä»‹ç³»è©éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'on weekends' æˆ– 'at the weekend'", correction: (match) => match.replace(/in\s+weekend/gi, 'on weekends')},
                {pattern: /\bgood\s+at\s+this\s+work\b/gi, message: "ä»‹ç³»è©ç”¨æ³•ï¼šå»ºè­°ä½¿ç”¨ 'good at this job'", correction: (match) => match.replace(/good\s+at\s+this\s+work/gi, 'good at this job')}
            ],
            
            // è©å½™ä½¿ç”¨éŒ¯èª¤
            vocabulary: [
                {pattern: /\bmusic\s+action\b/gi, message: "è©å½™éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'musical activity' æˆ– 'music performance'", correction: (match) => match.replace(/music\s+action/gi, 'musical activity')},
                {pattern: /\brestaurent\b/gi, message: "æ‹¼å­—éŒ¯èª¤ï¼šæ­£ç¢ºæ‹¼æ³•æ˜¯ 'restaurant'", correction: (match) => match.replace(/restaurent/gi, 'restaurant')},
                {pattern: /\bdelicous\b/gi, message: "æ‹¼å­—éŒ¯èª¤ï¼šæ­£ç¢ºæ‹¼æ³•æ˜¯ 'delicious'", correction: (match) => match.replace(/delicous/gi, 'delicious')}
            ],
            
            // å¥å­çµæ§‹å•é¡Œ
            sentenceStructure: [
                {pattern: /\bcalls\s+her\s+getting\s+up\s+really\b/gi, message: "å¥å­çµæ§‹éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ 'calls her to get up'", correction: (match) => match.replace(/calls\s+her\s+getting\s+up\s+really/gi, 'calls her to get up')},
                {pattern: /^\s*Because\s+[^.!?]*[.!?]\s*$/gim, message: "å¥å­ä¸å®Œæ•´ï¼šBecause å¼•å°çš„å¾å±¬å­å¥éœ€è¦ä¸»è¦å­å¥", correction: (match) => match}
            ]
        };

        // è½‰æŠ˜è©æ¸…å–®
        const transitionWords = ['however', 'moreover', 'furthermore', 'therefore', 'consequently', 'nevertheless', 'additionally', 'in contrast', 'on the other hand', 'as a result', 'first', 'second', 'third', 'finally', 'in conclusion', 'for example', 'for instance', 'in addition', 'besides', 'meanwhile', 'although', 'despite', 'whereas', 'similarly', 'likewise'];

        // ç›¸æ©Ÿå’ŒOCRç›¸é—œè®Šé‡
        let currentStream = null;
        let capturedImageData = null;

        // è¼¸å…¥æ¨¡å¼åˆ‡æ›
        function switchInputMode(mode) {
            // åˆ‡æ›æ¨™ç±¤æ¿€æ´»ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ›è¼¸å…¥å€åŸŸ
            document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
            document.getElementById(mode === 'text' ? 'textInput' : 'cameraInput').classList.add('active');
            
            // åœæ­¢ç›¸æ©Ÿï¼ˆå¦‚æœæ­£åœ¨ä½¿ç”¨ï¼‰
            if (mode === 'text' && currentStream) {
                stopCamera();
            }
        }

        // é–‹å•Ÿç›¸æ©Ÿ
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // ä½¿ç”¨å¾Œç½®é¡é ­
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraPreview');
                video.srcObject = currentStream;
                video.style.display = 'block';
                
                // ç­‰å¾…è¦–é »è¼‰å…¥å¾Œå†é¡¯ç¤ºæ‹ç…§æŒ‰éˆ•
                video.onloadedmetadata = function() {
                    document.getElementById('cameraInterface').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'inline-block';
                };
                
            } catch (error) {
                console.error('ç„¡æ³•è¨ªå•ç›¸æ©Ÿ:', error);
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥è¨­å‚™æ¬Šé™æˆ–é¸æ“‡ä¸Šå‚³ç…§ç‰‡ã€‚éŒ¯èª¤ï¼š' + error.message);
            }
        }

        // åœæ­¢ç›¸æ©Ÿ
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            const video = document.getElementById('cameraPreview');
            video.style.display = 'none';
            document.getElementById('cameraInterface').style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
        }

        // æ‹ç…§
        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            // è¨­ç½®canvaså°ºå¯¸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // å°‡è¦–é »å¹€ç¹ªè£½åˆ°canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // ç²å–åœ–åƒæ•¸æ“š
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // é¡¯ç¤ºé è¦½
            showPhotoPreview(capturedImageData);
            
            // åœæ­¢ç›¸æ©Ÿ
            stopCamera();
        }

        // è™•ç†æ–‡ä»¶é¸æ“‡
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedImageData = e.target.result;
                    showPhotoPreview(capturedImageData);
                };
                reader.readAsDataURL(file);
            }
        }

        // é¡¯ç¤ºç…§ç‰‡é è¦½
        function showPhotoPreview(imageData) {
            const img = document.getElementById('capturedImage');
            img.src = imageData;
            
            document.getElementById('cameraInterface').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'block';
        }

        // é‡æ–°æ‹æ”
        function retakePhoto() {
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('cameraInterface').style.display = 'block';
            document.getElementById('ocrResult').style.display = 'none';
            capturedImageData = null;
        }

        // è™•ç†åœ–åƒOCR
        async function processImage() {
            if (!capturedImageData) {
                alert('è«‹å…ˆæ‹æ”æˆ–é¸æ“‡ç…§ç‰‡');
                return;
            }
            
            document.getElementById('loadingOcr').style.display = 'block';
            
            try {
                // ä½¿ç”¨Tesseract.jsé€²è¡ŒOCRè­˜åˆ¥
                const text = await performOCR(capturedImageData);
                document.getElementById('recognizedText').textContent = text;
                document.getElementById('ocrResult').style.display = 'block';
                document.getElementById('loadingOcr').style.display = 'none';
            } catch (error) {
                console.error('OCRè­˜åˆ¥å¤±æ•—:', error);
                document.getElementById('loadingOcr').style.display = 'none';
                alert('æ–‡å­—è­˜åˆ¥å¤±æ•—ï¼Œè«‹é‡æ–°æ‹æ”æˆ–æ‰‹å‹•è¼¸å…¥æ–‡å­—ã€‚');
            }
        }

        // Google Vision APIè¨­å®š - è«‹æ›¿æ›ç‚ºæ‚¨çš„APIé‡‘é‘°
        const GOOGLE_VISION_API_KEY = 'AIzaSyC_aGiEVd9oYiDZcQMXavb9kXYmnNHljdk'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›APIé‡‘é‘°
        
        // OCRè­˜åˆ¥å‡½æ•¸ï¼ˆä½¿ç”¨Google Vision APIï¼‰
        async function performOCR(imageData) {
            // æª¢æŸ¥APIé‡‘é‘°æ˜¯å¦è¨­å®š
            if (GOOGLE_VISION_API_KEY === 'YOUR_API_KEY_HERE') {
                alert('è«‹å…ˆè¨­å®šGoogle Vision APIé‡‘é‘°ï¼\n\nè«‹å°‡ç¨‹å¼ç¢¼ä¸­çš„ YOUR_API_KEY_HERE æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›APIé‡‘é‘°ã€‚');
                return showManualInputFallback();
            }
            
            try {
                // ä½¿ç”¨Google Vision APIé€²è¡ŒOCRè­˜åˆ¥
                const visionResult = await callGoogleVisionAPI(imageData);
                if (visionResult && visionResult.trim()) {
                    return visionResult;
                }
                
                // å¦‚æœGoogle Visionå¤±æ•—ï¼Œå›é€€åˆ°Tesseract.js
                console.log('Google Vision APIç„¡çµæœï¼Œå˜—è©¦ä½¿ç”¨Tesseract.js...');
                return await fallbackToTesseract(imageData);
                
            } catch (error) {
                console.error('Google Vision APIéŒ¯èª¤:', error);
                
                // éŒ¯èª¤è™•ç†ï¼šå˜—è©¦Tesseract.jsä½œç‚ºå‚™ç”¨
                try {
                    console.log('å›é€€åˆ°Tesseract.js...');
                    return await fallbackToTesseract(imageData);
                } catch (tesseractError) {
                    console.error('Tesseract.jsä¹Ÿå¤±æ•—:', tesseractError);
                    return showManualInputFallback();
                }
            }
        }

        // Google Vision APIèª¿ç”¨
        async function callGoogleVisionAPI(imageData) {
            // å°‡base64åœ–ç‰‡è½‰æ›ç‚ºGoogle Vision APIéœ€è¦çš„æ ¼å¼
            const base64Image = imageData.split(',')[1]; // ç§»é™¤data:image/jpeg;base64,å‰ç¶´
            
            const requestBody = {
                requests: [{
                    image: {
                        content: base64Image
                    },
                    features: [{
                        type: 'TEXT_DETECTION',
                        maxResults: 1
                    }]
                }]
            };

            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Google Vision APIéŒ¯èª¤: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
            }

            const data = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è­˜åˆ¥çµæœ
            if (data.responses && data.responses[0] && data.responses[0].textAnnotations) {
                const detectedText = data.responses[0].textAnnotations[0].description;
                
                // æ¸…ç†è­˜åˆ¥çµæœ
                const cleanedText = detectedText
                    .replace(/\n+/g, ' ') // å°‡æ›è¡Œè½‰ç‚ºç©ºæ ¼
                    .replace(/\s+/g, ' ') // è™•ç†å¤šé¤˜ç©ºæ ¼
                    .trim();
                
                return cleanedText;
            }
            
            return null; // æ²’æœ‰è­˜åˆ¥åˆ°æ–‡å­—
        }

        // Tesseract.jså‚™ç”¨æ–¹æ¡ˆ
        async function fallbackToTesseract(imageData) {
            const { data: { text } } = await Tesseract.recognize(
                imageData,
                'eng',
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            console.log(`å‚™ç”¨OCRé€²åº¦: ${Math.round(m.progress * 100)}%`);
                        }
                    },
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,!?;:\'" \n'
                }
            );
            
            return text.replace(/\s+/g, ' ').trim() || 'æœªèƒ½è­˜åˆ¥åˆ°æ–‡å­—å…§å®¹ã€‚';
        }

        // å‚™ç”¨æ–¹æ¡ˆï¼šç•¶OCRå¤±æ•—æ™‚æä¾›æ‰‹å‹•è¼¸å…¥
        function showManualInputFallback() {
            const manualText = prompt(
                'OCRè­˜åˆ¥å¤±æ•—ã€‚è«‹æ‰‹å‹•è¼¸å…¥æ‚¨çœ‹åˆ°çš„è‹±æ–‡å…§å®¹ï¼š\n\n(æç¤º: å¯ä»¥åªè¼¸å…¥å‰å¹¾å¥ï¼Œä¹‹å¾Œå†æ‰‹å‹•è£œå®Œ)', 
                ''
            );
            return manualText || 'è«‹æ‰‹å‹•è¼¸å…¥æ–‡å­—å…§å®¹ã€‚';
        }

        // ä½¿ç”¨OCRæ–‡å­—
        function useOcrText() {
            const recognizedText = document.getElementById('recognizedText').textContent;
            document.getElementById('essayContent').value = recognizedText;
            
            // åˆ‡æ›å›æ–‡å­—è¼¸å…¥æ¨¡å¼
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[onclick*="text"]').classList.add('active');
            
            document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
            document.getElementById('textInput').classList.add('active');
            
            alert('æ–‡å­—å·²æˆåŠŸå°å…¥ï¼æ‚¨å¯ä»¥é€²ä¸€æ­¥ç·¨è¼¯å¾Œé–‹å§‹æ‰¹æ”¹ã€‚');
        }

        // è·³éOCRï¼Œç›´æ¥æ‰‹å‹•è¼¸å…¥
        function skipOcrManualInput() {
            document.getElementById('essayContent').value = '';
            
            // åˆ‡æ›åˆ°æ–‡å­—è¼¸å…¥æ¨¡å¼
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[onclick*="text"]').classList.add('active');
            
            document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
            document.getElementById('textInput').classList.add('active');
            
            alert('å·²åˆ‡æ›åˆ°æ–‡å­—è¼¸å…¥æ¨¡å¼ï¼Œè«‹ç›´æ¥åœ¨æ–‡å­—æ¡†ä¸­è¼¸å…¥å…§å®¹ã€‚');
        }

        // æ”¹é€²çš„æ‰‹å‹•ç·¨è¼¯åŠŸèƒ½
        function editOcrText() {
            const recognizedText = document.getElementById('recognizedText').textContent;
            const editedText = prompt('è«‹ç·¨è¼¯æˆ–é‡æ–°è¼¸å…¥æ–‡å­—å…§å®¹ï¼š\n\n(æç¤º: å¦‚æœè­˜åˆ¥éŒ¯èª¤å¤ªå¤šï¼Œå¯ä»¥é‡æ–°è¼¸å…¥)', recognizedText);
            
            if (editedText !== null) {
                document.getElementById('essayContent').value = editedText;
                
                // åˆ‡æ›åˆ°æ–‡å­—è¼¸å…¥æ¨¡å¼
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[onclick*="text"]').classList.add('active');
                
                document.querySelectorAll('.input-mode').forEach(input => input.classList.remove('active'));
                document.getElementById('textInput').classList.add('active');
                
                alert('æ–‡å­—å·²æ›´æ–°ï¼æ‚¨å¯ä»¥ç¹¼çºŒç·¨è¼¯æˆ–é–‹å§‹æ‰¹æ”¹ã€‚');
            }
        }

        function analyzeEssay() {
            try {
                let content = '';
                
                // æª¢æŸ¥ç•¶å‰è¼¸å…¥æ¨¡å¼
                const activeMode = document.querySelector('.input-mode.active');
                if (activeMode.id === 'textInput') {
                    content = document.getElementById('essayContent').value.trim();
                } else {
                    // å¦‚æœåœ¨ç›¸æ©Ÿæ¨¡å¼ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰OCRçµæœ
                    const ocrText = document.getElementById('recognizedText').textContent;
                    if (ocrText) {
                        content = ocrText.trim();
                    } else {
                        alert('è«‹å…ˆæ‹ç…§ä¸¦è­˜åˆ¥æ–‡å­—ï¼Œæˆ–åˆ‡æ›åˆ°æ–‡å­—è¼¸å…¥æ¨¡å¼ï¼');
                        return;
                    }
                }
                
                if (!content) {
                    alert('è«‹è¼¸å…¥å¯«ä½œå…§å®¹ï¼');
                    return;
                }

                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';

                setTimeout(() => {
                    const analysis = performAnalysis(content);
                    displayResults(analysis);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                }, 1500);
            } catch (error) {
                console.error('åˆ†æéç¨‹å‡ºéŒ¯:', error);
                alert('æ‰¹æ”¹éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
            }
        }

        function performAnalysis(content) {
            // åŸºæœ¬çµ±è¨ˆ
            const words = content.toLowerCase().match(/\b\w+\b/g) || [];
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            
            const wordCount = words.length;
            const sentenceCount = sentences.length;
            const paragraphCount = paragraphs.length;
            const avgWordsPerSentence = Math.round(wordCount / sentenceCount) || 0;

            // èªæ³•æª¢æŸ¥
            const grammarErrors = checkGrammar(content, sentences);
            
            // è©å½™åˆ†æ
            const vocabularyAnalysis = analyzeVocabulary(words);
            
            // çµæ§‹åˆ†æ
            const structureAnalysis = analyzeStructure(content);
            
            // é€å¥éŒ¯èª¤åˆ†æ
            const sentenceErrors = analyzeSentenceErrors(sentences, content);
            
            // ç”Ÿæˆä¿®æ­£ç‰ˆæ–‡ç« 
            const correctedEssay = generateCorrectedEssay(content, sentenceErrors);
            
            // è¨ˆç®—ç¸½åˆ†
            const gradeLevel = document.getElementById('gradeLevel').value;
            const overallScore = calculateOverallScore(grammarErrors, vocabularyAnalysis, structureAnalysis, wordCount, gradeLevel);

            return {
                stats: { wordCount, sentenceCount, paragraphCount, avgWordsPerSentence },
                overallScore,
                grammarErrors,
                vocabularyAnalysis,
                structureAnalysis,
                sentenceErrors,
                correctedEssay
            };
        }

        function checkGrammar(content, sentences) {
            const errors = [];
            
            // æª¢æŸ¥å„ç¨®èªæ³•è¦å‰‡
            Object.entries(grammarRules).forEach(([category, rules]) => {
                rules.forEach(rule => {
                    const matches = content.match(rule.pattern);
                    if (matches) {
                        matches.forEach(match => {
                            errors.push({
                                type: 'error',
                                category: category,
                                message: rule.message,
                                example: match,
                                correction: rule.correction ? rule.correction(match) : match
                            });
                        });
                    }
                });
            });

            // æª¢æŸ¥å¤§å°å¯«
            sentences.forEach((sentence, index) => {
                const trimmed = sentence.trim();
                if (trimmed && !/^[A-Z]/.test(trimmed)) {
                    errors.push({
                        type: 'warning',
                        category: 'capitalization',
                        message: 'å¥å­é–‹é ­æ‡‰è©²å¤§å¯«',
                        example: trimmed.substring(0, 20) + '...',
                        correction: trimmed.charAt(0).toUpperCase() + trimmed.slice(1)
                    });
                }
            });

            return errors;
        }

        function analyzeSentenceErrors(sentences, originalContent) {
            const sentenceErrors = [];
            
            sentences.forEach((sentence, index) => {
                const errors = [];
                const corrections = [];
                let correctedSentence = sentence.trim();

                // æª¢æŸ¥æ¯å€‹èªæ³•è¦å‰‡
                Object.entries(grammarRules).forEach(([category, rules]) => {
                    rules.forEach(rule => {
                        if (rule.pattern.test(sentence)) {
                            errors.push({
                                type: 'error',
                                message: rule.message,
                                category: category
                            });
                            
                            // æ‡‰ç”¨ä¿®æ­£
                            if (rule.correction) {
                                correctedSentence = rule.correction(correctedSentence);
                            }
                        }
                    });
                });

                // æª¢æŸ¥å¤§å°å¯«
                if (sentence.trim() && !/^[A-Z]/.test(sentence.trim())) {
                    errors.push({
                        type: 'warning',
                        message: 'å¥å­é–‹é ­æ‡‰è©²å¤§å¯«',
                        category: 'capitalization'
                    });
                    correctedSentence = correctedSentence.charAt(0).toUpperCase() + correctedSentence.slice(1);
                }

                if (errors.length > 0 || correctedSentence !== sentence.trim()) {
                    sentenceErrors.push({
                        index: index + 1,
                        original: sentence.trim(),
                        errors: errors,
                        corrected: correctedSentence
                    });
                }
            });

            return sentenceErrors;
        }

        function generateCorrectedEssay(originalContent, sentenceErrors) {
            let correctedContent = originalContent;
            
            // å¾å¾Œå¾€å‰æ›¿æ›ï¼Œé¿å…ç´¢å¼•ä½ç§»
            for (let i = sentenceErrors.length - 1; i >= 0; i--) {
                const error = sentenceErrors[i];
                if (error.original !== error.corrected) {
                    correctedContent = correctedContent.replace(error.original, error.corrected);
                }
            }
            
            return correctedContent;
        }

        function analyzeVocabulary(words) {
            const uniqueWords = [...new Set(words)];
            const repetitiveWords = findRepetitiveWords(words);
            const transitionWordCount = words.filter(word => 
                transitionWords.includes(word.toLowerCase())
            ).length;

            return {
                uniqueWordRatio: ((uniqueWords.length / words.length) * 100).toFixed(1),
                repetitiveWords,
                transitionWordCount,
                vocabularyLevel: { basic: 0, intermediate: 0, advanced: 0 }
            };
        }

        function findRepetitiveWords(words) {
            const wordCount = {};
            words.forEach(word => {
                if (word.length > 3) {
                    wordCount[word] = (wordCount[word] || 0) + 1;
                }
            });

            return Object.entries(wordCount)
                .filter(([word, count]) => count > 2)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
        }

        function analyzeStructure(content) {
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            
            return {
                paragraphCount: paragraphs.length,
                hasIntroduction: paragraphs.length > 0,
                hasBodyParagraphs: paragraphs.length > 1,
                hasConclusion: paragraphs.length > 2,
                structureScore: Math.min(100, paragraphs.length * 30)
            };
        }

        function calculateOverallScore(grammarErrors, vocabularyAnalysis, structureAnalysis, wordCount, gradeLevel) {
            const grammarErrorCount = grammarErrors.filter(e => e.type === 'error').length;
            const grammarWarningCount = grammarErrors.filter(e => e.type === 'warning').length;
            const expectedWordCount = getExpectedWordCount(gradeLevel);
            
            // æ ¹æ“šå®˜æ–¹GEPTæ¨™æº–èª¿æ•´è©•åˆ†ï¼ˆæ›´è²¼è¿‘å¯¦éš›æ¨™æº–ï¼‰
            
            // 0ç´šåˆ†ï¼šå­—æ•¸éå°‘æˆ–å®Œå…¨ç„¡æ³•ç†è§£
            if (wordCount < 20 || wordCount < expectedWordCount * 0.3) {
                return 0;
            }
            
            // 5ç´šåˆ†ï¼šå¹¾ä¹ç„¡èª¤ï¼ˆå…è¨±1-2å€‹å°éŒ¯èª¤ï¼‰
            if (grammarErrorCount === 0 && grammarWarningCount <= 2) {
                return 5;
            }
            
            // 4ç´šåˆ†ï¼šæœ‰èª¤ä½†ä¸å½±éŸ¿ç†è§£ï¼ˆå…è¨±2-3å€‹éŒ¯èª¤ï¼‰
            if (grammarErrorCount <= 3 && 
                wordCount >= expectedWordCount * 0.6 && 
                !hasSeriousGrammarIssues(grammarErrors)) {
                return 4;
            }
            
            // 3ç´šåˆ†ï¼šæœ‰èª¤ï¼Œç¨å½±éŸ¿ç†è§£ï¼ˆå…è¨±4-6å€‹éŒ¯èª¤ï¼‰
            if (grammarErrorCount <= 6 && 
                wordCount >= expectedWordCount * 0.5) {
                return 3;
            }
            
            // 2ç´šåˆ†ï¼šæœ‰å¾ˆå¤šèª¤ï¼Œé ˆè€å¿ƒè§£è®€ï¼ˆ7-10å€‹éŒ¯èª¤ï¼‰
            if (grammarErrorCount <= 10 && 
                wordCount >= expectedWordCount * 0.4) {
                return 2;
            }
            
            // 1ç´šåˆ†ï¼šéŒ¯èª¤éå¤šï¼Œåš´é‡å½±éŸ¿ç†è§£
            if (wordCount >= expectedWordCount * 0.3) {
                return 1;
            }
            
            return 0;
        }
        
        function hasSeriousGrammarIssues(grammarErrors) {
            // æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡çš„èªæ³•å•é¡Œï¼ˆå½±éŸ¿åŸºæœ¬ç†è§£ï¼‰
            const seriousErrors = grammarErrors.filter(error => 
                error.category === 'subjectVerbAgreement' || 
                error.category === 'tenseErrors' ||
                error.message.includes('ç„¡æ³•ç†è§£')
            );
            return seriousErrors.length > 2;
        }

        function displayResults(analysis) {
            // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            document.getElementById('overallScore').textContent = analysis.overallScore;
            document.getElementById('wordCount').textContent = analysis.stats.wordCount;
            document.getElementById('sentenceCount').textContent = analysis.stats.sentenceCount;
            document.getElementById('paragraphCount').textContent = analysis.stats.paragraphCount;
            document.getElementById('avgWordsPerSentence').textContent = analysis.stats.avgWordsPerSentence;

            // æ¸…ç©ºä¸¦é‡æ–°ç”Ÿæˆåé¥‹
            const feedbackContainer = document.getElementById('feedbackContainer');
            feedbackContainer.innerHTML = '';

            // é€å¥éŒ¯èª¤åˆ†æ
            if (analysis.sentenceErrors && analysis.sentenceErrors.length > 0) {
                const sentenceSection = createSentenceErrorSection(analysis.sentenceErrors);
                feedbackContainer.appendChild(sentenceSection);
            } else {
                const noErrorSection = createNoErrorSection();
                feedbackContainer.appendChild(noErrorSection);
            }

            // è©å½™å»ºè­°
            const vocabFeedback = generateVocabularyFeedback(analysis.vocabularyAnalysis);
            if (vocabFeedback.length > 0) {
                const vocabSection = createFeedbackSection('è©å½™å»ºè­°', vocabFeedback);
                feedbackContainer.appendChild(vocabSection);
            }

            // çµæ§‹å»ºè­°
            const structureFeedback = generateStructureFeedback(analysis.structureAnalysis, analysis.stats.wordCount);
            if (structureFeedback.length > 0) {
                const structureSection = createFeedbackSection('çµæ§‹å»ºè­°', structureFeedback);
                feedbackContainer.appendChild(structureSection);
            }

            // ç¸½é«”è©•åƒ¹
            const overallFeedback = generateOverallFeedback(analysis.overallScore);
            const overallSection = createFeedbackSection('ç¸½é«”è©•åƒ¹', overallFeedback);
            feedbackContainer.appendChild(overallSection);

            // ä¿®æ­£ç‰ˆæ–‡ç« 
            if (analysis.correctedEssay && analysis.correctedEssay !== document.getElementById('essayContent').value.trim()) {
                const correctedSection = createCorrectedEssaySection(analysis.correctedEssay);
                feedbackContainer.appendChild(correctedSection);
            }
        }

        function createSentenceErrorSection(sentenceErrors) {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const title = document.createElement('div');
            title.className = 'category-title';
            title.textContent = 'ğŸ“ é€å¥éŒ¯èª¤åˆ†æèˆ‡ä¿®æ­£å»ºè­°';
            section.appendChild(title);

            sentenceErrors.forEach(error => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'sentence-error';

                const originalDiv = document.createElement('div');
                originalDiv.className = 'sentence-original';
                originalDiv.innerHTML = `<strong>ç¬¬${error.index}å¥ (åŸæ–‡):</strong><br>"${error.original}"`;
                errorDiv.appendChild(originalDiv);

                if (error.errors.length > 0) {
                    const errorList = document.createElement('ul');
                    errorList.style.margin = '10px 0';
                    errorList.style.paddingLeft = '20px';
                    
                    error.errors.forEach(err => {
                        const li = document.createElement('li');
                        li.style.color = '#dc3545';
                        li.style.marginBottom = '5px';
                        li.textContent = `âŒ ${err.message}`;
                        errorList.appendChild(li);
                    });
                    errorDiv.appendChild(errorList);
                }

                const correctedDiv = document.createElement('div');
                correctedDiv.className = 'sentence-corrected';
                correctedDiv.innerHTML = `<strong>âœ… ä¿®æ­£å»ºè­°:</strong><br>"${error.corrected}"`;
                errorDiv.appendChild(correctedDiv);

                section.appendChild(errorDiv);
            });

            return section;
        }

        function createNoErrorSection() {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const title = document.createElement('div');
            title.className = 'category-title';
            title.textContent = 'ğŸ“ é€å¥éŒ¯èª¤åˆ†æèˆ‡ä¿®æ­£å»ºè­°';
            section.appendChild(title);

            const noErrorDiv = document.createElement('div');
            noErrorDiv.style.cssText = `
                background: #d4edda;
                padding: 15px;
                border-radius: 8px;
                color: #155724;
                text-align: center;
            `;
            noErrorDiv.textContent = 'ğŸ‰ å¤ªæ£’äº†ï¼æ²’æœ‰ç™¼ç¾æ˜é¡¯çš„èªæ³•éŒ¯èª¤ã€‚';
            section.appendChild(noErrorDiv);

            return section;
        }

        function createCorrectedEssaySection(correctedEssay) {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const title = document.createElement('div');
            title.className = 'category-title';
            title.textContent = 'ğŸ“„ ä¿®æ­£å¾Œå®Œæ•´æ–‡ç« ';
            section.appendChild(title);

            const essayDiv = document.createElement('div');
            essayDiv.className = 'corrected-essay';
            essayDiv.textContent = correctedEssay;
            section.appendChild(essayDiv);

            const copyButton = document.createElement('button');
            copyButton.textContent = 'ğŸ“‹ è¤‡è£½ä¿®æ­£ç‰ˆæ–‡ç« ';
            copyButton.className = 'btn';
            copyButton.style.cssText = `
                margin-top: 10px;
                background: #28a745;
                font-size: 14px;
                padding: 10px 20px;
            `;
            copyButton.onclick = function() {
                try {
                    navigator.clipboard.writeText(correctedEssay).then(() => {
                        copyButton.textContent = 'âœ… å·²è¤‡è£½ï¼';
                        setTimeout(() => {
                            copyButton.textContent = 'ğŸ“‹ è¤‡è£½ä¿®æ­£ç‰ˆæ–‡ç« ';
                        }, 2000);
                    }).catch(() => {
                        // å‚™ç”¨è¤‡è£½æ–¹æ³•
                        const textArea = document.createElement('textarea');
                        textArea.value = correctedEssay;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        copyButton.textContent = 'âœ… å·²è¤‡è£½ï¼';
                        setTimeout(() => {
                            copyButton.textContent = 'ğŸ“‹ è¤‡è£½ä¿®æ­£ç‰ˆæ–‡ç« ';
                        }, 2000);
                    });
                } catch (error) {
                    console.error('è¤‡è£½éŒ¯èª¤:', error);
                }
            };
            section.appendChild(copyButton);

            return section;
        }

        function createFeedbackSection(title, feedbackItems) {
            const section = document.createElement('div');
            section.className = 'feedback-category';
            
            const titleElement = document.createElement('div');
            titleElement.className = 'category-title';
            titleElement.textContent = title;
            section.appendChild(titleElement);

            if (feedbackItems && Array.isArray(feedbackItems)) {
                feedbackItems.forEach(item => {
                    const feedbackItem = document.createElement('div');
                    feedbackItem.className = `feedback-item ${item.type || 'info'}`;
                    feedbackItem.textContent = item.text || '';
                    section.appendChild(feedbackItem);
                });
            }

            return section;
        }

        function generateVocabularyFeedback(vocabularyAnalysis) {
            const feedback = [];
            
            if (parseFloat(vocabularyAnalysis.uniqueWordRatio) < 60) {
                feedback.push({
                    type: 'warning',
                    text: `è©å½™é‡è¤‡ç‡è¼ƒé«˜ (${vocabularyAnalysis.uniqueWordRatio}%)ï¼Œå»ºè­°ä½¿ç”¨æ›´å¤šæ¨£çš„è©å½™`
                });
            }

            if (vocabularyAnalysis.repetitiveWords.length > 0) {
                feedback.push({
                    type: 'warning',
                    text: `é‡è¤‡ä½¿ç”¨çš„è©å½™: ${vocabularyAnalysis.repetitiveWords.map(([word, count]) => `${word}(${count}æ¬¡)`).join(', ')}`
                });
            }

            if (vocabularyAnalysis.transitionWordCount === 0) {
                feedback.push({
                    type: 'error',
                    text: 'ç¼ºä¹è½‰æŠ˜è©ï¼å»ºè­°ä½¿ç”¨é€£æ¥è©ä¾†æé«˜æ–‡ç« é€£è²«æ€§ï¼Œå¦‚: however, moreover, therefore, for example ç­‰'
                });
            }

            return feedback;
        }

        function generateStructureFeedback(structureAnalysis, wordCount) {
            const feedback = [];
            const gradeLevel = document.getElementById('gradeLevel').value;
            const expectedWords = getExpectedWordCount(gradeLevel);

            if (wordCount < expectedWords * 0.8) {
                feedback.push({
                    type: 'error',
                    text: `å­—æ•¸ä¸è¶³ï¼${gradeLevel === 'elementary' ? 'åˆç´š' : gradeLevel === 'intermediate' ? 'ä¸­ç´š' : 'ä¸­é«˜ç´š'}å»ºè­°å­—æ•¸ç‚º${expectedWords}å­—ï¼Œç›®å‰åªæœ‰${wordCount}å­—`
                });
            }

            if (structureAnalysis.paragraphCount === 1) {
                feedback.push({
                    type: 'warning',
                    text: 'å»ºè­°å°‡æ–‡ç« åˆ†æˆå¤šå€‹æ®µè½ï¼Œå¢åŠ æ–‡ç« çµæ§‹æ¸…æ™°åº¦'
                });
            }

            if (!structureAnalysis.hasConclusion && gradeLevel !== 'elementary') {
                feedback.push({
                    type: 'warning',
                    text: 'å»ºè­°æ·»åŠ çµè«–æ®µè½ä¾†ç¸½çµå…¨æ–‡'
                });
            }

            return feedback;
        }

        function generateOverallFeedback(score) {
            const feedback = [];
            const gradeLevel = document.getElementById('gradeLevel').value;
            
            if (gradeLevel === 'elementary') {
                if (score === 5) {
                    feedback.push({
                        type: 'success',
                        text: '5ç´šåˆ†ï¼šæ­£ç¢ºè¡¨é”é¡Œç›®ä¹‹è¦æ±‚ï¼›æ–‡æ³•ã€ç”¨å­—ç­‰å¹¾ä¹ç„¡èª¤ã€‚'
                    });
                } else if (score === 4) {
                    feedback.push({
                        type: 'success',
                        text: '4ç´šåˆ†ï¼šå¤§è‡´æ­£ç¢ºè¡¨é”é¡Œç›®ä¹‹è¦æ±‚ï¼›æ–‡æ³•ã€ç”¨å­—ç­‰æœ‰èª¤ï¼Œä½†ä¸å½±éŸ¿è®€è€…ä¹‹ç†è§£ã€‚'
                    });
                } else if (score === 3) {
                    feedback.push({
                        type: 'warning',
                        text: '3ç´šåˆ†ï¼šå¤§è‡´å›ç­”é¡Œç›®ä¹‹è¦æ±‚ï¼Œä½†æœªèƒ½å®Œå…¨é”æ„ï¼›æ–‡æ³•ã€ç”¨å­—ç­‰æœ‰èª¤ï¼Œç¨å½±éŸ¿è®€è€…ä¹‹ç†è§£ã€‚'
                    });
                } else if (score === 2) {
                    feedback.push({
                        type: 'warning',
                        text: '2ç´šåˆ†ï¼šéƒ¨åˆ†å›ç­”é¡Œç›®ä¹‹è¦æ±‚ï¼Œè¡¨é”ä¸Šæœ‰ä»¤äººä¸è§£/èª¤è§£ä¹‹è™•ï¼›æ–‡æ³•ã€ç”¨å­—ç­‰çš†æœ‰èª¤ï¼Œè®€è€…é ˆè€å¿ƒè§£è®€ã€‚'
                    });
                } else if (score === 1) {
                    feedback.push({
                        type: 'error',
                        text: '1ç´šåˆ†ï¼šåƒ…å›ç­”1å€‹å•é¡Œæˆ–é‡é»ï¼›æ–‡æ³•ã€ç”¨å­—ç­‰éŒ¯èª¤éå¤šï¼Œåš´é‡å½±éŸ¿è®€è€…ä¹‹ç†è§£ã€‚'
                    });
                } else {
                    feedback.push({
                        type: 'error',
                        text: '0ç´šåˆ†ï¼šæœªç­”ã€ç­‰åŒæœªç­”ã€‚'
                    });
                }
            } else if (gradeLevel === 'intermediate') {
                if (score === 5) {
                    feedback.push({
                        type: 'success',
                        text: '5ç´šåˆ† (60åˆ†)ï¼šå¯«ä½œèƒ½åŠ›ä½³ - å…§å®¹é©åˆ‡è¡¨é”é¡Œç›®è¦æ±‚ï¼Œæ¸…æ¥šæœ‰æ¢ç†ï¼›çµ„ç¹”ç”šä½³ï¼›èƒ½éˆæ´»é‹ç”¨å­—å½™åŠå¥å‹ï¼›æ–‡æ³•ã€æ‹¼å­—æˆ–æ¨™é»ç¬¦è™Ÿå¶æœ‰éŒ¯èª¤ã€‚'
                    });
                } else if (score === 4) {
                    feedback.push({
                        type: 'success',
                        text: '4ç´šåˆ† (48åˆ†)ï¼šå¯«ä½œèƒ½åŠ›å¯ - å…§å®¹ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œå¤§è‡´æ¸…æ¥šï¼›çµ„ç¹”å¤§è‡´å®Œæ•´ï¼›èƒ½æ­£ç¢ºé‹ç”¨å­—å½™åŠå¥å‹ï¼›æ–‡æ³•ã€æ‹¼å­—æˆ–æ¨™é»ç¬¦è™Ÿé›–æœ‰éŒ¯èª¤ï¼Œä½†ä¸å½±éŸ¿ç†è§£ã€‚'
                    });
                } else if (score === 3) {
                    feedback.push({
                        type: 'warning',
                        text: '3ç´šåˆ† (36åˆ†)ï¼šå¯«ä½œèƒ½åŠ›æœ‰é™ - å…§å®¹å¤§è‡´ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œä½†æœªå®Œå…¨é”æ„ï¼›çµ„ç¹”å°šå¯ï¼›å­—å½™åŠå¥å‹æŒæ¡ä¸ä½³ï¼›æ–‡æ³•ã€æ‹¼å­—ã€æ¨™é»ç¬¦è™ŸéŒ¯èª¤åå¤šï¼Œå½±éŸ¿ç†è§£ã€‚'
                    });
                } else if (score === 2) {
                    feedback.push({
                        type: 'warning',
                        text: '2ç´šåˆ† (24åˆ†)ï¼šç¨å…·å¯«ä½œèƒ½åŠ› - å…§å®¹å±€éƒ¨ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œå¤§å¤šé›£ä»¥ç†è§£ï¼›çµ„ç¹”ä¸è‰¯ï¼›èƒ½é‹ç”¨çš„å­—å½™åŠå¥å‹æœ‰é™ï¼›æ–‡æ³•ã€æ‹¼å­—ã€æ¨™é»ç¬¦è™Ÿæœ‰è¨±å¤šéŒ¯èª¤ã€‚'
                    });
                } else if (score === 1) {
                    feedback.push({
                        type: 'error',
                        text: '1ç´šåˆ† (12åˆ†)ï¼šç„¡å¯«ä½œèƒ½åŠ› - å…§å®¹æœªèƒ½ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œç„¡æ³•ç†è§£ï¼›ç¼ºä¹çµ„ç¹”ï¼›èƒ½é‹ç”¨çš„å­—å½™åŠå¥å‹éå¸¸æœ‰é™ï¼›æ–‡æ³•ã€æ‹¼å­—ã€æ¨™é»ç¬¦è™Ÿæœ‰éå¤šéŒ¯èª¤ã€‚'
                    });
                } else {
                    feedback.push({
                        type: 'error',
                        text: '0ç´šåˆ† (0åˆ†)ï¼šæœªç­”/ç­‰åŒæœªç­”ã€‚'
                    });
                }
            } else {
                // ä¸­é«˜ç´šè©•åˆ†
                if (score === 5) {
                    feedback.push({
                        type: 'success',
                        text: '5ç´šåˆ† (60åˆ†)ï¼šå…§å®¹å¦¥åˆ‡è¡¨é”é¡Œç›®è¦æ±‚ï¼Œçµ„ç¹”å®Œæ•´ï¼Œå…¨æ–‡é€£è²«é€šé †ï¼›èƒ½éˆæ´»ä¸”å¦¥åˆ‡çš„é‹ç”¨å­—å½™åŠå„é¡å¥å‹çµæ§‹ï¼Œé®®æœ‰éŒ¯èª¤ã€‚'
                    });
                } else if (score === 4) {
                    feedback.push({
                        type: 'success',
                        text: '4ç´šåˆ† (48åˆ†)ï¼šå…§å®¹ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œçµ„ç¹”å®Œæ•´ï¼Œå…¨æ–‡å¤§è‡´é€£è²«ï¼›èƒ½æ­£ç¢ºçš„é‹ç”¨å­—å½™åŠå¥å‹çµæ§‹ï¼Œä½†ä»å¶æœ‰éŒ¯èª¤ã€‚'
                    });
                } else if (score === 3) {
                    feedback.push({
                        type: 'warning',
                        text: '3ç´šåˆ† (36åˆ†)ï¼šå…§å®¹å¤§è‡´ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œçµ„ç¹”å°šå¯ï¼Œé€£è²«æ€§å¾…åŠ å¼·ï¼›èƒ½å¤ é‹ç”¨å¸¸ç”¨å­—å½™åŠåŸºæœ¬å¥å‹çµæ§‹ï¼Œä½†ä½¿ç”¨è¼ƒé›£çš„å­—å½™æˆ–è¤‡é›œå¥æ™‚å¸¸æœ‰éŒ¯èª¤ã€‚'
                    });
                } else if (score === 2) {
                    feedback.push({
                        type: 'warning',
                        text: '2ç´šåˆ† (24åˆ†)ï¼šå…§å®¹åƒ…èƒ½å±€éƒ¨ç¬¦åˆé¡Œç›®ä¹‹è¦æ±‚ï¼Œçµ„ç¹”ä¸å®Œæ•´ä¸”ç¼ºä¹é€£è²«æ€§ï¼›å­—å½™æœ‰é™ï¼Œé‹ç”¨åŸºæœ¬å¥å‹çµæ§‹å¸¸æœ‰éŒ¯èª¤ï¼Œå½±éŸ¿ç†è§£ã€‚'
                    });
                } else if (score === 1) {
                    feedback.push({
                        type: 'error',
                        text: '1ç´šåˆ† (12åˆ†)ï¼šå…§å®¹æœªèƒ½ç¬¦åˆé¡Œç›®è¦æ±‚ï¼Œçµ„ç¹”ä¸è‰¯ï¼›å­—å½™æœ‰é™ï¼Œé‹ç”¨åŸºæœ¬å¥å‹çµæ§‹æœ‰è¨±å¤šéŒ¯èª¤ï¼Œå¤§å¤šé›£ä»¥ç†è§£ã€‚'
                    });
                } else {
                    feedback.push({
                        type: 'error',
                        text: '0ç´šåˆ† (0åˆ†)ï¼šæœªç­”/ç­‰åŒæœªç­”ã€‚æ–‡ç« éçŸ­ (å°‘æ–¼40å­—)ã€ç„¡æ³•è©•åˆ†ã€å…§å®¹å®Œå…¨ç„¡æ³•ç†è§£ã€å®Œå…¨é›¢é¡Œã€‚'
                    });
                }
            }

            return feedback;
        }

        function getExpectedWordCount(gradeLevel) {
            const expectations = {
                elementary: 50,        // GEPTåˆç´šå»ºè­°å­—æ•¸
                intermediate: 120,     // GEPTä¸­ç´šå»ºè­°å­—æ•¸
                'high-intermediate': 165 // GEPTä¸­é«˜ç´šå»ºè­°å­—æ•¸
            };
            return expectations[gradeLevel] || 50;
        }

        // åˆå§‹åŒ–ç¯„ä¾‹
        window.onload = function() {
            try {
                const gradeSelect = document.getElementById('gradeLevel');
                const essayTextarea = document.getElementById('essayContent');
                
                function updateExample() {
                    try {
                        const level = gradeSelect.value;
                        if (level === 'elementary') {
                            essayTextarea.value = `Today is Sunday. Shiau-fang's mother goes to her room, and calls her getting up really. Because they will go to the zoo.

They look a lot of animals in the zoo. There are elephants, tigers and birds over there. So they have a very good time.

And then they eats dinner in a restaurent. They eat and talk there.`;
                        } else if (level === 'intermediate') {
                            essayTextarea.value = `When I get good grades or good at behavior, my parents usually say "This is your responsible, you should do well." or "That's not bad and make progress next time." They never give me money or gifts. I think that the way of encourage is great and reasonable. I sometimes feel that they are vitally strict to me.

If I am be mother, I'll use the same way to encourage my child. And give him(her) right thinking. This is because that I saw many parents give money or presents too much. I think they are over-love their child. And this way was very bad. They study in order to earn things which they like from their parents, not study in truth.`;
                        } else {
                            essayTextarea.value = `Although humans are presently the dominant and superior species on earth, when it comes down to the basics, we are no different from the other animals. Like animals, we live in groups, and thus we need to interact with other people. However, that is not always as easy as it seems.

There are some important personal traits which I consider helpful in getting along well with other people. In my opinion, most people like a person with an optimistic, considerate and generous personality.

In the first place, being optimistic plays an important role in interpersonal communication. An optimist always looks on the bright side of things. So, he can easily cheer up a person who feels depressed. For example, when I felt frustrated because I made some mistakes in my job, my co-worker Jane comforted me by saying positive things. Her optimism made me feel much better.

In addition, being considerate is also essential in daily interaction. Most people think of themselves before others. If we can put the need of others in top priority, they will be touched. For example, parents who consider their children's difficulties will have better relationships with them.

Finally, a generous person usually has more friends. Very few people like to make friends with a stingy person. My co-worker Nancy is a good example. She likes to share her books and cookies with us, and that's why most co-workers enjoy spending time with her.

In conclusion, an optimistic, considerate, and generous person can easily get along with other people. They will be surrounded by friends wherever they go.`;
                        }
                    } catch (error) {
                        console.error('updateExample éŒ¯èª¤:', error);
                    }
                }
                
                if (gradeSelect) {
                    gradeSelect.addEventListener('change', updateExample);
                    updateExample(); // åˆå§‹åŒ–é¡¯ç¤º
                }
            } catch (error) {
                console.error('window.onload éŒ¯èª¤:', error);
            }
        };
    </script>
</body>
</html>
