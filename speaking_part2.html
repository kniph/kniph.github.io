<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SK-017 æœ—è®€ç·´ç¿’ â€” GEPT å£èªª</title>
  <script>
    if (localStorage.getItem('loggedIn') !== 'yes') {
      window.location.href = '/login.html';
    }
  </script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ™ï¸</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #0d9488, #0f766e);
      color: white;
      text-align: center;
      padding: 30px;
    }
    .header h1 { font-size: 2rem; margin-bottom: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    .header p  { font-size: 1rem; opacity: 0.9; }

    .nav-bar {
      background: rgba(0,0,0,0.15);
      padding: 10px 30px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .nav-bar a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      transition: background 0.2s;
    }
    .nav-bar a:hover, .nav-bar a.active { background: rgba(255,255,255,0.25); color: white; }

    .main { padding: 30px; }

    /* Set selector */
    .controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .controls-row label { font-weight: 600; color: #374151; }
    .controls-row select {
      padding: 8px 14px;
      border: 2px solid #d1fae5;
      border-radius: 10px;
      font-size: 0.95rem;
      color: #065f46;
      background: #f0fdf4;
      cursor: pointer;
    }
    .controls-row select:focus { outline: none; border-color: #0d9488; }

    /* Phase badge */
    .phase-badge {
      display: inline-block;
      padding: 6px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .phase-reading   { background: #fef3c7; color: #92400e; }
    .phase-recording { background: #fee2e2; color: #991b1b; }
    .phase-done      { background: #d1fae5; color: #065f46; }

    /* â”€â”€ All-items display (silent reading phase) â”€â”€ */
    .all-items-card {
      background: #f0fdfa;
      border: 2px solid #99f6e4;
      border-radius: 16px;
      padding: 24px 28px;
      margin-bottom: 20px;
    }
    .all-items-card .section-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #0f766e;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
    }
    .sentence-row {
      display: flex;
      gap: 12px;
      align-items: baseline;
      padding: 8px 0;
      border-bottom: 1px solid #ccfbf1;
    }
    .sentence-row:last-child { border-bottom: none; }
    .sentence-num {
      font-size: 0.85rem;
      font-weight: 700;
      color: #0d9488;
      min-width: 28px;
    }
    .sentence-text {
      font-size: 1.15rem;
      color: #134e4a;
      line-height: 1.6;
    }
    .sentence-row.passage-row { flex-direction: column; gap: 4px; padding-top: 12px; }
    .passage-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
    }
    .passage-text {
      font-size: 1.05rem;
      color: #134e4a;
      line-height: 1.8;
    }

    /* Highlight the currently-active sentence during recording phase */
    .sentence-row.current {
      background: #ccfbf1;
      border-radius: 10px;
      padding: 8px 12px;
      margin: 2px -12px;
    }
    .sentence-row.done-item .sentence-text,
    .sentence-row.done-item .passage-text { color: #9ca3af; }
    .sentence-row.done-item .sentence-num { color: #6ee7b7; }
    .done-check { color: #10b981; font-size: 0.9rem; margin-left: 6px; }

    /* Countdown */
    .countdown-wrap { text-align: center; margin: 16px 0; }
    .countdown-num {
      font-size: 4.5rem;
      font-weight: 800;
      color: #0d9488;
      line-height: 1;
      transition: color 0.3s;
    }
    .countdown-label { font-size: 0.9rem; color: #6b7280; margin-top: 6px; }

    /* Waveform */
    .waveform-wrap { margin: 12px 0; }
    .waveform-wrap canvas {
      width: 100%;
      height: 56px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 28px;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-teal  { background: #0d9488; color: white; }
    .btn-teal:hover:not(:disabled)  { background: #0f766e; transform: translateY(-1px); }
    .btn-gray  { background: #e5e7eb; color: #374151; }
    .btn-gray:hover:not(:disabled)  { background: #d1d5db; }

    .btn-record {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: none;
      background: #ef4444;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
      animation: pulse-ring 1.2s ease-out infinite;
    }
    @keyframes pulse-ring {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      70%  { box-shadow: 0 0 0 18px rgba(239,68,68,0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }

    .action-row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; margin: 18px 0; }
    .center { justify-content: center; }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 20px; height: 20px;
      border: 3px solid #d1fae5;
      border-top-color: #0d9488;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-row { display: flex; align-items: center; gap: 10px; color: #0f766e; font-weight: 600; margin: 12px 0; }

    /* Per-item result (shown inline below the sentence) */
    .item-result {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 6px;
      font-size: 0.88rem;
    }
    .diff-words span { display: inline-block; margin: 1px 3px; padding: 1px 6px; border-radius: 5px; font-size: 0.9rem; }
    .word-correct     { background: #d1fae5; color: #065f46; }
    .word-substituted { background: #fee2e2; color: #991b1b; text-decoration: line-through; }
    .word-deleted     { background: #fef3c7; color: #92400e; font-style: italic; }
    .word-inserted    { background: #ede9fe; color: #4c1d95; }

    /* Summary card */
    .summary-card {
      background: white;
      border: 2px solid #d1fae5;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }
    .summary-card h3 { color: #065f46; font-size: 1.15rem; margin-bottom: 16px; }
    .score-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .score-box {
      background: #f0fdfa;
      border: 1px solid #99f6e4;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    .score-box .val { font-size: 1.8rem; font-weight: 800; color: #0d9488; line-height: 1; }
    .score-box .lbl { font-size: 0.75rem; color: #6b7280; margin-top: 4px; }

    .gpt-feedback-box {
      background: #f0fdfa;
      border-radius: 10px;
      padding: 14px;
      font-size: 0.93rem;
      color: #134e4a;
      line-height: 1.6;
      margin-top: 12px;
    }

    .section-divider { border: none; border-top: 1px solid #e5e7eb; margin: 24px 0; }
    .hidden { display: none !important; }

    /* Recording item indicator */
    .recording-label {
      background: #fee2e2;
      color: #991b1b;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 0.88rem;
      font-weight: 700;
      display: inline-block;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>ğŸ™ï¸ æœ—è®€ç·´ç¿’</h1>
    <p>ç¬¬äºŒéƒ¨åˆ† â€” æœ—è®€å¥å­èˆ‡çŸ­æ–‡ï½œGEPT åˆç´šå£èªªæ¸¬é©—</p>
    <div class="nav-bar">
      <a href="essay_grader.html">âœï¸ å¯«ä½œè©•åˆ†</a>
      <a href="speaking_part1.html">ğŸ” è¤‡èª¦ç·´ç¿’</a>
      <a href="speaking_part2.html" class="active">ğŸ“– æœ—è®€ç·´ç¿’</a>
      <a href="speaking_part3.html">ğŸ’¬ å›ç­”å•é¡Œ</a>
      <a href="speaking_mock.html">ğŸ¯ å®Œæ•´æ¨¡æ“¬</a>
    </div>
  </div>

  <div class="main">

    <!-- Set selector -->
    <div class="controls-row">
      <label>è©¦å·çµ„ï¼š</label>
      <select id="setSelect" onchange="loadSet()"></select>
      <button class="btn btn-gray" onclick="restartSet()">ğŸ”„ é‡æ–°é–‹å§‹æœ¬çµ„</button>
    </div>

    <!-- Phase badge -->
    <div id="phaseBadge" class="phase-badge phase-reading">ğŸ“– é–±è®€æº–å‚™ä¸­</div>

    <!-- â”€â”€ Phase 1: Silent reading â€” all items shown at once â”€â”€ -->
    <div id="phaseReading">
      <div class="countdown-wrap">
        <div class="countdown-num" id="readCountdown">60</div>
        <div class="countdown-label">ç§’é»˜è®€æ™‚é–“ï¼ˆå¯ææ—©é»ã€Œæº–å‚™å¥½äº†ã€ï¼‰</div>
      </div>

      <!-- All items displayed together -->
      <div class="all-items-card" id="allItemsCard">
        <div class="section-label">ğŸ“„ æœ—è®€å…§å®¹ï¼ˆè«‹å…ˆé»˜è®€ 60 ç§’ï¼‰</div>
        <div id="allItemsList"></div>
      </div>

      <div class="action-row center">
        <button class="btn btn-teal" onclick="skipToRecord()">âœ… æº–å‚™å¥½äº†ï¼Œé–‹å§‹é€é¡ŒéŒ„éŸ³</button>
      </div>
    </div>

    <!-- â”€â”€ Phase 2: Recording â€” one item at a time, others dimmed â”€â”€ -->
    <div id="phaseRecording" class="hidden">

      <!-- All items still shown, current one highlighted -->
      <div class="all-items-card" id="allItemsCardRec">
        <div class="section-label" id="recSectionLabel">ğŸ”´ è«‹æœ—è®€ç¬¬ 1 é¡Œ</div>
        <div id="allItemsListRec"></div>
      </div>

      <div class="recording-label" id="recItemLabel">æ­£åœ¨éŒ„éŸ³ï¼šç¬¬ 1 é¡Œ</div>

      <div class="waveform-wrap">
        <canvas id="waveformCanvas" width="840" height="56"></canvas>
      </div>

      <div class="action-row center">
        <button class="btn-record" id="btnStop" onclick="stopCurrentItem()">â¹</button>
      </div>
      <p style="text-align:center;color:#6b7280;font-size:0.88rem;margin-top:8px">æœ—è®€å®Œç•¢å¾Œé»æ“Šåœæ­¢ï¼Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ</p>
    </div>

    <!-- Processing -->
    <div id="phaseProcessing" class="hidden">
      <div class="loading-row"><span class="spinner"></span> <span id="processingLabel">è¾¨è­˜èªéŸ³ä¸­â€¦</span></div>
    </div>

    <!-- â”€â”€ Phase 3: Full summary after all items done â”€â”€ -->
    <div id="phaseSummary" class="hidden">
      <div class="summary-card">
        <h3>ğŸ“Š æœ—è®€ç¸½çµå ±å‘Š</h3>

        <div class="score-grid">
          <div class="score-box">
            <div class="val" id="summaryAccuracy">â€”</div>
            <div class="lbl">æ•´é«”å­—è©æº–ç¢ºç‡</div>
          </div>
          <div class="score-box">
            <div class="val" id="summaryWPM">â€”</div>
            <div class="lbl">å¹³å‡èªé€Ÿ (WPM)</div>
          </div>
          <div class="score-box" style="border-color:#0d9488">
            <div class="val" id="summaryScoreA" style="color:#0f766e">â€”</div>
            <div class="lbl">è©•åˆ†Aï¼šç™¼éŸ³æµåˆ©åº¦ (0â€“5)</div>
          </div>
        </div>
        <p style="font-size:0.78rem;color:#9ca3af;margin-bottom:14px">
          â€» è©•åˆ†Aï¼ˆç™¼éŸ³ã€èªèª¿ã€æµåˆ©åº¦ï¼‰ç”± GPT æ ¹æ“š GEPT å®˜æ–¹æ¨™æº–è©•ä¼°æ•´é«”è¡¨ç¾
        </p>

        <div style="margin-bottom:10px">
          <h4 style="color:#0f766e;font-size:0.92rem;margin-bottom:8px">ğŸ™ï¸ GPT æ•´é«”è©•ä¼°</h4>
          <div class="gpt-feedback-box" id="summaryFeedbackA">è©•ä¼°ä¸­â€¦</div>
        </div>
        <div>
          <h4 style="color:#0f766e;font-size:0.92rem;margin-bottom:8px">ğŸ’¡ æ”¹é€²å»ºè­°</h4>
          <div class="gpt-feedback-box" id="summaryCoaching">â€”</div>
        </div>
      </div>

      <!-- Per-item results shown below summary -->
      <div style="margin-top:24px">
        <h3 style="color:#374151;font-size:1rem;margin-bottom:14px">å„é¡Œè©³ç´°çµæœ</h3>
        <div id="perItemResults"></div>
      </div>

      <hr class="section-divider">
      <div class="action-row">
        <button class="btn btn-teal" onclick="restartSet()">ğŸ”„ é‡æ–°ç·´ç¿’æœ¬çµ„</button>
        <button class="btn btn-gray" onclick="loadSet()">æ›ä¸€çµ„</button>
      </div>
    </div>

  </div>
</div>

<script src="speaking-utils.js"></script>
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BANK_URL = 'https://kniph.github.io/question-bank.json';
const BACKEND  = SpeakingUtils.BACKEND;
let bank = null;
let currentSet = null;
let currentItems = [];  // all 6 part2 items
let currentIdx = 0;     // which item we're recording now
let readStopFn = null;
let recStopFn  = null;
let recordingPromise = null;
let recordStartTime = 0;

// Per-item results accumulate here
let itemResults = []; // [{ transcript, diff, accuracy, wpm, durationSec }]

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const resp = await fetch(BANK_URL);
    bank = await resp.json();
    populateSetSelect();
    loadSet();
  } catch (e) {
    document.getElementById('phaseBadge').textContent = 'âš ï¸ ç„¡æ³•è¼‰å…¥é¡Œåº«ï¼š' + e.message;
  }
}

function populateSetSelect() {
  const sel = document.getElementById('setSelect');
  sel.innerHTML = '';
  bank.sets.forEach(s => {
    const has = s.part2 && s.part2.length > 0;
    const opt = document.createElement('option');
    opt.value = s.set_id;
    opt.textContent = s.set_name + (has ? '' : ' (å°šæœªæ”¶éŒ„)');
    opt.disabled = !has;
    sel.appendChild(opt);
  });
  const first = bank.sets.find(s => s.part2 && s.part2.length > 0);
  if (first) sel.value = first.set_id;
}

function loadSet() {
  if (readStopFn) { readStopFn(); readStopFn = null; }
  if (recStopFn)  { recStopFn();  recStopFn  = null; }
  SpeakingUtils.stopRecording();

  const setId = document.getElementById('setSelect').value;
  currentSet  = bank.sets.find(s => s.set_id === setId);
  currentItems = currentSet ? currentSet.part2 : [];
  currentIdx   = 0;
  itemResults  = [];

  renderAllItemsList('allItemsList', -1);   // -1 = no highlight (reading phase)
  startReadingPhase();
}

function restartSet() { loadSet(); }

// â”€â”€ Render all items list (used in both phases) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// highlightIdx: index of current recording item (-1 = none, show all neutral)
function renderAllItemsList(containerId, highlightIdx) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = currentItems.map((item, i) => {
    const isDone    = itemResults[i] !== undefined;
    const isCurrent = i === highlightIdx;
    const isPast    = highlightIdx >= 0 && i < highlightIdx;

    let cls = 'sentence-row';
    if (item.type === 'passage') cls += ' passage-row';
    if (isCurrent) cls += ' current';
    if (isDone || isPast) cls += ' done-item';

    const doneCheck = isDone
      ? `<span class="done-check">âœ“ ${itemResults[i].accuracy}%</span>` : '';

    if (item.type === 'passage') {
      return `<div class="${cls}" id="row-${containerId}-${i}">
        <div class="passage-label">çŸ­æ–‡ ${doneCheck}</div>
        <div class="passage-text">${item.text}</div>
      </div>`;
    }
    return `<div class="${cls}" id="row-${containerId}-${i}">
      <span class="sentence-num">${i + 1}.</span>
      <span class="sentence-text">${item.text} ${doneCheck}</span>
    </div>`;
  }).join('');
}

// â”€â”€ Phase 1: Silent reading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startReadingPhase() {
  hide('phaseRecording');
  hide('phaseProcessing');
  hide('phaseSummary');
  show('phaseReading');
  setBadge('reading');

  const countdown = document.getElementById('readCountdown');
  countdown.textContent = '60';
  readStopFn = SpeakingUtils.startCountdown(countdown, 60, skipToRecord);
}

function skipToRecord() {
  if (readStopFn) { readStopFn(); readStopFn = null; }
  hide('phaseReading');
  currentIdx = 0;
  startRecordingItem();
}

// â”€â”€ Phase 2: Record items one by one â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startRecordingItem() {
  show('phaseRecording');
  setBadge('recording');

  const item = currentItems[currentIdx];
  const label = item.type === 'passage' ? 'çŸ­æ–‡' : `ç¬¬ ${currentIdx + 1} é¡Œ`;

  document.getElementById('recSectionLabel').textContent = `ğŸ”´ è«‹æœ—è®€ ${label}`;
  document.getElementById('recItemLabel').textContent = `æ­£åœ¨éŒ„éŸ³ï¼š${label}`;

  renderAllItemsList('allItemsListRec', currentIdx);

  // Scroll current row into view
  setTimeout(() => {
    const row = document.getElementById(`row-allItemsListRec-${currentIdx}`);
    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);

  const canvas = document.getElementById('waveformCanvas');
  recordStartTime = Date.now();
  recordingPromise = SpeakingUtils.startRecording(90, canvas); // generous max
}

async function stopCurrentItem() {
  SpeakingUtils.stopRecording();
  hide('phaseRecording');
  show('phaseProcessing');

  const item = currentItems[currentIdx];
  document.getElementById('processingLabel').textContent =
    `è¾¨è­˜èªéŸ³ä¸­â€¦ (${item.type === 'passage' ? 'çŸ­æ–‡' : `ç¬¬ ${currentIdx + 1} é¡Œ`})`;

  try {
    const { base64 } = await recordingPromise;
    const durationSec = (Date.now() - recordStartTime) / 1000;
    const { text } = await SpeakingUtils.transcribe(base64, item.text.substring(0, 120));

    const diff     = SpeakingUtils.wordDiff(item.text, text);
    const accuracy = SpeakingUtils.calcAccuracy(diff);
    const wordCount = (text || '').split(/\s+/).filter(w => w).length;
    const wpm      = SpeakingUtils.calcWPM(wordCount, durationSec);

    itemResults[currentIdx] = { transcript: text, diff, accuracy, wpm, durationSec };

    hide('phaseProcessing');
    currentIdx++;

    if (currentIdx < currentItems.length) {
      // More items to record
      show('phaseRecording');
      startRecordingItem();
    } else {
      // All done â†’ show summary
      showSummary();
    }

  } catch (err) {
    hide('phaseProcessing');
    alert('è¾¨è­˜å¤±æ•—ï¼š' + err.message + '\nè«‹é‡æ–°ç·´ç¿’æœ¬é¡Œ');
    show('phaseRecording');
    startRecordingItem(); // retry same item
  }
}

// â”€â”€ Phase 3: Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSummary() {
  show('phaseSummary');
  setBadge('done');

  // Aggregate stats
  const accuracies = itemResults.map(r => r.accuracy);
  const wpms       = itemResults.filter(r => r.wpm > 0).map(r => r.wpm);
  const avgAccuracy = Math.round(accuracies.reduce((a, b) => a + b, 0) / accuracies.length);
  const avgWPM      = wpms.length ? Math.round(wpms.reduce((a, b) => a + b, 0) / wpms.length) : 0;

  document.getElementById('summaryAccuracy').textContent = avgAccuracy + '%';
  document.getElementById('summaryWPM').textContent = avgWPM;
  document.getElementById('summaryScoreA').textContent = 'â€¦';

  // Build all transcripts for GPT holistic evaluation
  const combined = currentItems.map((item, i) => {
    const r = itemResults[i];
    return `${i + 1}. [åƒè€ƒ] ${item.text}\n   [æœ—è®€] ${r ? r.transcript || 'ï¼ˆæœªè¾¨è­˜ï¼‰' : 'ï¼ˆæœªéŒ„éŸ³ï¼‰'}`;
  }).join('\n');

  // Per-item results display
  const perEl = document.getElementById('perItemResults');
  perEl.innerHTML = currentItems.map((item, i) => {
    const r = itemResults[i];
    if (!r) return '';
    const diffHtml = r.diff.map(d => {
      const cls = { correct:'word-correct', substituted:'word-substituted', deleted:'word-deleted', inserted:'word-inserted' }[d.status];
      return `<span class="${cls}">${d.word}</span>`;
    }).join('');

    const label = item.type === 'passage' ? 'çŸ­æ–‡' : `ç¬¬ ${i + 1} é¡Œ`;
    const wpmNote = r.wpm > 0 ? ` Â· ${r.wpm} WPM` : '';
    return `<div style="background:#f8fafc;border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid #e2e8f0">
      <div style="font-size:0.78rem;font-weight:700;color:#6b7280;text-transform:uppercase;margin-bottom:8px">
        ${label} â€” æº–ç¢ºç‡ ${r.accuracy}%${wpmNote}
      </div>
      <div style="font-size:0.88rem;color:#6b7280;margin-bottom:4px">åƒè€ƒï¼š<em>${item.text}</em></div>
      <div class="diff-words" style="margin-top:6px">${diffHtml}</div>
      <div style="font-size:0.85rem;color:#64748b;margin-top:6px;font-style:italic">
        è¾¨è­˜çµæœï¼š${r.transcript || 'ï¼ˆæœªè¾¨è­˜åˆ°èªéŸ³ï¼‰'}
      </div>
    </div>`;
  }).join('');

  // Async GPT holistic Score A evaluation of all items together
  fetch(`${BACKEND}/api/evaluate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      part: 2,
      transcript: combined,
      reference: 'ï¼ˆä»¥ä¸‹ç‚ºæœ¬æ¬¡æœ—è®€ç·´ç¿’ä¸­æ‰€æœ‰å¥å­çš„å°ç…§ï¼Œè«‹æ•´é«”è©•ä¼°ç™¼éŸ³ã€èªèª¿ã€æµåˆ©åº¦ï¼‰'
    })
  }).then(r => r.json()).then(ev => {
    document.getElementById('summaryScoreA').textContent = ev.score_a !== null ? ev.score_a : 'â€”';
    document.getElementById('summaryFeedbackA').textContent = ev.feedback_a || ev.overall || 'â€”';
    document.getElementById('summaryCoaching').textContent = ev.coaching || 'â€”';
  }).catch(() => {
    document.getElementById('summaryScoreA').textContent = 'â€”';
    document.getElementById('summaryFeedbackA').textContent = 'ï¼ˆGPT è©•ä¼°ä¸å¯ç”¨ï¼‰';
    document.getElementById('summaryCoaching').textContent = 'â€”';
  });
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }

function setBadge(phase) {
  const el = document.getElementById('phaseBadge');
  const map = {
    reading:   ['phase-reading',   'ğŸ“– é»˜è®€æº–å‚™ä¸­ï¼ˆ60ç§’ï¼‰'],
    recording: ['phase-recording', 'ğŸ”´ éŒ„éŸ³ä¸­'],
    done:      ['phase-done',      'âœ… ç·´ç¿’å®Œæˆ']
  };
  el.className = 'phase-badge ' + map[phase][0];
  el.textContent = map[phase][1];
}

init();
</script>
</body>
</html>
