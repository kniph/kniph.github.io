<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Scheduling System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root" class="container mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Define constants
    const days = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];

    // Define course durations
    const courseDurations = [
      { value: 1, label: '1å°æ™‚' },
      { value: 1.5, label: '1.5å°æ™‚' },
      { value: 2, label: '2å°æ™‚' },
      { value: 3, label: '3å°æ™‚' }
    ];

    // å®šç¾©èª²ç¨‹é¡è‰²é¸é …
    const courseColors = [
      { bg: 'bg-blue-100', text: 'text-blue-800', hover: 'hover:bg-blue-200', border: 'border-blue-300' },
      { bg: 'bg-green-100', text: 'text-green-800', hover: 'hover:bg-green-200', border: 'border-green-300' },
      { bg: 'bg-yellow-100', text: 'text-yellow-800', hover: 'hover:bg-yellow-200', border: 'border-yellow-300' },
      { bg: 'bg-red-100', text: 'text-red-800', hover: 'hover:bg-red-200', border: 'border-red-300' },
      { bg: 'bg-purple-100', text: 'text-purple-800', hover: 'hover:bg-purple-200', border: 'border-purple-300' },
      { bg: 'bg-pink-100', text: 'text-pink-800', hover: 'hover:bg-pink-200', border: 'border-pink-300' },
      { bg: 'bg-indigo-100', text: 'text-indigo-800', hover: 'hover:bg-indigo-200', border: 'border-indigo-300' },
      { bg: 'bg-gray-100', text: 'text-gray-800', hover: 'hover:bg-gray-200', border: 'border-gray-300' },
    ];

    // Generate weekday hours (13-21) and saturday hours (9-20)
    const generateHourSlots = () => {
      const weekdayHours = Array.from({ length: 9 }, (_, i) => i + 13); // 13 to 21
      const saturdayHours = Array.from({ length: 12 }, (_, i) => i + 9); // 9 to 20

      // Create mapping of day to available hours
      return {
        'æ˜ŸæœŸä¸€': weekdayHours,
        'æ˜ŸæœŸäºŒ': weekdayHours,
        'æ˜ŸæœŸä¸‰': weekdayHours,
        'æ˜ŸæœŸå››': weekdayHours,
        'æ˜ŸæœŸäº”': weekdayHours,
        'æ˜ŸæœŸå…­': saturdayHours,
      };
    };

    const hourSlots = generateHourSlots();
    // Get all unique hours for display
    const allHours = [...new Set([].concat(...Object.values(hourSlots)))].sort((a, b) => a - b);

    // Realize Grid Layout
    const TimeSlotCourseGrid = ({ day, hour, courses, onRemoveCourse }) => {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [selectedCourse, setSelectedCourse] = useState(null);

      // Open Modal Detail
      const openCourseDetail = (course) => {
        setSelectedCourse(course);
        setIsModalOpen(true);
      };
    
      // Deal with Removed Course
      const handleRemoveCourse = (index, e) => {
        e.stopPropagation();
        onRemoveCourse(day, hour, index);
      };

      return (
        <>
          {/* ç¶²æ ¼å¼ä½ˆå±€-æ¯è¡Œæœ€å¤šå…©å€‹èª²ç¨‹ */}
          <div className="grid grid-cols-2 gap-1 w-full">
            {courses.map((course, index) => {
              // ä½¿ç”¨èª²ç¨‹é¡è‰²ï¼Œå¦‚æœæœªå®šç¾©å‰‡ä½¿ç”¨é»˜èªè—è‰²
              const courseColor = course.color || { 
                bg: 'bg-blue-100', 
                text: 'text-blue-800', 
                hover: 'hover:bg-blue-200',
                border: 'border-blue-300'
              };
              
              // è™•ç†èª²ç¨‹åç¨±çš„å‚ç›´é¡¯ç¤º
              const formatVerticalName = (name) => {
                // å¦‚æœæ˜¯è‹±æ–‡åç¨±ï¼Œç›´æ¥æŒ‰å­—å…ƒå‚ç›´æ’åˆ—
                if (/^[A-Za-z0-9\s]+$/.test(name)) {
                  return name.split('').join('\n');
                }
                
                // è™•ç†ç‰¹æ®Šæ ¼å¼ï¼šã€Œåœ‹äºŒæ•¸å­¸Bç­ã€
                const gradeSubjectPattern = /(åœ‹|é«˜|åœ‹å°)([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹])(æ•¸å­¸|è‹±æ–‡|åœ‹æ–‡|ç†åŒ–|ç‰©ç†|åŒ–å­¸|ç”Ÿç‰©|åœ°ç†|æ­·å²|å…¬æ°‘)([A-Z])?ç­?/;
                const match = name.match(gradeSubjectPattern);
                
                if (match) {
                  let result = match[1] + '\n' + match[2] + '\n';
                  // å°‡ç§‘ç›®åç¨±æ‹†åˆ†
                  if (match[3] === 'æ•¸å­¸') result += 'æ•¸\nå­¸\n';
                  else if (match[3] === 'è‹±æ–‡') result += 'è‹±\næ–‡\n';
                  else if (match[3] === 'åœ‹æ–‡') result += 'åœ‹\næ–‡\n';
                  else if (match[3] === 'ç†åŒ–') result += 'ç†\nåŒ–\n';
                  else if (match[3] === 'ç‰©ç†') result += 'ç‰©\nç†\n';
                  else if (match[3] === 'åŒ–å­¸') result += 'åŒ–\nå­¸\n';
                  else if (match[3] === 'ç”Ÿç‰©') result += 'ç”Ÿ\nç‰©\n';
                  else if (match[3] === 'åœ°ç†') result += 'åœ°\nç†\n';
                  else if (match[3] === 'æ­·å²') result += 'æ­·\nå²\n';
                  else if (match[3] === 'å…¬æ°‘') result += 'å…¬\næ°‘\n';
                  else result += match[3].split('').join('\n') + '\n';
                  
                  // æ·»åŠ ç­ç´šæ¨™è­˜
                  if (match[4]) result += match[4] + '\n';
                  result += 'ç­';
                  return result;
                }
                
                // å…¶ä»–æƒ…æ³ï¼šå®Œå…¨å‚ç›´é¡¯ç¤ºæ‰€æœ‰å­—å…ƒ
                return name.split('').join('\n');
              };
              
              // å°‡èª²ç¨‹åç¨±è½‰ç‚ºå‚ç›´é¡¯ç¤º
              const verticalName = formatVerticalName(course.name);
              
              return (
                <div
                  key={`${course.id}-${index}`} 
                  className={`${courseColor.bg} ${courseColor.text} rounded p-1 relative cursor-pointer ${courseColor.hover} border ${courseColor.border} flex`}
                  onClick={() => openCourseDetail(course)}
                  title={`é»æ“ŠæŸ¥çœ‹ ${course.name} è©³æƒ…`}
                >
                  <div className="absolute top-0.5 right-0.5 z-20">
                    <button
                      className="text-gray-500 hover:text-red-500 text-xs bg-white bg-opacity-70 rounded-full w-4 h-4 flex items-center justify-center"
                      onClick={(e) => handleRemoveCourse(index, e)}
                      title="ç§»é™¤èª²ç¨‹"
                    >
                      Ã—
                    </button>
                  </div>
                  
                  {/* å‚ç›´é¡¯ç¤ºèª²ç¨‹åç¨± */}
                  <div className="font-medium text-xs mr-1 leading-tight whitespace-pre" style={{ width: 'auto', minWidth: '1rem' }}>
                    {verticalName}
                  </div>
                  
                  {/* å³å´é¡¯ç¤ºå­¸ç”Ÿæ•¸å’Œæ™‚é•· */}
                  <div className="text-xs text-gray-600 ml-auto flex flex-col justify-center">
                    <div>{course.students.length}äºº</div>
                    <div>{course.duration}å°æ™‚</div>
                  </div>
                </div>
              );
            })}
          </div>
        
          {/* èª²ç¨‹è©³æƒ…å½ˆçª— */}
          {isModalOpen && selectedCourse && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <div className="flex justify-between items-center mb-4">
                  <h2 className={`text-xl font-bold ${selectedCourse.color?.text || 'text-blue-800'}`}>
                    {selectedCourse.name}
                  </h2>
                  <button
                    onClick={() => setIsModalOpen(false)}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    Ã—
                  </button>
                </div>
              
                <div className="mb-6">
                  <div className={`${selectedCourse.color?.bg || 'bg-blue-50'} p-4 rounded`}>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <p className="text-sm text-gray-500">èª²ç¨‹æ™‚æ®µ</p>
                        <p className="font-medium">{day} {hour}:00</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-500">èª²ç¨‹æ™‚é•·</p>
                        <p className="font-medium">{selectedCourse.duration} å°æ™‚</p>
                      </div>
                    </div>
                    
                    <div>
                      <p className="text-sm text-gray-500 mb-1">å­¸ç”Ÿåå–® ({selectedCourse.students.length}äºº)</p>
                      {selectedCourse.students.length === 0 ? (
                        <p className="text-gray-500">(å°šç„¡å­¸ç”Ÿ)</p>
                      ) : (
                        <ul className="list-disc pl-5 text-sm max-h-48 overflow-y-auto">
                          {selectedCourse.students.map((student, idx) => (
                            <li key={idx}>
                              {student.name}ï¼ˆ{student.school}ãƒ»{student.grade}ï¼‰
                            </li>
                          ))}
                        </ul>
                      )}
                    </div>
                  </div>
                </div>
              
                <div className="flex justify-end gap-2">
                  <button
                    className="px-4 py-2 border rounded hover:bg-gray-50"
                    onClick={() => setIsModalOpen(false)}
                  >
                    é—œé–‰
                  </button>
                  <button
                    className={`px-4 py-2 ${selectedCourse.color?.bg || 'bg-blue-500'} ${selectedCourse.color?.text || 'text-white'} rounded ${selectedCourse.color?.hover || 'hover:bg-blue-600'}`}
                    onClick={() => {
                      setIsModalOpen(false);
                    }}
                  >
                    ç·¨è¼¯èª²ç¨‹
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    };
      
    // Course component with hover functionality
    const CourseComponent = ({ course, actions, inCalendar = false }) => {
      const [isHovering, setIsHovering] = useState(false);

      // ä½¿ç”¨èª²ç¨‹é¡è‰²ï¼Œå¦‚æœæœªå®šç¾©å‰‡ä½¿ç”¨é»˜èªè—è‰²
      const courseColor = course.color || { 
        bg: 'bg-blue-100', 
        text: 'text-blue-800', 
        hover: 'hover:bg-blue-200',
        border: 'border-blue-300'
      };

      // Calculate height based on duration for calendar display
      const getHeightStyle = () => {
        if (!inCalendar) return {};

        const duration = course.duration || 1;
        // Assuming base height of a 1-hour slot is roughly h-24 (6rem)
        // Adjust multiplier based on actual cell height and desired visual representation
        const baseHeightRem = 6;
        const height = baseHeightRem * duration;
        // Subtract padding/margin if needed, e.g., mb-1 is 0.25rem
        const verticalSpacingRem = 0.25;
        return {
             height: `calc(${height}rem - ${verticalSpacingRem}rem)`,
             // Ensure content doesn't overflow if height is small
             overflow: 'hidden',
             // Position relative needed for potential absolute positioning inside
             position: 'relative',
        };
      };

      return (
        <div
          className={`${inCalendar ? courseColor.bg : 'bg-white'} p-3 rounded 
                     ${!inCalendar && 'shadow border'} ${!inCalendar && 'cursor-move'} 
                     ${courseColor.text} mb-1 ${inCalendar ? 'border ' + courseColor.border : ''}`}
          style={getHeightStyle()}
          onMouseEnter={() => inCalendar ? null : setIsHovering(true)}
          onMouseLeave={() => inCalendar ? null : setIsHovering(false)}
          draggable={!inCalendar ? "true" : "false"}
          onDragStart={!inCalendar ? actions.onDragStart : null}
        >
          <div className="flex justify-between items-start">
            <h4 className="font-semibold text-sm">{course.name}</h4>
            <div className="flex gap-1 flex-shrink-0">
              {actions.buttons}
            </div>
          </div>

          <div className="text-xs text-gray-600 mt-1">
            å­¸ç”Ÿï¼š{course.students.length}äºº
            {course.duration && <span className="ml-2">({course.duration}å°æ™‚)</span>}
          </div>

          {/* Hover effect only for candidate courses */}
          {!inCalendar && isHovering && (
            <div className="absolute text-sm mt-1 bg-white p-2 rounded shadow-lg border border-gray-200 z-20 max-w-xs">
              <div className="font-semibold mb-1">å­¸ç”Ÿåå–®ï¼š</div>
              <ul className="list-disc pl-5 text-gray-700">
                {course.students.map((student, idx) => (
                  <li key={idx}>
                    {student.name}ï¼ˆ{student.school}ãƒ»{student.grade}ï¼‰
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      );
    };

    function App() {
      // Main application states
      const [courses, setCourses] = useState([]);
      const [calendarItems, setCalendarItems] = useState(
        days.reduce((acc, day) => ({ ...acc, [day]: {} }), {})
      );
      const [conflictStudents, setConflictStudents] = useState([]);

      // Course creation states
      const [newCourseName, setNewCourseName] = useState('');
      const [newStudentName, setNewStudentName] = useState('');
      const [newStudentSchool, setNewStudentSchool] = useState('');
      const [newStudentGrade, setNewStudentGrade] = useState('');
      const [newCourseDuration, setNewCourseDuration] = useState(1); // Default to 1 hour
      const [tempStudents, setTempStudents] = useState([]);
      const [newCourseColor, setNewCourseColor] = useState(courseColors[0]); // é»˜èªé¡è‰²

      // Course editing states
      const [editingCourse, setEditingCourse] = useState(null);
      const [editStudentName, setEditStudentName] = useState('');
      const [editStudentSchool, setEditStudentSchool] = useState('');
      const [editStudentGrade, setEditStudentGrade] = useState('');

      // Load data from localStorage on initial render
      useEffect(() => {
        const savedCourses = localStorage.getItem('courses');
        const savedCalendar = localStorage.getItem('calendarItems');

        if (savedCourses) {
          // Ensure duration and color are loaded correctly
           const loadedCourses = JSON.parse(savedCourses).map(c => ({
             ...c,
             duration: c.duration || 1,
             color: c.color || courseColors[0] // ç¢ºä¿é¡è‰²è³‡è¨Šå­˜åœ¨
           }));
          setCourses(loadedCourses);
        }

        if (savedCalendar) {
          // Ensure courses within calendar also have duration and color
          const loadedCalendar = JSON.parse(savedCalendar);
          Object.keys(loadedCalendar).forEach(day => {
            Object.keys(loadedCalendar[day]).forEach(hour => {
              loadedCalendar[day][hour] = loadedCalendar[day][hour].map(c => ({
                ...c,
                duration: c.duration || 1,
                color: c.color || courseColors[0] // ç¢ºä¿é¡è‰²è³‡è¨Šå­˜åœ¨
              }));
            });
          });
          setCalendarItems(loadedCalendar);
        }
      }, []);

      // Save data to localStorage when it changes
      useEffect(() => {
        localStorage.setItem('courses', JSON.stringify(courses));
      }, [courses]);

      useEffect(() => {
        localStorage.setItem('calendarItems', JSON.stringify(calendarItems));
      }, [calendarItems]);

      // Add a student to the temporary student list
      const addTempStudent = () => {
        if (newStudentName && newStudentSchool && newStudentGrade) {
          setTempStudents([...tempStudents, {
            name: newStudentName,
            school: newStudentSchool,
            grade: newStudentGrade
          }]);
          setNewStudentName('');
          setNewStudentSchool('');
          setNewStudentGrade('');
        } else {
          alert('è«‹å¡«å¯«å­¸ç”Ÿçš„æ‰€æœ‰æ¬„ä½');
        }
      };

      // Create a new course with the collected students
      const createNewCourse = () => {
        if (newCourseName && tempStudents.length > 0) {
          const newId = `course-${Date.now()}`;
          const newCourse = {
            id: newId,
            name: newCourseName,
            students: tempStudents,
            duration: parseFloat(newCourseDuration),
            color: newCourseColor // æ·»åŠ é¡è‰²å±¬æ€§
          };
          setCourses([...courses, newCourse]);
          setNewCourseName('');
          setTempStudents([]);
          setNewCourseDuration(1); // Reset to default duration
          setNewCourseColor(courseColors[0]); // é‡ç½®ç‚ºé è¨­é¡è‰²
        } else {
          alert('è«‹è¼¸å…¥èª²ç¨‹åç¨±ä¸¦è‡³å°‘æ·»åŠ ä¸€ä½å­¸ç”Ÿ');
        }
      };

      // Delete a course from the candidate list
      const deleteCourse = (courseId) => {
        setCourses(courses.filter(course => course.id !== courseId));
      };

      // Clone an existing course
      const cloneCourse = (courseId) => {
        const course = courses.find(c => c.id === courseId);
        if (course) {
          const newId = `course-${Date.now()}`;
          const clonedCourse = { ...course, id: newId };
          setCourses([...courses, clonedCourse]);
        }
      };

      // Start editing a course
      const startEditCourse = (course) => {
        setEditingCourse({
          ...course,
          duration: course.duration || 1, // Ensure duration exists
          color: course.color || courseColors[0] // ç¢ºä¿é¡è‰²è³‡è¨Šå­˜åœ¨
        });
        setEditStudentName('');
        setEditStudentSchool('');
        setEditStudentGrade('');
      };

      // Add a student to the course being edited
      const addStudentToEditingCourse = () => {
        if (editStudentName && editStudentSchool && editStudentGrade) {
          const newStudent = {
            name: editStudentName,
            school: editStudentSchool,
            grade: editStudentGrade
          };
          setEditingCourse({
            ...editingCourse,
            students: [...editingCourse.students, newStudent]
          });
          setEditStudentName('');
          setEditStudentSchool('');
          setEditStudentGrade('');
        } else {
          alert('è«‹å¡«å¯«å­¸ç”Ÿçš„æ‰€æœ‰æ¬„ä½');
        }
      };

      // Remove a student from the course being edited
      const removeStudentFromEditingCourse = (index) => {
        const newStudents = [...editingCourse.students];
        newStudents.splice(index, 1);
        setEditingCourse({ ...editingCourse, students: newStudents });
      };

      // Save the edited course
      const saveEditedCourse = () => {
        setCourses(
          courses.map(c => c.id === editingCourse.id ? editingCourse : c)
        );
        // Also update the course if it's already in the calendar
        const updatedCalendar = { ...calendarItems };
        let courseFoundInCalendar = false;
        
        Object.keys(updatedCalendar).forEach(day => {
            Object.keys(updatedCalendar[day]).forEach(hour => {
                const courseIndex = updatedCalendar[day][hour].findIndex(c => c.id === editingCourse.id);
                if (courseIndex !== -1) {
                    updatedCalendar[day][hour][courseIndex] = editingCourse;
                    courseFoundInCalendar = true;
                }
            });
        });
        
        if (courseFoundInCalendar) {
            setCalendarItems(updatedCalendar);
        }

        setEditingCourse(null);
      };

      // Check if a specific time slot is available and within bounds
      const isSlotAvailable = (day, hour) => {
        const hourNum = parseFloat(hour);
        
        // æª¢æŸ¥æ­¤å°æ™‚æ˜¯å¦åœ¨å¯ç”¨æ™‚é–“ç¯„åœå…§
        const isHourInRange = hourSlots[day]?.includes(Math.floor(hourNum));
        if (!isHourInRange) return false;
        
        // æª¢æŸ¥æ˜¯å¦è¢«å…¶ä»–èª²ç¨‹ä½”ç”¨ (æª¢æŸ¥æ˜¯å¦æœ‰èª²ç¨‹å»¶ä¼¸åˆ°é€™å€‹æ™‚æ®µ)
        const isOccupied = calendarItems[day] && 
          Object.entries(calendarItems[day]).some(([startHour, courses]) => {
            return courses.some(course => {
              const startHourNum = parseInt(startHour);
              const endHour = startHourNum + (course.duration || 1);
              // å¦‚æœç•¶å‰å°æ™‚åœ¨æŸèª²ç¨‹çš„æ™‚é–“ç¯„åœå…§(ä½†ä¸æ˜¯é–‹å§‹æ™‚é–“)ï¼Œé‚£éº¼å®ƒè¢«ä½”ç”¨
              return hour > startHourNum && hour < endHour;
            });
          });
        
        return !isOccupied;
      };

      // è¨ˆç®—è·¨æ¬„èª²ç¨‹çš„ä½ç½®å’Œå¤§å°
      const calculateCoursePosition = (day, hour, course, courseIndex, courseCount) => {
        // æ‰¾åˆ°å°æ‡‰çš„èµ·å§‹å–®å…ƒæ ¼ä½ç½®
        const startHourNum = parseInt(hour);
        const startHourRowIndex = allHours.findIndex(h => h === startHourNum);
        if (startHourRowIndex === -1) return null;
        
        // ç²å–æ—¥æœŸåˆ—çš„ç´¢å¼•
        const dayIndex = days.indexOf(day);
        if (dayIndex === -1) return null;
        
        // è¨ˆç®—èª²ç¨‹æ‡‰è©²ä½”æ“šçš„ç©ºé–“
        const duration = course.duration || 1;
        const courseHeight = duration * 6 - 0.5; // 6rem æ˜¯åŸºæœ¬å–®å…ƒæ ¼é«˜åº¦ï¼Œæ¸›å°‘ä¸€äº›é–“è·
        
        // è¡¨æ ¼ç›¸é—œå°ºå¯¸
        const cell = document.querySelector(`td[data-day="${day}"][data-hour="${hour}"]`);
        const cellRect = cell?.getBoundingClientRect();
        
        if (!cellRect) {
          // å¦‚æœç„¡æ³•ç²å–å–®å…ƒæ ¼ä½ç½®ï¼Œä½¿ç”¨é è¨­è¨ˆç®—æ–¹å¼
          const headerHeight = 2.5; // è¡¨é ­é«˜åº¦ (rem)
          const firstRowOffset = 0.5; // ç¬¬ä¸€è¡Œçš„é¡å¤–åç§»é‡ (rem)
          const tableWidth = document.querySelector('table')?.offsetWidth || 1000;
          const dayCellWidth = (tableWidth - 64) / days.length; // 64pxæ˜¯æ™‚é–“åˆ—çš„å¯¬åº¦
          const leftOffset = 64 + (dayIndex * dayCellWidth); // å·¦åç§»é‡ (px)
          
          // è¨ˆç®—èª²ç¨‹å¯¬åº¦å’Œä½ç½®
          const width = dayCellWidth * 0.95; // 95%çš„å–®å…ƒæ ¼å¯¬åº¦
          const top = `calc(${startHourRowIndex * 6}rem + ${headerHeight + firstRowOffset}rem)`;
          
          return {
            top: top,
            left: `${leftOffset}px`,
            width: `${width}px`,
            height: `${courseHeight}rem`
          };
        }
        
        // ä½¿ç”¨å¯¦éš›çš„å–®å…ƒæ ¼å°ºå¯¸
        const top = cellRect.top + window.scrollY;
        const left = cellRect.left + window.scrollX;
        const width = cellRect.width;
        
        // å¤šå€‹èª²ç¨‹æ’åˆ—
        const courseWidth = courseCount > 1 ? (width / courseCount) - 2 : width - 4;
        const courseLeft = left + (courseIndex * (width / courseCount)) + 2;
        
        return {
          top: `${top}px`,
          left: `${courseLeft}px`,
          width: `${courseWidth}px`,
          height: `${courseHeight}rem`
        };
      };

      // æ¸²æŸ“å»¶å±•çš„èª²ç¨‹ (è·¨æ¬„æ•ˆæœ)
      const renderExtendedCourses = () => {
        // å­˜å„²æ‰€æœ‰æ¸²æŸ“çš„è·¨æ¬„èª²ç¨‹
        const extendedCourseElements = [];
        
        // éæ­·æ¯ä¸€å¤©å’Œæ¯å€‹æ™‚é–“æ®µ
        days.forEach((day, dayIndex) => {
          if (!calendarItems[day]) return;
          
          Object.entries(calendarItems[day]).forEach(([startHour, courses]) => {
            const startHourNum = parseInt(startHour);
            
            // è¨ˆç®—æ¯å€‹èª²ç¨‹çš„ä½ç½®å’Œé«˜åº¦
            courses.forEach((course, courseIndex) => {
              if (course.duration <= 1) return; // åªè™•ç†æŒçºŒæ™‚é–“å¤§æ–¼1å°æ™‚çš„èª²ç¨‹
              
              // æ‰¾åˆ°å°æ‡‰çš„èµ·å§‹å–®å…ƒæ ¼ä½ç½®
              const startHourRowIndex = allHours.findIndex(h => h === startHourNum);
              if (startHourRowIndex === -1) return;
              
              // è¨ˆç®—èª²ç¨‹æ‡‰è©²ä½”æ“šçš„ç©ºé–“
              const courseHeight = course.duration * 6 - 0.5; // 6rem æ˜¯åŸºæœ¬å–®å…ƒæ ¼é«˜åº¦ï¼Œæ¸›å°‘ä¸€äº›é–“è·
              
              // å‰µå»ºä¸€å€‹çµ•å°å®šä½çš„å…ƒç´ ä¾†è¡¨ç¤ºè·¨æ¬„èª²ç¨‹
              const courseColor = course.color || { 
                bg: 'bg-blue-100', 
                text: 'text-blue-800', 
                hover: 'hover:bg-blue-200',
                border: 'border-blue-300'
              };
              
              // è¨ˆç®—ä½ç½® (æ ¹æ“šå¯¦éš›ä½ˆå±€èª¿æ•´)
              const headerHeight = 2.5; // è¡¨é ­é«˜åº¦ (rem)
              const firstRowOffset = 0.5; // ç¬¬ä¸€è¡Œçš„é¡å¤–åç§»é‡ (rem)
              
              // ç²å–è¡¨æ ¼å’Œå–®å…ƒæ ¼çš„å°ºå¯¸
              const tableElement = document.querySelector('table');
              const tableWidth = tableElement?.offsetWidth || 940;
              const timeColWidth = 64; // æ™‚é–“åˆ—å¯¬åº¦ (px)
              const dayCellWidth = (tableWidth - timeColWidth) / days.length;
              
              // è¨ˆç®—èª²ç¨‹åœ¨æ ¼å­ä¸­çš„ä½ç½®
              const courseCount = courses.length;
              const leftPosition = timeColWidth + (dayIndex * dayCellWidth);
              const courseWidth = courseCount > 1 ? (dayCellWidth / courseCount) - 4 : dayCellWidth - 6;
              const courseLeft = leftPosition + (courseIndex * (dayCellWidth / courseCount)) + 3;
              
              // è™•ç†èª²ç¨‹åç¨±çš„å‚ç›´é¡¯ç¤º
              const formatVerticalName = (name) => {
                // å¦‚æœæ˜¯è‹±æ–‡åç¨±ï¼Œç›´æ¥æŒ‰å­—å…ƒå‚ç›´æ’åˆ—
                if (/^[A-Za-z0-9\s]+$/.test(name)) {
                  return name.split('').join('\n');
                }
                
                // è™•ç†ç‰¹æ®Šæ ¼å¼ï¼šã€Œåœ‹äºŒæ•¸å­¸Bç­ã€
                const gradeSubjectPattern = /(åœ‹|é«˜|åœ‹å°)([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹])(æ•¸å­¸|è‹±æ–‡|åœ‹æ–‡|ç†åŒ–|ç‰©ç†|åŒ–å­¸|ç”Ÿç‰©|åœ°ç†|æ­·å²|å…¬æ°‘)([A-Z])?ç­?/;
                const match = name.match(gradeSubjectPattern);
                
                if (match) {
                  let result = match[1] + '\n' + match[2] + '\n';
                  // å°‡ç§‘ç›®åç¨±æ‹†åˆ†
                  if (match[3] === 'æ•¸å­¸') result += 'æ•¸\nå­¸\n';
                  else if (match[3] === 'è‹±æ–‡') result += 'è‹±\næ–‡\n';
                  else if (match[3] === 'åœ‹æ–‡') result += 'åœ‹\næ–‡\n';
                  else if (match[3] === 'ç†åŒ–') result += 'ç†\nåŒ–\n';
                  else if (match[3] === 'ç‰©ç†') result += 'ç‰©\nç†\n';
                  else if (match[3] === 'åŒ–å­¸') result += 'åŒ–\nå­¸\n';
                  else if (match[3] === 'ç”Ÿç‰©') result += 'ç”Ÿ\nç‰©\n';
                  else if (match[3] === 'åœ°ç†') result += 'åœ°\nç†\n';
                  else if (match[3] === 'æ­·å²') result += 'æ­·\nå²\n';
                  else if (match[3] === 'å…¬æ°‘') result += 'å…¬\næ°‘\n';
                  else result += match[3].split('').join('\n') + '\n';
                  
                  // æ·»åŠ ç­ç´šæ¨™è­˜
                  if (match[4]) result += match[4] + '\n';
                  result += 'ç­';
                  return result;
                }
                
                // å…¶ä»–æƒ…æ³ï¼šå®Œå…¨å‚ç›´é¡¯ç¤ºæ‰€æœ‰å­—å…ƒ
                return name.split('').join('\n');
              };
              
              // å°‡èª²ç¨‹åç¨±è½‰ç‚ºå‚ç›´é¡¯ç¤º
              const verticalName = formatVerticalName(course.name);
              
              const style = {
                top: `calc(${startHourRowIndex * 6}rem + ${headerHeight + firstRowOffset}rem)`,
                left: `${courseLeft}px`,
                width: `${courseWidth}px`,
                height: `${courseHeight}rem`,
                zIndex: 5,
                pointerEvents: 'none',
                borderWidth: '1px',
                borderStyle: 'solid',
                transition: 'all 0.2s ease',
                overflow: 'hidden'
              };
              
              // è¦–è¦ºä¸Šçš„æ”¹é€² - å‚ç›´é¡¯ç¤ºèª²ç¨‹åç¨±
              const extendedCourse = (
                <div 
                  key={`extended-${day}-${startHour}-${courseIndex}`}
                  className={`absolute ${courseColor.bg} ${courseColor.text} rounded-sm ${courseColor.border}`}
                  style={style}
                >
                  {/* å‚ç›´é¡¯ç¤ºçš„èª²ç¨‹å…§å®¹ */}
                  <div className="p-1 flex h-full">
                    {/* å‚ç›´é¡¯ç¤ºèª²ç¨‹åç¨± */}
                    <div className="font-medium text-xs leading-tight whitespace-pre" style={{ width: 'auto', minWidth: '1rem' }}>
                      {verticalName}
                    </div>
                    
                    {/* å³å´é¡¯ç¤ºæ™‚é•·å’Œäººæ•¸ */}
                    {courseWidth > 50 && (
                      <div className="text-xs ml-auto flex flex-col justify-center">
                        <div>{course.students.length}äºº</div>
                        <div>{course.duration}æ™‚</div>
                      </div>
                    )}
                  </div>
                </div>
              );
              
              extendedCourseElements.push(extendedCourse);
            });
          });
        });
        
        return extendedCourseElements;
      };

      // Add a course to the calendar
      const addCourseToCalendar = (courseId, day, hour) => {
        const courseToAdd = courses.find(c => c.id === courseId);
        if (!courseToAdd) return;

        const startHourNum = parseInt(hour);
        const duration = courseToAdd.duration || 1;
        const endHour = startHourNum + duration; // End hour (exclusive)

        // --- Refined Availability & Conflict Check ---
        let conflicts = [];
        let canPlace = true;

        // 1. Check if all required slots are within the valid time range for the day
        for (let h = startHourNum; h < endHour; h += 0.5) { // Check in 0.5h increments
            const currentCheckHour = Math.floor(h); // The integer hour slot to check
            if (!hourSlots[day]?.includes(currentCheckHour)) {
                alert(`ç„¡æ³•å°‡èª²ç¨‹åŠ å…¥æ­¤æ™‚æ®µï¼šèª²ç¨‹æ™‚é•· (${duration}å°æ™‚) è¶…å‡º ${day} çš„å¯ç”¨æ™‚é–“ç¯„åœã€‚`);
                canPlace = false;
                break;
            }
        }
        if (!canPlace) return;

        // 2. æª¢æŸ¥è©²èª²ç¨‹çš„æ‰€æœ‰éœ€ä½”ç”¨æ™‚æ®µæ˜¯å¦å·²è¢«ä½”ç”¨
        for (let h = startHourNum + 1; h < endHour; h++) {
            // è·³éé–‹å§‹æ™‚æ®µï¼Œå› ç‚ºå¯ä»¥æœ‰å¤šå€‹èª²ç¨‹åœ¨åŒä¸€èµ·å§‹æ™‚æ®µ
            if (calendarItems[day]?.[h]?.length > 0) {
                alert(`ç„¡æ³•å°‡èª²ç¨‹åŠ å…¥æ­¤æ™‚æ®µï¼š${day} ${h}:00 å·²è¢«å…¶ä»–èª²ç¨‹ä½”ç”¨ã€‚`);
                canPlace = false;
                break;
            }
        }
        if (!canPlace) return;

        // 3. Check for student conflicts in all slots the new course will occupy
        for (let h = startHourNum; h < endHour; h++) { // Check integer hours
            Object.entries(calendarItems[day] || {}).forEach(([existingStartHour, existingCourses]) => {
                const existingStartHourNum = parseInt(existingStartHour);
                existingCourses.forEach(existingCourse => {
                    const existingEndHour = existingStartHourNum + (existingCourse.duration || 1);
                    // æª¢æŸ¥æ­¤å°æ™‚æ˜¯å¦è¢«ç¾æœ‰èª²ç¨‹è¦†è“‹
                    if (h >= existingStartHourNum && h < existingEndHour) {
                        // æª¢æŸ¥å­¸ç”Ÿè¡çª
                        const slotConflicts = courseToAdd.students.filter(newStudent =>
                            existingCourse.students.some(existingStudent => 
                                existingStudent.name === newStudent.name)
                        );
                        conflicts = [...conflicts, ...slotConflicts];
                    }
                });
            });
        }

        // Remove duplicate student conflicts
        conflicts = conflicts.filter((student, index, self) =>
          index === self.findIndex(s => s.name === student.name)
        );

        if (conflicts.length > 0) {
          setConflictStudents(conflicts.map(s =>
            `${s.name}ï¼ˆ${s.school}ãƒ»${s.grade}ï¼‰`
          ));
          // Don't necessarily block placement, just warn
          alert(`æ³¨æ„ï¼š${conflicts.map(s=>s.name).join(', ')} åœ¨æ­¤æ™‚æ®µæœ‰å…¶ä»–èª²ç¨‹ï¼Œè«‹æŸ¥çœ‹å³å´è¡çªå€ã€‚`);
        } else {
          setConflictStudents([]);
        }

        // --- Add the course (only to start slot) ---
        const updatedCalendar = { ...calendarItems };
        if (!updatedCalendar[day][startHourNum]) {
          updatedCalendar[day][startHourNum] = [];
        }
        updatedCalendar[day][startHourNum].push(courseToAdd);
        setCalendarItems(updatedCalendar);

        // Remove the course from the candidate list
        setCourses(courses.filter(c => c.id !== courseId));
      };

      // Handle drag start
      const handleDragStart = (e, courseId) => {
        e.dataTransfer.setData('courseId', courseId);
        e.dataTransfer.effectAllowed = 'move';
      };

      // Handle drag over
      const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      // Handle drop
      const handleDrop = (e, day, hour) => {
        e.preventDefault();
        const courseId = e.dataTransfer.getData('courseId');
        if (courseId) {
          addCourseToCalendar(courseId, day, hour);
        }
      };

      // Remove a course from the calendar
      const removeCourseFromCalendar = (day, hour, index) => {
        const hourNum = parseInt(hour);
        const updatedCalendar = { ...calendarItems };

        if (!updatedCalendar[day]?.[hourNum]) return;

        const removedCourse = updatedCalendar[day][hourNum][index];

        // Remove the course from the calendar start slot
        updatedCalendar[day][hourNum].splice(index, 1);
        if (updatedCalendar[day][hourNum].length === 0) {
          delete updatedCalendar[day][hourNum];
        }
        setCalendarItems(updatedCalendar);

        // Add the course back to the candidate list
        if (removedCourse) {
            setCourses([...courses, removedCourse]);
        }

        // Clear conflict display
        setConflictStudents([]);
      };

      // Export data to JSON
      const handleExportData = () => {
        const data = { courses, calendarItems };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'å‚‘ç«‹æ’èª²è³‡æ–™.json';
        a.click();
        URL.revokeObjectURL(url);
      };

      // --- JSX Structure ---
      return (
        <div className="max-w-7xl mx-auto relative"> {/* æ·»åŠ  relative ç”¨æ–¼å®šä½è·¨æ¬„èª²ç¨‹ */}
          <h1 className="text-2xl font-bold mb-6">å‚‘ç«‹æ’èª²ç³»çµ±</h1>

          {/* Main Content - 3 Columns */}
          <div className="flex gap-4 mb-6">

            {/* Left Column - Course Management (1/5 width) */}
            <div className="w-1/5">
              {/* Course Creation Form */}
              <div className="bg-white p-4 rounded-lg border mb-4">
                <h3 className="font-semibold mb-3">æ–°å¢èª²ç¨‹</h3>
                <input
                  type="text"
                  placeholder="èª²ç¨‹åç¨±"
                  value={newCourseName}
                  onChange={(e) => setNewCourseName(e.target.value)}
                  className="border px-2 py-1 w-full mb-3"
                />

                {/* Course Duration Dropdown */}
                <div className="mb-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    èª²ç¨‹æ™‚é•·ï¼š
                  </label>
                  <select
                    value={newCourseDuration}
                    onChange={(e) => setNewCourseDuration(e.target.value)}
                    className="border px-2 py-1 w-full"
                  >
                    {courseDurations.map(option => (
                      <option key={option.value} value={option.value}>
                        {option.label}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Course Color Selection */}
                <div className="mb-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    èª²ç¨‹é¡è‰²ï¼š
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {courseColors.map((colorOption, idx) => (
                      <div 
                        key={idx}
                        onClick={() => setNewCourseColor(colorOption)}
                        className={`w-6 h-6 rounded-full cursor-pointer ${colorOption.bg} border ${colorOption.border}
                                  ${newCourseColor.bg === colorOption.bg ? 'ring-2 ring-offset-1 ring-blue-500' : ''}`}
                        title="é¸æ“‡æ­¤é¡è‰²"
                      />
                    ))}
                  </div>
                </div>

                {/* Student Input Fields */}
                <div className="flex gap-2 flex-wrap mb-2">
                  <input
                    type="text"
                    placeholder="å­¸ç”Ÿå§“å"
                    value={newStudentName}
                    onChange={(e) => setNewStudentName(e.target.value)}
                    className="border px-2 py-1 flex-1 min-w-[80px]"
                  />
                  <input
                    type="text"
                    placeholder="å­¸æ ¡"
                    value={newStudentSchool}
                    onChange={(e) => setNewStudentSchool(e.target.value)}
                    className="border px-2 py-1 flex-1 min-w-[80px]"
                  />
                  <input
                    type="text"
                    placeholder="å¹´ç´š"
                    value={newStudentGrade}
                    onChange={(e) => setNewStudentGrade(e.target.value)}
                    className="border px-2 py-1 flex-1 min-w-[80px]"
                  />
                </div>

                <button
                  onClick={addTempStudent}
                  className="bg-blue-500 text-white px-3 py-1 rounded mb-3 w-full"
                >
                  åŠ å…¥å­¸ç”Ÿ
                </button>

                {/* Temporary Student List */}
                <div className="mb-3 text-sm text-gray-700">
                  <div className="font-semibold mb-1">å·²åŠ å…¥å­¸ç”Ÿï¼š</div>
                  {tempStudents.length === 0 ? (
                    <div className="text-gray-500">(å°šç„¡å­¸ç”Ÿ)</div>
                  ) : (
                    <ul className="list-disc pl-5 max-h-20 overflow-y-auto">
                      {tempStudents.map((student, idx) => (
                        <li key={idx}>
                          {student.name}ï¼ˆ{student.school}ãƒ»{student.grade}ï¼‰
                        </li>
                      ))}
                    </ul>
                  )}
                </div>

                <button
                  onClick={createNewCourse}
                  className="bg-green-600 text-white px-3 py-1 rounded w-full"
                  disabled={!newCourseName || tempStudents.length === 0}
                >
                  æ–°å¢èª²ç¨‹
                </button>
              </div> {/* End Course Creation Form */}

              {/* Course Candidate List */}
              <div className="bg-gray-50 p-4 rounded-lg border">
                <h3 className="font-bold text-lg mb-2">èª²ç¨‹å€™é¸å€</h3>
                <p className="text-sm font-normal text-gray-500 mb-3">(æ‹–æ‹½èª²ç¨‹åˆ°æ—¥æ›†æ ¼å­ä¸Š)</p>
                {courses.length === 0 ? (
                  <div className="text-gray-500">ï¼ˆå°šç„¡èª²ç¨‹ï¼‰</div>
                ) : (
                  <div className="space-y-2">
                    {courses.map((course) => (
                      <CourseComponent
                        key={course.id}
                        course={course}
                        inCalendar={false}
                        actions={{
                          onDragStart: (e) => handleDragStart(e, course.id),
                          buttons: (
                            <>
                              <button
                                onClick={() => deleteCourse(course.id)}
                                className="text-red-500 hover:text-red-700 text-xs p-0.5"
                                title="åˆªé™¤èª²ç¨‹"
                              >
                                ğŸ—‘ï¸
                              </button>
                              <button
                                onClick={() => cloneCourse(course.id)}
                                className="text-blue-500 hover:text-blue-700 text-xs p-0.5"
                                title="è¤‡è£½èª²ç¨‹"
                              >
                                ğŸ“„
                              </button>
                              <button
                                onClick={() => startEditCourse(course)}
                                className="text-green-500 hover:text-green-700 text-xs p-0.5"
                                title="ç·¨è¼¯èª²ç¨‹"
                              >
                                âœï¸
                              </button>
                            </>
                          )
                        }}
                      />
                    ))}
                  </div>
                )}
              </div> {/* End Course Candidate List */}
            </div> {/* End Left Column */}

            {/* Middle Column - Calendar (3/5 width) */}
            <div className="w-3/5">
              <div className="bg-white rounded-lg border overflow-hidden relative"> {/* æ·»åŠ  relative ç”¨æ–¼å®šä½è·¨æ¬„èª²ç¨‹ */}
                <table className="w-full border-collapse table-fixed">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="border p-2 w-16"></th>
                      {days.map(day => (
                        <th key={day} className="border p-2">{day}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {allHours.map(hour => (
                      <tr key={hour}>
                        <td className="border p-2 bg-gray-50 text-center font-semibold text-sm h-24">
                          {hour}:00
                        </td> 
                        {days.map(day => {
                          // æª¢æŸ¥æ­¤æ™‚æ®µæ˜¯å¦åœ¨å¯ç”¨ç¯„åœå…§
                          const isHourAvailable = hourSlots[day]?.includes(hour);
                          
                          // æª¢æŸ¥æ˜¯å¦æœ‰å»¶ä¼¸åˆ°æ­¤æ ¼å­çš„èª²ç¨‹ (ä¸è¨ˆç®—é–‹å§‹æ™‚é–“)
                          const isExtendedByPrevious = calendarItems[day] && 
                            Object.entries(calendarItems[day]).some(([startHour, courses]) => {
                              const startHourNum = parseInt(startHour);
                              return courses.some(course => {
                                const endHour = startHourNum + (course.duration || 1);
                                return hour > startHourNum && hour < endHour;
                              });
                            });
                          
                          // æ˜¯å¦å…è¨±æ‹–æ”¾
                          const allowDrop = isHourAvailable && !isExtendedByPrevious;

                          return (
                           <td
                              key={`${day}-${hour}`}
                              className={`border p-1 align-top relative h-24 
                                        ${!isHourAvailable ? 'bg-gray-200' : ''} 
                                        ${isExtendedByPrevious ? 'bg-gray-100' : ''}`}
                              onDragOver={allowDrop ? handleDragOver : null}
                              onDrop={allowDrop ? (e) => handleDrop(e, day, hour) : null}
                              data-day={day}
                              data-hour={hour}
                              style={allowDrop ? { backgroundColor: 'rgba(240, 240, 250, 0.5)' } : {}}
                            >
                              {isHourAvailable && calendarItems[day]?.[hour]?.length > 0 && (
                                <TimeSlotCourseGrid
                                  day={day}
                                  hour={hour}
                                  courses={calendarItems[day][hour]}
                                  onRemoveCourse={removeCourseFromCalendar}
                                />
                              )}
                              {!isHourAvailable && <span className="text-gray-400 text-xs absolute top-1 left-1">ä¸é©ç”¨</span>}
                              {isExtendedByPrevious && <span className="text-gray-400 text-xs italic absolute top-1 left-1">å·²è¢«ä½”ç”¨</span>}
                             </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
                
                {/* æ¸²æŸ“è·¨æ¬„èª²ç¨‹ */}
                {renderExtendedCourses()}
              </div>
            </div> {/* End Middle Column */}

            {/* Right Column - Conflict Display (1/5 width) */}
            <div className="w-1/5" relative>
              <div className="sticky top-4 bg-red-50 p-4 rounded-lg border border-red-200 shadow-md">
                <h3 className="font-bold text-lg mb-3 text-red-700">è¡çªå­¸ç”Ÿé¡¯ç¤ºå€</h3>
                {conflictStudents.length === 0 ? (
                  <p className="text-gray-500">ç„¡è¡çª</p>
                ) : (
                  <ul className="list-disc pl-5 text-red-600 text-sm max-h-96 overflow-y-auto">
                    {conflictStudents.map((name, idx) => (
                      <li key={idx}>{name}</li>
                    ))}
                  </ul>
                )}
              </div>
            </div> {/* End Right Column */}

          </div> {/* End Main Content Flex */}

          {/* Export/Import Section */}
          <div className="bg-gray-50 p-4 rounded-lg border mb-6">
            <h2 className="text-lg font-bold mb-3">è³‡æ–™åŒ¯å‡º/åŒ¯å…¥</h2>
            <div className="flex flex-col md:flex-row gap-4 items-center">
              <div>
                <h3 className="font-semibold mb-1">åŒ¯å…¥è³‡æ–™ï¼š</h3>
                <input
                  type="file"
                  accept="application/json"
                  className="border px-3 py-2 rounded text-sm"
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (file) {
                      const reader = new FileReader();
                      reader.onload = (event) => {
                        try {
                          const data = JSON.parse(event.target.result);
                          if (data.courses && data.calendarItems) {
                            // ç¢ºä¿æ‰€æœ‰èª²ç¨‹éƒ½æœ‰ duration å’Œ color å±¬æ€§
                            const coursesWithProps = data.courses.map(course => ({
                              ...course,
                              duration: course.duration || 1,
                              color: course.color || courseColors[0]
                            }));
                             
                            const calendarWithProps = data.calendarItems;
                            Object.keys(calendarWithProps).forEach(day => {
                                Object.keys(calendarWithProps[day]).forEach(hour => {
                                    calendarWithProps[day][hour] = calendarWithProps[day][hour].map(c => ({
                                        ...c,
                                        duration: c.duration || 1,
                                        color: c.color || courseColors[0]
                                    }));
                                });
                            });

                            setCourses(coursesWithProps);
                            setCalendarItems(calendarWithProps);
                            alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                          } else {
                            alert('æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆåŒ…å« courses èˆ‡ calendarItemsã€‚');
                          }
                        } catch(error) {
                           console.error("Import Error:", error);
                          alert('ç„¡æ³•è§£æ JSON æª”æ¡ˆï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢ºã€‚');
                        }
                      };
                      reader.readAsText(file);
                      // Clear the input value so the same file can be loaded again
                      e.target.value = null;
                    }
                  }}
                />
              </div>
              <div>
                <button
                  onClick={handleExportData}
                  className="bg-blue-600 text-white px-4 py-2 rounded"
                >
                  ä¸‹è¼‰æ’èª²è³‡æ–™
                </button>
              </div>
            </div>
          </div> {/* End Export/Import Section */}

          {/* Course Editing Modal */}
          {editingCourse && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <h2 className="text-xl font-bold mb-4">ç·¨è¼¯èª²ç¨‹</h2>

                <div className="mb-4">
                  <label className="block text-sm font-semibold mb-1">èª²ç¨‹åç¨±ï¼š</label>
                  <input
                    type="text"
                    value={editingCourse.name}
                    onChange={(e) => setEditingCourse({ ...editingCourse, name: e.target.value })}
                    className="border w-full p-2 rounded"
                  />
                </div>

                {/* Course Duration Dropdown in Edit Modal */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold mb-1">èª²ç¨‹æ™‚é•·ï¼š</label>
                  <select
                    value={editingCourse.duration}
                    onChange={(e) => setEditingCourse({
                      ...editingCourse,
                      duration: parseFloat(e.target.value)
                    })}
                    className="border w-full p-2 rounded"
                  >
                    {courseDurations.map(option => (
                      <option key={option.value} value={option.value}>
                        {option.label}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Course Color Selection in Edit Modal */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold mb-1">èª²ç¨‹é¡è‰²ï¼š</label>
                  <div className="flex flex-wrap gap-2">
                    {courseColors.map((colorOption, idx) => (
                      <div 
                        key={idx}
                        onClick={() => setEditingCourse({...editingCourse, color: colorOption})}
                        className={`w-8 h-8 rounded cursor-pointer ${colorOption.bg} border ${colorOption.border} 
                                  ${editingCourse.color && editingCourse.color.bg === colorOption.bg ? 'ring-2 ring-offset-2 ring-blue-500' : ''}`}
                      />
                    ))}
                  </div>
                </div>

                {/* Student List in Edit Modal */}
                <div className="mb-4">
                  <h3 className="font-semibold mb-2">å­¸ç”Ÿåå–®ï¼š</h3>
                  <div className="max-h-40 overflow-y-auto mb-2 border rounded p-2">
                    {editingCourse.students.length === 0 ? (
                      <p className="text-gray-500">ï¼ˆå°šç„¡å­¸ç”Ÿï¼‰</p>
                    ) : (
                      editingCourse.students.map((student, idx) => (
                        <div key={idx} className="flex justify-between items-center p-2 bg-gray-50 mb-1 rounded">
                          <span className="text-sm">
                            {student.name}ï½œ{student.school}ï½œ{student.grade}
                          </span>
                          <button
                            onClick={() => removeStudentFromEditingCourse(idx)}
                            className="text-red-500 hover:text-red-700 text-xs"
                          >
                            åˆªé™¤
                          </button>
                        </div>
                      ))
                    )}
                  </div>

                  {/* Add Student Form in Edit Modal */}
                  <div className="border-t pt-3 mt-3">
                    <h4 className="font-semibold mb-2">æ–°å¢å­¸ç”Ÿï¼š</h4>
                    <div className="flex gap-2 flex-wrap mb-2">
                      <input
                        type="text"
                        placeholder="å§“å"
                        value={editStudentName}
                        onChange={(e) => setEditStudentName(e.target.value)}
                        className="border p-1 flex-1 min-w-[80px]"
                      />
                      <input
                        type="text"
                        placeholder="å­¸æ ¡"
                        value={editStudentSchool}
                        onChange={(e) => setEditStudentSchool(e.target.value)}
                        className="border p-1 flex-1 min-w-[80px]"
                      />
                      <input
                        type="text"
                        placeholder="å¹´ç´š"
                        value={editStudentGrade}
                        onChange={(e) => setEditStudentGrade(e.target.value)}
                        className="border p-1 flex-1 min-w-[80px]"
                      />
                    </div>
                    <button
                      onClick={addStudentToEditingCourse}
                      className="bg-blue-500 text-white px-3 py-1 rounded w-full text-sm"
                    >
                      æ–°å¢å­¸ç”Ÿåˆ°æ­¤èª²ç¨‹
                    </button>
                  </div>
                </div> {/* End Student List Section */}

                {/* Modal Action Buttons */}
                <div className="flex justify-end gap-3 mt-4">
                  <button
                    onClick={() => setEditingCourse(null)}
                    className="px-4 py-2 border rounded"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    onClick={saveEditedCourse}
                    className="px-4 py-2 bg-green-600 text-white rounded"
                  >
                    å„²å­˜è®Šæ›´
                  </button>
                </div>
              </div> {/* End Modal Content */}
            </div> /* End Modal Backdrop */
          )} {/* End Editing Modal Conditional Render */}

        </div> /* End Outer Container */
      ); // End App return
    } // End App Component

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
